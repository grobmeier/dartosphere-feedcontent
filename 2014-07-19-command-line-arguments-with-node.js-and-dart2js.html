---
title: 'Command Line Arguments with Node.js and Dart2js'
layout: post
published: '2014-07-19T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/Gl51QMi5zXw/command-line-arguments-with-nodejs-and.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - benchmarking
    - chain
    - cli
    - dart
    - dartlang
    - javascript
    - nodejs

---

<div class=top-chain-links></div><br />How on earth did it come to this? <br /><br />I need for my compiled Dart to respond to command line arguments when compiled to JavaScript and run under Node.js. I think that sentence reads as proper English.<br /><br />It all seemed so simple at first. I want to benchmark code for <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. I may use benchmarks for every pattern, I may use them for none—either way I would like the ability to quickly get benchmarks so that I can compare different approaches that I might take to patterns. So I would like to benchmark. <br /><br />So I benchmark my <a href="http://dartlang.org">Dart</a> code. I added features to command-line Dart scripts so that they can read command line switches to vary the loop size (which seems to make a difference). Then I try to compile this code to JavaScript to be run under <a href="http://nodejs.com/">node.js</a>. That <a href="http://japhr.blogspot.com/2014/06/benchmarking-dart-and-dart2js-code-in.html">actually works</a>. Except for command line options to vary the loop size. <br /><br />And so here I am. I need to figure out how to get node.js running dart2js code to accept command-line (or environment) options. <br /><br />Last night I found that the usual <code>main()</code> entry point simply does not see command line arguments when compiled via <code>dart2js</code> and run with node. The <code>print()</code> of the command line args is an empty List even when options are supplied:<pre class=prettyprint>main (List&lt;String> args) {<br />  <b>print(args);</b><br />  // ...<br />}</pre>With the Dart VM, I see command line options:<pre class=prettyprint>$ dart ./tool/benchmark.dart --loop-size=666<br />[--loop-size=666]</pre>And, with the very nice <code>args</code> package, I can even process them to useful things. But when run with node.js, I only get a blank list:<pre class=prettyprint>$ node ./tool/benchmark.dart.js --loop-size=666<br />[]</pre>I had thought to use some of the process environment options, but they are all part of the <code>dart:io</code> package which is unsupported by <code>dart2js</code>. Even initializing a string from the environment does not work:<pre class=prettyprint>const String LOOP_SIZE = const String.fromEnvironment("LOOP_SIZE", defaultValue: "10");</pre>No matter how I tried to set that environment variable, my compiled JavaScript would only use the default value.<br /><br />So am I stuck? <br /><br />The answer turns out to be embedded in the output of <code>dart2js</code> code. At the very top of the file are a couple of hints including:<pre class=prettyprint>// dartMainRunner(main, args):<br />//    if this function is defined, the Dart [main] method will not be invoked<br />//    directly. Instead, a closure that will invoke [main], and its arguments<br />//    [args] is passed to [dartMainRunner].</pre>It turns out that I can use this <code>dartMainRunner()</code> function to grab command line arguments the node.js way so that they can be supplied to the compiled Dart. In fact, I need almost no code to do it:<pre class=prettyprint>function dartMainRunner(main, args) {<br />  main(process.argv.slice(2)); <br />}</pre>I slice off the first two command line arguments, supplying the <code>main()</code> callback with the rest. In the case of my node.js code, the first two arguments are the node executable and the script name:<pre class=prettyprint>$ node ./tool/benchmark.dart.js --loop-size=666</pre>With those chomped off, I am only supplying the remainder of the command line arguments—the switches that control how my benchmarks will run.<br /><br />This is a bit of a hassle in my Dart benchmarks since I will need to add that wrapper code to each implementation every time that I make a change. I probably ought to put all of this into a Makefile (or equivalent). For now, however, I simply make it part of my benchmarking shell script:<pre class=prettyprint>#...<br /># Compile<br /><b>wrapper='function dartMainRunner(main, args) { main(process.argv.slice(2)); }';</b><br />dart2js -o tool/benchmark.dart.js \<br />           tool/benchmark.dart<br /><b>echo $wrapper >> tool/benchmark.dart.js</b><br /><br /># More compiling then actual benchmarks ...</pre>And that works!<br /><br />Thanks to my already in place gnuplot graphing solution, I can even plot my three implementations of the Visitor Pattern compiled from Dart into JavaScript. The number of microseconds it takes a single run relative to the number of loops winds up looking like this:<br /><br /><a href="http://2.bp.blogspot.com/-h05Jb4SuWu8/U8s_5wwctrI/AAAAAAAAdWI/2OwkWKVMIlk/s1600/benchmark_summary.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-h05Jb4SuWu8/U8s_5wwctrI/AAAAAAAAdWI/2OwkWKVMIlk/s400/benchmark_summary.png" /></a><br /><br />That is a little different than last night's Dart numbers, but the bottom line seems to be that it does not matter <i>too</i> much which implementation I choose. At least for this pattern. Regardless, I am grateful to be able to get these numbers quickly now—even from node.js.<br /><br /><br /><span style="color: #ccc">Day #127</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/07/close-but-not-quite-visualizing-dart2js.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/07/reading-files-from-stdin-in-dart.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/Gl51QMi5zXw" height="1" width="1"/>
