---
title: 'Speed Up Your Dart App''s Initial Load With This Transformer'
layout: post
published: '2014-04-28T21:42:00-07:00'
feed: 'Seth Ladd''s Blog'
link: 'http://feedproxy.google.com/~r/SethLaddsBlog/~3/TLKAj2hJnYo/speed-up-your-dart-apps-initial-load.html'
author:
    name: 'Seth Ladd'
    email: noreply@blogger.com
    url: 'https://plus.google.com/118397406534237711570'
tags:
    - dart
    - dartlang

---

<div style="text-align: center;">I just saved potentially <i>hundreds of blocking&nbsp;milliseconds</i> from my Dart app's initial loads.</div><div style="text-align: center;">By moving script tags, and using my new pub transformer, you can help your users, too.<br /><br /><div class="separator" style="clear: both; text-align: center;"><img border="0" src="http://3.bp.blogspot.com/-y4YjZIr0wQI/U2CeImoj3cI/AAAAAAABbsM/IMdMQSlE5eU/s1600/pm_web.jpg" height="229" width="640" /></div><br /></div><h2>Where does the time go?</h2>First, some background:<br /><br />Typical Dart applications are designed to work in Dart VM and modern JavaScript. A small file, named <i>dart.js</i>, is loaded by the HTML file and checks to see what runtime is available. If the Dart VM is available, the Dart code is run. Otherwise, the dart.js file swaps out the Dart script for its equivalent JavaScript file compiled from the original Dart code.<br /><br />Dart Editor can generate skeleton applications, complete with starter HTML, CSS, and Dart files. It's really handy for getting started quickly. As of today, the default starter HTML code looks something like this:<br /><br /><span style="font-family: Courier New, Courier, monospace;">&lt;!DOCTYPE html&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&lt;html&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;head&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;meta charset="utf-8"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;&nbsp;&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;title&gt;Hugs all around&lt;/title&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;link rel="stylesheet" href="styles.css"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;/head&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;body&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; .......</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;!-- not a good practice, do not copy --&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;script type="application/dart" src="hugs.dart"&gt;&lt;/script&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;script data-pub-inline="packages/browser/dart.js"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;/body&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&lt;/html&gt;</span><br /><br />Some browsers delay script execution until CSS resources are downloaded (unless the script tags are before the CSS file). This means that the&nbsp;<i>dart.js</i>&nbsp;file isn't executed until the CSS file in the &lt;head&gt; is downloaded. This is an unnecessary delay in app startup.<br /><br /><h3 style="text-align: center;"><i>Location and order matters for scripts and CSS resources. Default projects from Dart Editor can be optimized.</i></h3><br />For the above HTML file, the browser's workflow looks something like this:<br /><ol><li>The main HTML loads, with links to CSS, dart.js, and the Dart application.</li><li>The browser downloads the dart.js file and the CSS file, more or less concurrently.</li><li><b>The CSS file must finish downloading until the dart.js script is executed.</b></li><li>dart.js checks to see if Dart VM is available. It's probably not.</li><li>dart.js looks for the Dart application script tag.</li><li>dart.js replaces the script tag with another script tag that points to the Dart app compiled to JavaScript.</li><li>The browser then, finally, downloads the actual application.</li></ol><div>See this output from DevTools for an illustration:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-gHWEa6vaROQ/U2CaOmGLQyI/AAAAAAABbsA/_fj940s29UA/s1600/Pub_transformer_test.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-gHWEa6vaROQ/U2CaOmGLQyI/AAAAAAABbsA/_fj940s29UA/s1600/Pub_transformer_test.png" height="226" width="640" /></a></div><br /><br /></div><div>For my simple app, hosted on the public internet, the app loaded in approximately 1.29 seconds. There are two root causes: the unnecessary download of dart.js, and the blocked execution of dart.js.<br /><br /><h3 style="text-align: center;"><i>The app was <b>blocked for 300ms</b>.&nbsp;</i></h3></div><h2>Saving time</h2><div>I wanted the functionality of dart.js without the extra delay in startup. The solution was to move the script tags, and inline dart.js.<br /><br />Step one, move the script tags into the &lt;head&gt; tag, before the CSS resource.<br /><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;head&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;meta charset="utf-8"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;&nbsp;&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;title&gt;Hugs&lt;/title&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;script async type="application/dart" src="hugs.dart"&gt;&lt;/script&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;script async data-pub-inline src="packages/browser/dart.js"&gt;&lt;/script&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;link rel="stylesheet" href="styles.css"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;/head&gt;</span><br /><br />Dart apps don't begin until after DOMContentLoaded, so it's safe to start downloading the app as soon as possible (as long as the script tag is marked as <i>async</i>).<br /><br />Step two, add an <i>async</i>&nbsp;attribute to the script tags. This attribute tells the browser <i>not</i>&nbsp;to block page parsing while the script is downloading and executing.<br /><br />Step three:&nbsp;<a href="https://www.dartlang.org/tools/pub/transformers/index.html">write a <i>pub transformer</i></a>&nbsp;to rewrite the HTML, and inline the contents of dart.js. Therefor, <a href="http://pub.dartlang.org/packages/script_inliner">script_inliner</a>, my new pub package and transformer, was born!</div><div><br /></div><div>To install the transformer, add it to your pubspec.yaml dependencies:</div><br /><div><span style="font-family: Courier New, Courier, monospace;">dependencies:</span></div><div><span style="font-family: Courier New, Courier, monospace;">&nbsp; script_inliner: "&gt;=0.0.1 &lt;0.1.0"</span></div><div><br /></div><div>Then, add script_inliner to the list of transformers in your pubspec.yaml:</div><div><br /></div><div><div><span style="font-family: Courier New, Courier, monospace;">transformers:</span></div><div><span style="font-family: Courier New, Courier, monospace;">- script_inliner</span></div></div><div><br /></div><div>Then, add a <i>data-pub-inline</i> attribute to script tags that should be inlined. For example:</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;">&lt;script data-pub-inline src="packages/browser/dart.js"&gt;&lt;/script&gt;</span></div><div><br /></div><div>When you run <i>pub build</i>&nbsp;or <i>pub serve</i>, the transformer kicks in and inlines the script.</div><h2>The results</h2><div>Here's the same app, with the contents of dart.js inlined:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-J6XOasYFb_g/U18sKQHn7GI/AAAAAAABblk/3Hw9wojf4ig/s1600/Pub_transformer_test+3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-J6XOasYFb_g/U18sKQHn7GI/AAAAAAABblk/3Hw9wojf4ig/s1600/Pub_transformer_test+3.png" height="142" width="640" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"></div><br /></div><div>Notice how the browser no longer requests dart.js (because the contents were inlined), and the browser downloads the app's script file as soon as any other external resource. After numerous reloads (and clearing the cache), the approximate average time was 916ms.<br /><br /><h3 style="text-align: center;"><i>Inlining dart.js, and moving the script tags, resulted in over 25% faster load times.</i></h3><br />Please move your script tags and try the <a href="http://pub.dartlang.org/packages/script_inliner">script_inliner transformer</a> and let me know if it works for you.<br /><br />For the curious, here's what the HTML now looks like:<br /><br /><span style="font-family: Courier New, Courier, monospace;">&lt;!DOCTYPE html&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&lt;html&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;head&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;meta charset="utf-8"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp;&nbsp;&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;title&gt;Hugs&lt;/title&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;script async type="application/dart" src="pub_transformer_test.dart"&gt;&lt;/script&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;script data-pub-inline="packages/browser/dart.js"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">(function() {</span><br /><span style="font-family: Courier New, Courier, monospace;">if (navigator.userAgent.indexOf('(Dart)') === -1) {</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; var scripts = document.getElementsByTagName("script");</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; var length = scripts.length;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; for (var i = 0; i &lt; length; ++i) {</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; if (scripts[i].type == "application/dart") {</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; if (scripts[i].src &amp;&amp; scripts[i].src != '') {</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; var script = document.createElement('script');</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; script.async = true;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; script.src = scripts[i].src.replace(/\.dart(?=\?|$)/, '.dart.js');</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; var parent = scripts[i].parentNode;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; document.currentScript = script;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; &nbsp; parent.replaceChild(script, scripts[i]);</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; }</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; }</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; }</span><br /><span style="font-family: Courier New, Courier, monospace;">}</span><br /><span style="font-family: Courier New, Courier, monospace;">})();</span><br /><span style="font-family: Courier New, Courier, monospace;">&lt;/script&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;"><br /></span><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &lt;link rel="stylesheet" href="style.css"&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; &lt;/head&gt;</span><br /><span style="font-family: Courier New, Courier, monospace;">&nbsp; ......</span><br /><br />(Fine print: tests from my home machine, over wifi, hitting static files served by Dropbox. Also note: I've barely tested this transformer, and I haven't tried it with too many different scripts. YMMV.)<br /><br /><h2>Measure and optimize</h2><br />Use the performance rules that you've learned as a guide, but always use the tools to measure and verify. Performance is a feature, and has direct correlation to customer satisfaction and conversions. Time spent on faster app loads is time well spent.<br /><br /><br /><span style="font-size: x-small;">(Banner from http://www.ayoungertheatre.com/wp-content/uploads/2011/11/pm_web.jpg)</span></div><img src="http://feeds.feedburner.com/~r/SethLaddsBlog/~4/TLKAj2hJnYo" height="1" width="1"/>
