---
title: 'When to TDD and When Not to TDD (an exercise with Polymer.dart)'
layout: post
published: '2014-08-27T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/nYwO0PQ1Nwg/when-to-tdd-and-when-not-to-tdd.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />According to <a href="http://japhr.blogspot.com/2014/08/git-subcommand-to-sort-by-last-modified.html">git lslt</a>, it has been six months since I last updated the parent events chapter in <a href="http://patternsinpolymer.com/">Patterns in Polymer</a>. <i>Six months!</i> <br /><br />I start my review, as always, with my tests:<pre class=prettyprint>$ pwd     <br />/home/chris/repos/polymer-book/book/code-dart/parent_events<br />$ ls -l test<br />total 0<br />lrwxrwxrwx 1 chris chris 11 Dec  7  2013 packages -> ../packages</pre>Son of a… Bad developer! Bad author!<br /><br />I will not produce another edition without complete test coverage of the examples in the book. I will not worry about the code in the “play” area of the repository—that is mostly meant for spiking new features or exploring new facets of Polymer. But there is no excuse for basing any programming book on top of code without tests. So, I start with…<br /><br />Running the application. It's silly to start testing without <i>some</i> idea of what things look like, so I double-check that this still runs. I will worry about the tests after the fact (not everything in life requires TDD). First, I clean out the <code>pubspec.yaml</code> dependencies of some early-Polymer cruft, leaving me with simply:<pre class=prettyprint>name: parent_events<br />dependencies:<br />  polymer: any<br />dev_dependencies:<br />  scheduled_test: any</pre>I <code>pub upgrade</code> and find:<pre class=prettyprint>$ pub upgrade<br />Resolving dependencies... (4.4s)<br />...<br />> polymer 0.12.0 (was 0.9.0+1) (8 newer versions available)<br />...<br />Changed 29 dependencies!</pre>Craziness. I cannot believe that I still have Polymer.dart 0.9 code the book (the 8 newer versions are pre-releases).<br /><br />I also update the smoke test page in the <a href="http://pub.dartlang.org/">Dart Pub</a> standard <code>web</code> directory to perform the proper setup:<pre class=prettyprint>&lt;!doctype html><br />&lt;html lang="en"><br />  &lt;head><br />  &lt;!-- ... --><br /><b>    &lt;!-- Load platform polyfills --><br />    &lt;script src="packages/web_components/platform.js">&lt;/script><br />    &lt;script src="packages/web_components/dart_support.js">&lt;/script><br /><br />    &lt;!-- Load component(s) --><br />    &lt;link rel="import" href="packages/parent_events/click-sink.html"><br /><br />    &lt;!-- Start Polymer --><br />    &lt;script type="application/dart"><br />      export 'package:polymer/init.dart';<br />    &lt;/script></b><br />  &lt;/head><br />  &lt;!-- ... --><br />&lt;/html></pre>That <i>should</i> do it. So I fire up Dart pub's built-in test web server (<code>pub serve</code>), access the page, click around, and… nothing:<br /><br /><a href="http://4.bp.blogspot.com/-x9E1Y7M85oU/U_6hQBaP_SI/AAAAAAAAe1M/VYRvDDX0nHQ/s1600/01-no_clicks.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-x9E1Y7M85oU/U_6hQBaP_SI/AAAAAAAAe1M/VYRvDDX0nHQ/s400/01-no_clicks.png" /></a><br /><br />If I recall correctly, the <code>&lt;click-sink></code> element added to the page should listen for page events. With another 6 months of Polymer under my belt, I am no longer sure this is a strong pattern, but I would at least like to get it working.<br /><br />Saaaaaay... this is a good time to introduce some tests! In the pub standard <code>test</code> directory, I add the text page context:<pre class=prettyprint>&lt;!doctype html><br />&lt;html><br />&lt;head><br />  &lt;!-- Load platforms polyfills --><br />  &lt;script src="packages/web_components/platform.js">&lt;/script><br /><br />  &lt;!-- Load component(s) --><br />  &lt;link rel="import" href="packages/parent_events/click-sink.html"><br /><br />  &lt;!-- The actual tests --><br />  &lt;script type="application/dart" src="test.dart">&lt;/script><br />  &lt;script src="packages/unittest/test_controller.js">&lt;/script><br />&lt;/head><br />&lt;body><br />  &lt;click-sink>&lt;/click-sink><br />&lt;/body><br />&lt;/html></pre>That is similar to the regular <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> page, but to initialize and test Polymer elements, I have found this to be an effective approach. I normally create the Polymer element inside my test setup, but I anticipate these tests to be simple enough that I add <code>&lt;click-sink></code> directly to the page. I can always change later if the need arises.<br /><br />In addition to the test page context, I also need to initialize Polymer inside my tests:<pre class=prettyprint>library click_sink_test;<br /><br />import 'package:polymer/polymer.dart';<br />import 'package:scheduled_test/scheduled_test.dart';<br /><br />main() {<br />  initPolymer();<br /><br />  setUp((){<br />    schedule(()=> Polymer.onReady);<br />  });<br /><br />  test('displays click events', (){<br />    expect(false, true);<br />  });<br />  test('generates click-sink-click events', (){<br />    expect(false, true);<br />  });<br />}</pre>And look! I have two failing tests already in place. I could access my tests from the pub web server (which spins up a test server as well), but I prefer testing with <code>content_shell</code> for ease of transition to continuous integration testing. The arguments are arcane, but as I avowed Linux user, I am used to it:<pre class=prettyprint>$ content_shell --dump-render-tree test/index.html<br />CONSOLE WARNING: line 12: flushing %s elements<br />CONSOLE MESSAGE: unittest-suite-wait-for-done<br />CONSOLE MESSAGE: FAIL: displays click events<br />  Caught ScheduleError:<br />  | Expected: &lt;true><br />  |   Actual: &lt;false><br /><br />CONSOLE MESSAGE: FAIL: generates click-sink-click events<br />  Caught ScheduleError:<br />  | Expected: &lt;true><br />  |   Actual: &lt;false><br /><br />CONSOLE MESSAGE:<br />CONSOLE MESSAGE: 0 PASSED, 2 FAILED, 0 ERRORS</pre>My first step is right out the TDD playbook: change the (error) message. To do so, I write an actual test:<pre class=prettyprint><code>  test('displays click events', (){<br />    var el = query('click-sink');<br />    schedule(()=> document.body.click());<br />    schedule(() {<br />      expect(el.shadowRoot.text, contains('Page clicked'));<br />    });<br />  });</code></pre>When I click the document body, I expect that the <code>&lt;click-sink></code> Polymer element will contain a text message that includes the coordinates of the click. Running this test, I find that the message has indeed changed:<pre class=prettyprint>CONSOLE MESSAGE: FAIL: displays click events<br />  Caught ScheduleError:<br />  | Expected: contains 'Page clicked'<br />  |   Actual: '\n'<br />  |   '    \n'<br />  |   '      Click Anywhere on the Page\n'<br />  |   '      \n'<br />  |   '        \n'<br />  |   '      \n'<br />  |   '    \n'<br />  |   '  '</pre>Now, why on earth is this failing?<br /><br />It turns out that I am using old syntax for the Polymer attached life cycle method (that tends to happen with a 6+ month old dependency on an alpha state library):<pre class=prettyprint>@CustomTag('click-sink')<br />class ClickSinkElement extends PolymerElement {<br />  // ...<br />  ClickSinkElement.created(): super.created();<br /><b>  enteredView() {<br />    super.enteredView();<br />    // ...<br />  }</b><br />}</pre>Both Polymer.dart and JavaScript Polymer have long since standardized on the <code>attached()</code> callback method (called when the Polymer instance is attached to the container document). So the fix is simple enough:<pre class=prettyprint>@CustomTag('click-sink')<br />class ClickSinkElement extends PolymerElement {<br />  // ...<br />  ClickSinkElement.created(): super.created();<br /><b>  attached() {<br />    super.attached();<br />    // ...<br />  }</b><br />}</pre>And, just like that, I have my element working and a legitimate test to ensure that something like this never happens again:<pre class=prettyprint>CONSOLE MESSAGE: PASS: displays click events</pre>I remain quite disappointed in myself for not having done this already. Hopefully this is a case of better (severely) late than never.<br /><br /><br /><span style="color: #ccc">Day #165</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/08/git-subcommand-to-sort-by-last-modified.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/nYwO0PQ1Nwg" height="1" width="1"/>
