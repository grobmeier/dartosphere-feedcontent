---
title: 'Declaring and Immediately Invoking a Recursive Function in Dart'
layout: post
published: '2014-07-30T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/oiXTdEIkJYI/declaring-and-immediately-invoking.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - functional
    - 'reactor pattern'

---

<div class=top-chain-links></div><br />While performing some minor refactoring on <a href="http://designpatternsindart.com/">Design Patterns in Dart</a> code (<a href="https://github.com/eee-c/design-patterns-in-dart">public repo</a>), I ran across an interesting problem. What is the cleanest way to define a recursive function <i>and</i> immediately call it? <br /><br />I am nearing the end of preliminary research for the book so I am cleaning code up as much as possible for future me. One of the snippets that I lingered on was the loop in the <a href="http://en.wikipedia.org/wiki/Reactor_pattern">Reactor Pattern</a> code:<pre class=prettyprint><code>  // Reactor “loop” (handleEvent is recursive)<br />  new InitiationDispatcher().handleEvents();</code></pre>I can't just make this into a <code>for</code> loop because the loop would <a href="http://japhr.blogspot.com/2014/07/isolated-reactors-in-dart.html">always run in the current event frame</a>—never allowing other code to send data into the loop nor allowing the event loop to perform asynchronous actions. So a recursive function seemed the next best idea. Each new call to the function would place it next on <a href="https://www.dartlang.org/articles/event-loop/">Dart's event loop</a>, first allowing any other tasks on the queue to execute.<br /><br />It seems perfect… except from a clean code standpoint. Why include the comment about the recursive function/method when I can put the actual code right there? As a bonus, this would better follow the code from the original Reactor Pattern <a href="http://www.dre.vanderbilt.edu/~schmidt/PDF/reactor-siemens.pdf">paper</a>.<br /><br />This leads to the question that I started with: how do I define a recursive function in Dart and immediately call it? In JavaScript, the following will work:<pre class=prettyprint>(function foo() { setTimeout(foo, 1000); console.log('foo!'); })()</pre>The outer parentheses encapsulate a function, which I immediately invoke with the call operator at the end of that line—the open/close parentheses. Inside the parentheses, I declare the function <code>foo()</code> and invoke it inside a <code>setTimeout</code>. Strictly speaking the <code>setTimeout()</code> is not necessary, but without it I would consume a heck of a lot of my computer's CPU to print out the word “foo” at the end of the function.<br /><br />But if I try the same thing in Dart:<pre class=prettyprint>import 'dart:async';<br /><br />final timeout = const Duration(milliseconds: 10);<br />main() {<br />  (<br />    foo(){<br />      new Timer(timeout, foo);<br />      print('foo!');<br />    }<br />  )();<br />}</pre>Then I get an invalid syntax error:<pre class=prettyprint>'file:///home/chris/repos/design-patterns-in-dart/reactor/bin/reactor.dart': error: line 6 pos 10: ')' expected<br />    foo(){<br />         ^</pre>It seems that Dart does not consider a function declaration an object that can be grouped by parenthesis.<br /><br />Similarly, it does not work to simply place the parentheses after the closing curly brace:<pre class=prettyprint><code>  foo(){<br />    new Timer(timeout, foo);<br />    print('foo!');<br /><b>  }();</b></code></pre>This results in another syntax error:<pre class=prettyprint>'file:///home/chris/repos/design-patterns-in-dart/reactor/bin/reactor.dart': error: line 8 pos 5: unexpected token ')'<br />  }();<br />    ^</pre>What is interesting about the error with this approach is that it <i>will</i> work if the function is anonymous:<pre class=prettyprint><code>  (){<br />    new Timer(timeout, foo);<br />    print('foo!');<br />  }();</code></pre>Well, “work” might not be the right term here. Not fail at the same place would be more apt. This does call the anonymous function right away, but I have not assigned <code>foo</code>, so I wind up with an error trying to invoke it in the Timer:<pre class=prettyprint>./bin/reactor.dart<br />foo!<br />Unhandled exception:<br />The null object does not have a method 'call'.<br /><br />NoSuchMethodError: method not found: 'call'<br />Receiver: null<br />Arguments: []<br />#0      Object.noSuchMethod (dart:core-patch/object_patch.dart:45)<br />#1      _createTimer.<&lt;anonymous closure> (dart:async-patch/timer_patch.dart:9)<br /></pre>If I try to assign a variable <code>foo</code> to the anonymous function and then call it right away:<pre class=prettyprint>var foo=(){<br />    new Timer(timeout, foo);<br />    print('foo!');<br />  }();</code></pre>Gives me yet another error. This time, I cannot use a variable in the function definition when I am declaring that same variable:<pre class=prettyprint>'file:///home/chris/repos/design-patterns-in-dart/reactor/bin/reactor.dart': error: line 8 pos 7: initializer of 'foo' may not refer to itself<br />  var foo=(){<br />      ^</pre>So, despite my efforts, the best solution that I can devise is to declare the variable elsewhere:<pre class=prettyprint>var foo;<br />final timeout = const Duration(milliseconds: 10);<br />main() {<br />  (foo=(){<br />    new Timer(timeout, foo);<br />    print('foo!');<br />  })();<br />}</pre>Which is pretty ugly. It is so ugly that I might just stick with a plain old function declaration coupled with a separate call:<pre class=prettyprint><code>  foo(){<br />    new Timer(timeout, foo);<br />    print('foo!');<br />  }<br />  foo();</code></pre>In just about all cases, I prefer Dart syntax to JavaScript. But I think I finally found one in which JavaScript has Dart beat.<br /><br /><br /><span style="color: #ccc">Day #138</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/07/minimum-viable-reactor-pattern-in.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/oiXTdEIkJYI" height="1" width="1"/>
