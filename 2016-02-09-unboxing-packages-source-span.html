---
title: 'Unboxing Packages: source_span'
layout: post
published: '2016-02-09T11:21:00-08:00'
feed: 'Dart News & Updates'
link: 'http://news.dartlang.org/2016/02/one-of-best-aspects-of-package.html'
author:
    name: 'Natalie Weizenbaum'
    email: noreply@blogger.com
    url: 'http://www.blogger.com/profile/17561686962317321958'
tags:
    - 'Unboxing Packages'

---

<p>One of the best aspects of a package ecosystem is its ability to foster language-wide conventions without direct involvement from the SDK. Packages work together and build on one another to create something more than any of them could be on their own. The glue that holds this structure together is made of little packages that establish these conventions, that provide a shared language for the ecosystem as a whole to use.</p> <p>One of these glue packages that I find most useful is <a href="https://pub.dartlang.org/packages/source_span"><code>source_span</code></a>. This package began its life as part of the more specialized <a href="https://pub.dartlang.org/packages/source_maps"><code>source_maps</code></a> package, it quickly became clear that the idea of referring to chunks of code was much more broadly applicable. I factored it out, tweaked the API to make it more general, and over time added a few additional features. The result is the package I’ll talk about today.</p> <p>The basic idea underlying <code>source_span</code> is that there should be a straightforward and consistent way for packages to refer to spans of text. This is useful for associating spans within a source map, but it’s also useful for emitting nice errors when parsing text. The <a href="https://pub.dartlang.org/packages/den"><code>den</code></a> package uses them to edit YAML without disrupting the existing formatting.</p> <p>The structure of the <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpan-class.html"><code>SourceSpan</code></a> class is very straightforward. Here are the most important parts:</p>   <pre class="prettyprint prettyprinted"><code class="language-dart"><span class="kwd">class</span><span class="pln"> </span><span class="typ">SourceSpan</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  </span><span class="typ">Uri</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> sourceUrl</span><span class="pun">;</span><span class="pln"><br />  </span><span class="typ">SourceLocation</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> start</span><span class="pun">;</span><span class="pln"><br />  </span><span class="typ">SourceLocation</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> </span><span class="kwd">end</span><span class="pun">;</span><span class="pln"><br />  </span><span class="typ">String</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> text</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">}</span><span class="pln"><br /><br /></span><span class="kwd">class</span><span class="pln"> </span><span class="typ">SourceLocation</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  </span><span class="typ">Uri</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> sourceUrl</span><span class="pun">;</span><span class="pln"><br />  </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> offset</span><span class="pun">;</span><span class="pln"><br />  </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> line</span><span class="pun">;</span><span class="pln"><br />  </span><span class="kwd">int</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> column</span><span class="pun">;</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p>A span knows where it starts, where it ends, and what text it covers; a location knows its offset in the text, as well as its line and column numbers (all of which are zero-based). Both of them know the URL of the file they refer to. That’s the heart of the package. Now you know. Article over. Good job, Natalie!</p>   <h2 id="just-kidding">Just Kidding</h2> <p>Okay, there’s more to it than that. For starters, there are some handy methods on those classes. <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpan/length.html"><code>SourceSpan.length</code></a>, for example, tells you how long a span is so you don’t have to do the math (or call <code>.text.length</code>) manually. <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceLocation/distance.html"><code>SourceLocation.distance()</code></a> tells you the number of characters between two locations. And both classes are <a href="https://api.dartlang.org/latest/dart-core/Comparable-class.html"><code>Comparable</code></a>—locations are ordered by their offsets, and spans are ordered by their start locations.</p> <p>But my favorite method is <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpan/message.html"><code>SourceSpan.message()</code></a>. This formats a message so that it’s clearly associated with the given span. It sounds simple, but it’s a big part of what makes the package so nice to use, since it provides such a nice user experience for so little effort. Here’s an example of what it looks like:</p>   <pre class="prettyprint prettyprinted"><code>Error on line 24, column 15 of pubspec.yaml:<br />Invalid version constraint: Expected version number after "^" in "^1.2.".<br />  pub_semver: <span style="color: red">"^1.2."</span><br />              <span style="color: red">^^^^^^^</span></code></pre> <p>Dart users might recognize this particular error, because it comes from <a href="https://www.dartlang.org/tools/pub/">pub</a>, which was one of the first users of the <code>source_span</code> package. Here’s how that error was produced:</p>   <pre class="prettyprint prettyprinted"><code class="language-dart"><span class="pln">stderr</span><span class="pun">.</span><span class="pln">writeln</span><span class="pun">(</span><span class="str">"Error on ${span.message(error.message, color: true)}"</span><span class="pun">);</span></code></pre> <p>That’s all you need for beautiful messaging. They can be about errors or anything else associated with a particular span of a file.</p>   <h2 id="creating-spans">Creating Spans</h2> <p>If you want, you can construct spans and locations by calling <code>new SourceSpan()</code> and <code>new SourceLocation()</code>, but when you’re parsing a bunch of text in a single file, that’s a lot of work (and memory-inefficient to boot). You’re much better off using a <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile-class.html"><code>SourceFile</code></a> to create them. You can create one by passing in the file text and URL to <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/SourceFile.html"><code>new SourceFile()</code></a>.</p> <p>A <code>SourceFile</code> represents a single source file, and spits out spans and locations for that file. <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/span.html"><code>SourceFile.span()</code></a> gets you a span for a chunk of text, and <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/location.html"><code>SourceFile.location()</code></a> gets you a location at a specific offset. You can also get assorted metadata about parts of the file without creating extra objects by calling <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/getLine.html"><code>SourceFile.getLine()</code></a>, <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/getColumn.html"><code>SourceFile.getColumn()</code></a>, <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/getOffset.html"><code>SourceFile.getOffset()</code></a>, and <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceFile/getText.html"><code>SourceFile.getText()</code></a>.</p>   <h3 id="implementation-and-efficiency">Implementation and Efficiency</h3> <p>A <code>SourceFile</code> does more than just fill in the blanks for the normal span and location constructors. Because it has access to the entire file, it’s able to do some clever tricks to make the spans more efficient, especially in terms of memory. And when you’re parsing a large file and creating a span for every node, memory usage can matter a lot.</p> <p>First of all, a <code>SourceFile</code>’s spans don’t actually store <code>SourceLocation</code> objects. Instead, they store the start and end offsets as integers and create <code>SourceLocation</code>s on the fly when the corresponding getters are called.</p> <p>The locations’ line and column information is also determined on the fly. <code>SourceFile</code> keeps an internal list of the offsets for each newline character in the file, which is quite compact. But it also means that looking up the line or column for an offset requires a binary search, which is <a href="https://en.wikipedia.org/wiki/Big_O_notation">O(log(n))</a>—not slow, but not super fast either. There’s some caching which mitigates this when looking up multiple nearby offsets, but it’s still important to keep the worst case in mind.</p> <p>As a user, this all means that you should be careful when looking up spans’ locations, and especially when accessing those locations’ line and column numbers, in code that needs to be high-performance. You don’t need to avoid these calls entirely, but make sure you aren’t calling them dozens of times in a core loop.</p>   <h3 id="sourcespanwithcontext"><code>SourceSpanWithContext</code></h3> <p>I admit it: I cheated a little bit when I was talking about <code>SourceSpan.message()</code> earlier. The error message I gave as an example contained extra text from the pubspec—the text “<code>pub_semver:</code>” wasn’t covered by the span, and thus a plain <code>SourceSpan</code> wouldn’t know to print it. It would have printed a less-useful message that just included <code>"^1.2."</code>.</p> <p>However, often spans do have that extra context, and when they do it makes for a much better message. That’s what <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpanWithContext-class.html"><code>SourceSpanWithContext</code></a> is for. It’s a <code>SourceSpan</code> with one extra field: <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpanWithContext/context.html"><code>SourceSpanWithContext.context</code></a>, which returns the full line containing the span’s text. This is enough  to produce the extra-helpful message I included above.</p>   <h3 id="filespan"><code>FileSpan</code></h3> <p>Because a <code>SourceFile</code> always has access to extra context information, all the spans it produces are <code>SourceSpanWithContext</code>s. But more than that, they’re <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/FileSpan-class.html"><code>FileSpan</code></a>s. This is a special kind of span that’s only generated by a <code>SourceFile</code>, and in fact has <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/FileSpan/file.html">a getter for the original file</a>. It also has a few superpowers of its own.</p> <p>All spans have a <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpanMixin/union.html"><code>SourceSpan.union()</code></a>, which combines two spans into one. However, it requires the spans to be adjacent or overlapping; otherwise, there would be no way to determine the text of the resulting span.</p> <p>But that’s no problem for <code>FileSpan</code>s, because they know the full contents of the file. So they support <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/FileSpan/expand.html"><code>FileSpan.expand()</code></a> as well, which only takes another span from the same file and returns a new span that covers the entire distance between them. This is really useful when constructing spans for use in a source map.</p>   <h2 id="span-exceptions">Span Exceptions</h2> <p>One of the most important uses of spans is to indicate to the end user where an error was discovered, so it makes sense that there would be a standard way to attach them to exceptions. The <code>source_span</code> package provides two different exception types: <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpanException-class.html"><code>SourceSpanException</code></a> represents a general exception that has a span attached, and <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpanFormatException-class.html"><code>SourceSpanFormatException</code></a> also implements <a href="https://api.dartlang.org/1.14.1/dart-core/FormatException-class.html"><code>FormatException</code></a> since so much code that uses spans deals with parsing as well.</p> <p>These exceptions’ APIs are pretty simple. They <a href="https://www.dartdocs.org/documentation/source_span/1.2.1/source_span/SourceSpanException/span.html">provide access to the span</a>, of course, and their <code>toString()</code> methods use <code>SourceSpan.message()</code> to format the error message. You can even pass in a <code>color</code> parameter to print it with nice terminal colors on Linux and OS X.</p> <p>Despite their simplicity, though, the exception classes are powerful because they allow unrelated packages to work together. Any package can throw <code>SourceSpanException</code>s as a matter of course, and any package can catch them and format them nicely.</p>   <h2 id="the-spannotation-pattern">The Spannotation Pattern</h2> <p>“Spannotation” is less of a well-known design pattern than something I named just now as I wrote this, but that doesn’t make it any less useful when dealing with parsed data. The idea is very straightforward: as you parse text into higher-level data structures, keep a span along to remind you of where the data came from.</p> <p>As an example, let’s look at pub. It initially parses a pubspec into a class that stores the original fields as a <code>YamlMap</code>, which has spans attached to every node it contains:</p>   <pre class="prettyprint prettyprinted"><code class="language-dart"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Pubspec</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">YamlMap</span><span class="pln"> fields</span><span class="pun">;</span><span class="pln"><br /><br />  </span><span class="typ">Pubspec</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> contents</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln">sourceUrl</span><span class="pun">})</span><span class="pln"><br />      </span><span class="pun">:</span><span class="pln"> fields </span><span class="pun">=</span><span class="pln"> loadYamlNode</span><span class="pun">(</span><span class="pln">contents</span><span class="pun">,</span><span class="pln"> sourceUrl</span><span class="pun">:</span><span class="pln"> sourceUrl</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p>When a caller wants to know how the transformers are set up, they’re parsed from these fields into <code>TransformerConfig</code> objects:</p>   <pre class="prettyprint prettyprinted"><code class="language-dart"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Pubspec</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Set</span><span class="pun">&lt;</span><span class="typ">TransformerConfig</span><span class="pun">&gt;&gt;</span><span class="pln"> </span><span class="kwd">get</span><span class="pln"> transformers </span><span class="pun">{</span><span class="pln"><br />    </span><span class="kwd">return</span><span class="pln"> fields</span><span class="pun">[</span><span class="str">'transformers'</span><span class="pun">].</span><span class="pln">nodes</span><span class="pun">.</span><span class="pln">map</span><span class="pun">((</span><span class="pln">phase</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />      </span><span class="kwd">return</span><span class="pln"> phase</span><span class="pun">.</span><span class="pln">nodes</span><span class="pun">.</span><span class="pln">map</span><span class="pun">((</span><span class="pln">transformer</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />        </span><span class="kwd">var</span><span class="pln"> name </span><span class="pun">=</span><span class="pln"> transformer</span><span class="pun">.</span><span class="pln">nodes</span><span class="pun">.</span><span class="pln">keys</span><span class="pun">.</span><span class="pln">single</span><span class="pun">;</span><span class="pln"><br />        </span><span class="kwd">var</span><span class="pln"> config </span><span class="pun">=</span><span class="pln"> transformer</span><span class="pun">.</span><span class="pln">nodes</span><span class="pun">.</span><span class="pln">values</span><span class="pun">.</span><span class="pln">single</span><span class="pun">;</span><span class="pln"><br /><br />        </span><span class="com">// Keep track of the transformer name's span.</span><span class="pln"><br />        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">TransformerConfig</span><span class="pun">(</span><span class="pln">name</span><span class="pun">.</span><span class="pln">value</span><span class="pun">,</span><span class="pln"> config</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">.</span><span class="pln">span</span><span class="pun">);</span><span class="pln"><br />      </span><span class="pun">}).</span><span class="pln">toSet</span><span class="pun">();</span><span class="pln"><br />    </span><span class="pun">});</span><span class="pln"><br />  </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p><code>TransformerConfig</code> keeps track of the span that was parsed from the transformer’s name:</p>   <pre class="prettyprint prettyprinted"><code class="language-dart"><span class="kwd">class</span><span class="pln"> </span><span class="typ">TransformerConfig</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />  </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> name</span><span class="pun">;</span><span class="pln"><br />  </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Map</span><span class="pln"> config</span><span class="pun">;</span><span class="pln"><br />  </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">SourceSpan</span><span class="pln"> span</span><span class="pun">;</span><span class="pln"><br /><br />  </span><span class="typ">TransformerConfig</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">config</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">span</span><span class="pun">);</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <p>That way, when an error is detected relating to this transformer, we can attach the span to that error to make the error much nicer.</p>   <pre class="prettyprint prettyprinted"><code class="language-dart"><span class="typ">Future</span><span class="pun">&lt;</span><span class="typ">Transformer</span><span class="pun">&gt;</span><span class="pln"> loadTransformer</span><span class="pun">(</span><span class="typ">TransformerConfig</span><span class="pln"> config</span><span class="pun">)</span><span class="pln"> async </span><span class="pun">{</span><span class="pln"><br />  </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RemoteTransformer</span><span class="pun">(</span><span class="pln">spawnTransformerIsolate</span><span class="pun">(</span><span class="pln">config</span><span class="pun">));</span><span class="pln"><br />  </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br />    </span><span class="com">// Attach the configuration's span to the error so the user knows what</span><span class="pln"><br />    </span><span class="com">// transformer caused it and where to configure it.</span><span class="pln"><br />    </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">SourceSpanException</span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">(),</span><span class="pln"> config</span><span class="pun">.</span><span class="pln">span</span><span class="pun">);</span><span class="pln"><br />  </span><span class="pun">}</span><span class="pln"><br /></span><span class="pun">}</span></code></pre> <h2 id="spanning-the-gap-between-packages">Spanning the Gap Between Packages</h2> <p>I love package ecosystems, and the <code>source_span</code> package embodies many of the aspects I love best. It’s pretty small and pretty simple, but it serves an important role. It provides a consistent way for packages to expose and interact with sections of source text, and it does so in a way that makes the end user’s life better as well.</p> <p>Come back again in two weeks when I go over a package that, among other things, makes it really easy to create spans.</p>
