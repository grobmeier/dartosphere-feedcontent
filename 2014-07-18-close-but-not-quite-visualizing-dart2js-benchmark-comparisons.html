---
title: 'Close, But Not Quite Visualizing dart2js Benchmark Comparisons'
layout: post
published: '2014-07-18T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/drpJjGK5mnY/close-but-not-quite-visualizing-dart2js.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - benchmarking
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - javascript

---

<div class=top-chain-links></div><br />Thanks to <a href="https://github.com/dart-lang/benchmark_harness">benchmark_harness</a> and <a href="http://www.gnuplot.info/">gnuplot</a> I can make quick, pretty, and useful visualizations of the performance of different code implementations:<br /><br /><a href="http://4.bp.blogspot.com/-QokvI1pmT4Y/U8njRbo22EI/AAAAAAAAdUU/_1df6nAevsg/s1600/benchmark_summary.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-QokvI1pmT4Y/U8njRbo22EI/AAAAAAAAdUU/_1df6nAevsg/s640/benchmark_summary.png" /></a><br /><br />The actual numbers are almost inconsequential at this point. I need to know that I can make and visualize them in order to know that I can choose the right solution for inclusion in <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. I can investigate the numbers later—for now I only need know that I can generate them.<br /><br />And I <i>think</i> that I finally have that sorted out. I think that I have eliminated inappropriate comparisons, loops, types and just plain silly mistakes. To be sure, the code could (and probably will need to be) better. But, it works. More importantly, it can be run through a single <code>tool/benchmark.sh</code> script:<pre class=prettyprint>#!/bin/sh<br /><br /># Initialize artifact directory<br />mkdir -p tmp<br />cat /dev/null > tmp/benchmark_loop_runs.tsv<br />cat /dev/null > tmp/benchmark_summary.tsv<br /><br /># Individual benchmark runs of different implementations<br />echo "Running benchmarks..."<br />for X in 10 100 1000 10000 100000<br />do<br />    ./tool/benchmark.dart --loop-size=$X<br />    ./tool/benchmark_single_dispatch_iteration.dart --loop-size=$X<br />    ./tool/benchmark_visitor_traverse.dart --loop-size=$X<br />done<br />echo "Done. Results stored in tmp/benchmark_loop_runs.tsv."<br /><br /># Summarize results<br />echo "Building summary..."<br />./tool/summarize_results.dart<br />echo "Done. Results stored in tmp/benchmark_summary.tsv."<br /><br /># Visualization ready<br />echo ""<br />echo "To view in gnuplot, run tool/visualize.sh."<br /></pre>I am little worried about the need for artifacts, but on some level they are needed—the VM has to be freshly started with each run for accurate numbers. To retain the data between runs—and between the individual runs and the summary—artifacts files will need to store that information. I will worry about that another day. <br /><br />My concern today is that I benchmarking everything on the <a href="http://dartlang.org">Dart</a> VM. For the foreseeable future, however, the Dart VM will not be the primary runtime environment for Dart code. Instead, most Dart code will be compiled to JavaScript via <code>dart2js</code>. I cannot very well recommend a solution that works great in Dart, but fails miserably in JavaScript.<br /><br />So how to I get these numbers and visualizations in JavaScript?<br /><br />Well, I already know how to <a href="http://japhr.blogspot.com/2014/06/benchmarking-dart2js-code.html">benchmark dart2js</a>. I just compile to JavaScript and run with Node.js. Easy-peasey, right?<pre class=prettyprint>$ dart2js -o tool/benchmark.dart.js \<br />>            tool/benchmark.dart<br />tool/src/score_emitters.dart:3:8:<br />Error: Library not found 'dart:io'.<br />import 'dart:io';<br />       ^^^^^^^^^<br />tool/src/score_emitters.dart:39:18:<br />Warning: Cannot resolve 'File'.<br />  var file = new File(LOOP_RESULTS_FILE);<br />                 ^^^^<br />tool/src/score_emitters.dart:40:23:<br />Warning: Cannot resolve 'FileMode'.<br />  file.openSync(mode: FileMode.APPEND)<br />                      ^^^^^^^^<br />Error: Compilation failed.</pre>Arrrgh. All of my careful File code is for naught if I want to try this out in JavaScript. On the bright side, this is why you try a solution in a bunch of different environments before generalizing. <br /><br />This turns out to have a fairly easy solution thanks to <code>tee</code>. I change the score emitter to simply print to STDOUT in my Dart code:<pre class=prettyprint>recordTsvTotal(name, results, loopSize, numberOfRuns) {<br />  var averageScore = results.fold(0, (prev, element) => prev + element) /<br />    numberOfRuns;<br /><br />  var tsv =<br />    '${name}\t'<br />    '${averageScore.toStringAsPrecision(4)}\t'<br />    '${loopSize}\t'<br />    '${(averageScore/loopSize).toStringAsPrecision(4)}';<br /><br /><b>  print(tsv);</b><br />}</pre>Then I make the <code>benchmark.sh</code> responsible for writing the tab separated data to the appropriate file:<pre class=prettyprint>RESULTS_FILE=tmp/benchmark_loop_runs.tsv<br /># ...<br />dart2js -o tool/benchmark.dart.js \<br />           tool/benchmark.dart<br /># ...<br />for X in 10 100 1000 10000 100000<br />do<br />    ./tool/benchmark.dart --loop-size=$X <b>| tee -a $RESULTS_FILE</b><br />    # ...<br />done</pre>That works great—for the default case:<pre class=prettyprint>$ node tool/benchmark.dart.js<br />Classic Visitor Pattern 6465    10      646.5</pre>Unfortunately, the <code>dart:args</code> package does not work with Node.js. Supplying a different loop size still produces results for a loop size of 10:<pre class=prettyprint>$ node tool/benchmark.dart.js --loop-size=100<br />Classic Visitor Pattern 6543    <b>10</b>      654.3</pre>My initial attempt at solving this is <code>String.fromEnvironment()</code>:<pre class=prettyprint>const String LOOP_SIZE = const <b>String.fromEnvironment("LOOP_SIZE", defaultValue: "10");</b><br /><br />class Config {<br />  int loopSize, numberOfRuns;<br />  Config(List&lt;String> args) {<br />    var conf = _parser.parse(args);<br /><b>    loopSize = int.parse(LOOP_SIZE);</b><br />    // ...<br />  }<br />  // ...<br />}<br /></pre>But that does not work.<br /><br /><br /><span style="color: #ccc">Day #126</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/07/gnuplot-dart-benchmarks.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/drpJjGK5mnY" height="1" width="1"/>
