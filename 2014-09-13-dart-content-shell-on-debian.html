---
title: 'Dart Content Shell on Debian'
layout: post
published: '2014-09-13T15:53:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/xNfhn8Nq2xg/dart-content-shell-on-debian.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - 'continuous integration'
    - dart
    - dartlang
    - debian
    - testing

---

<div class=top-chain-links></div><br />I am a fan of <a href="http://debian.org">Debian</a> for public server installs. It includes no “junk” services that might expose the server to additional attack vectors, leaving just the services that I really want available. I rarely even bother with firewalls or iptables—the only active ports are those that would be available directly through a firewall anyway. That said, Debian is not without its challenges.<br /><br />I had hoped to get the <a href="http://dartlang.org">Dart</a> test build for <a href="http://patternsinpolymer.com/">Patterns in Polymer</a> running without any difficulties, but alas. Part of this is a problem of my own creation. I am installing on a 32 bit version of Debian 7. There are <a href="https://www.dartlang.org/tools/download.html#dart-sdk-for-debian-and-ubuntu">Debian packages</a> for 64 bit installs (though I do not know if they include the <code>content_shell</code> tool for Dart testing).<br /><br />Some of the difficulty is Debian's rather slow release cycle. For instance, the version of the shared <code>libc</code> library that Dart expects is not present on a default Debian 7 install:<pre class=prettyprint>$ ./dart/dart-sdk/bin/dart<br />./dart/dart-sdk/bin/dart: /lib/i386-linux-gnu/i686/cmov/libc.so.6: <b>version `GLIBC_2.15' not found</b> (required by ./dart/dart-sdk/bin/dart)</pre>There really seems no other way around this than to add the testing sources to the systems <code>/etc/apt/sources.list</code>:<pre class=prettyprint>$ tail -1 /etc/apt/sources.list<br />deb http://ftp.debian.org/debian testing main</pre>After a <code>apt-get update</code> and reinstall, things are OK:<pre class=prettyprint>$ sudo apt-get update<br />$ sudo apt-get install --reinstall debconf libc6 locales<br />$ ./dart/dart-sdk/bin/dart --version<br />Dart VM version: 1.6.0 (Tue Aug 26 13:57:28 2014) on "linux_ia32"</pre>I am already <a href="http://japhr.blogspot.com/2013/01/command-line-testing-of-browser-based.html">used to installing fonts to support</a> <code>content_shell</code>, so I get that out of the way up front. The following is taken from Chromium's  <a href="https://code.google.com/p/chromium/wiki/LayoutTestsLinux">layout tests for Linux</a>:<pre class=prettyprint>sudo apt-get install wdiff ttf-indic-fonts \<br />    ttf-mscorefonts-installer \<br />    ttf-dejavu-core ttf-kochi-gothic ttf-kochi-mincho \<br />    ttf-thai-tlwg</pre>I am not installing Apache, because this is a minimal Debian system. I have also swapped the Microsoft Core Fonts Ubuntu package name for the equivalent on Debian.<br /><br />Even after that, I still do not seem to have everything:<pre class=prettyprint>You are missing /usr/share/fonts/truetype/ttf-indic-fonts-core/lohit_hi.ttf. Try re-running build/install-build-deps.sh. Also see http://code.google.com/p/chromium/wiki/LayoutTestsLinux</pre>Hrm... that helpful link is not going to be much help since I just followed its font installation instructions to get to this point. The install script is not actually part of the Dart distribution, so that is not helpful either.<br /><br />Taking a closer look at the error, I note that the missing font seems to be coming from the ttf-indic-fonts package, which I did install. Ugh... on Debian, this is a <a href="https://packages.debian.org/wheezy/ttf-indic-fonts">transitional package</a>. In other words, the fonts did get installed, but by other packages that have superseded it—and are likely installing the fonts in different locations.<br /><br />My options are to attempt to install the Ubuntu package or manually recreate the <code>usr/share/fonts/truetype/ttf-indic-fonts-core</code> directory on this Debian system. Even though it could take me some time, I opt for the latter. Risking package conflicts (either now or after subsequent updates) feels like something that I would want to avoid.<br /><br />Thankfully, it does not require <i>too</i> much effort to recreate the Indic fonts required for <code>content_shell</code>:<pre class=prettyprint>$ cd /usr/share/fonts/truetype<br />$ sudo mkdir ttf-indic-fonts-core<br />$ cd ttf-indic-fonts-core<br />$ sudo ln -s ../lohit-punjabi/Lohit-Punjabi.ttf lohit_hi.ttf<br />$ sudo ln -s ../lohit-tamil/Lohit-Tamil.ttf lohit_ta.ttf<br />$ sudo ln -s ../fonts-beng-extra/MuktiNarrow.ttf<br />$ sudo ln -s ../lohit-punjabi/Lohit-Punjabi.ttf lohit_pa.ttf</pre>I am not 100% sure that those are the corresponding fonts. Well, it seems a safe bet that I got the right <code>MuktiNarrow.ttf</code> since the name remained the same. But the others are just guesses. I am especially unsure about the <code>lohit_hi.ttf</code> font as there does not seem to be <a href="https://packages.debian.org/search?searchon=contents&keywords=lohit&mode=filename&suite=stable&arch=any">an obvious match</a>. In the end, it does not make much of a difference to me—unless I am testing Dart code that uses that particular font. Since I have never heard of it, I think I am safe.<br /><br />Safe from layout errors, but I still cannot get my tests passing. Or running:<pre class=prettyprint>$ content_shell --dump-render-tree test/index.html<br />[1870:1870:0100/000000:29999461:ERROR:zygote_linux.cc(587)] write: Broken pipe</pre>This is due to a lack of an X server. Thankfully, I have already installed Xvfb. I am able to run <code>content_shell</code> with the <code>xvfb-run</code> wrapper script:<pre class=prettyprint>$ xvfb-run -s '-screen 0 1024x768x24' content_shell --dump-render-tree test/index.html <br />CONSOLE MESSAGE: unittest-suite-wait-for-done<br />CONSOLE MESSAGE: PASS: [defaults] it has no toppings<br />CONSOLE MESSAGE: PASS: [adding toppings] updates the pizza state accordingly<br />CONSOLE MESSAGE: <br />CONSOLE MESSAGE: All 2 tests passed.<br />CONSOLE MESSAGE: unittest-suite-success<br />CONSOLE WARNING: line 213: PASS<br />Content-Type: text/plain<br />PASS<br /></pre>With that, I finally have a failing build on my Jenkins CI server:<br /><br /><a href="http://4.bp.blogspot.com/-TOobD7-7Qcs/VBSe3lE8XSI/AAAAAAAAfPg/DApI6BDWgNc/s1600/01-failing_dart_build.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-TOobD7-7Qcs/VBSe3lE8XSI/AAAAAAAAfPg/DApI6BDWgNc/s400/01-failing_dart_build.png" /></a><br /><br />This might not seem like cause for celebration, but I am aware that some tests are failing—some project chapters in <a href="http://patternsinpolymer.com">Patterns in Polymer</a> are still following an older <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> project format. Now I have a build to tell me when I have them fixed (and to ensure that they stay functional).<br /><br />And that's where I will pick up tomorrow.<br /><br /><br /><span style="color: #ccc">Day #182</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/09/auto-update-of-dart-on-linux.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/xNfhn8Nq2xg" height="1" width="1"/>
