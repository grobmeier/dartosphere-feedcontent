---
title: 'The Unforunate Case of the Annotation and Polymer Testing'
layout: post
published: '2014-05-31T15:43:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/FMiDELr33cE/the-unforunate-case-of-annotation-and.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />OK. <i>Today</i> I test model driven attributes in a <a href="http://dartlang.org">Dart</a> <a href="http://www.polymer-project.org/">Polymer</a> element.<br /><br />I was able to update the attributes in the pizza-building <code>&lt;x-pizza></code> element yesterday:<br /><br /><a href="http://4.bp.blogspot.com/-zHtIQZZqblc/U4nrC8Kq-OI/AAAAAAAAZ9k/A-IIFHX_bXI/s1600/01-more_toppings_attribtues.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-zHtIQZZqblc/U4nrC8Kq-OI/AAAAAAAAZ9k/A-IIFHX_bXI/s400/01-more_toppings_attribtues.png" /></a><br /><br />I can now set toppings and query them on the various <code>toppings</code> attributes that I added to the Polymer element. And it was quite easy. What was surprisingly difficult was testing the darn thing.<br /><br />Actually, it was not testing the Polymer element that was the problem. It was testing in general. I have not one, but two approaches to Dart testing in <a href="http://patternsinpolymer.com">Patterns in Polymer</a>. One is more of a straight unit testing solution largely based on the current stable 0.9 <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> release. The other is a <a href="https://code.google.com/p/selenium/wiki/PageObjects">page objects</a> solution that I based on the unstable 0.10 release. Neither seems to be working for me—at least not without some changes.<br /><br />It sounds as though the initialization in the unstable 0.10 release, which had changed fairly significantly, is again changing back to something closer to the 0.9 initialization process. So I am going to stick with the stable Polymer.dart (currently 0.9.5+2) in my <code>pubspec.yaml</code>:<pre class=prettyprint>name: svg_example<br />dependencies:<br /><b>  polymer: any</b><br />  polymer_elements: any<br />dev_dependencies:<br />  scheduled_test: any<br />transformers:<br />- polymer:<br />    entry_points: web/index.html</pre>To get unstable, I would need to change the “any” dependency constraint to something like: <code>">=0.10.0-pre"</code>.<br /><br />The HTML page that serves as the testing context is fairly simple in 0.9—it need only load my Polymer component definition and the tests:<pre class=prettyprint>&lt;head><br />  &lt;!-- Load component(s) --><br /><b>  &lt;link rel="import" href="packages/svg_example/elements/x-pizza.html"></b><br /><br />  &lt;!-- The actual tests --><br /><b>  &lt;script type="application/dart" src="test.dart">&lt;/script></b><br />&lt;/head></pre>My <code>test.dart</code> file does the usual <code>initPolymer()</code> inside of the <code>main()</code> entry point to kick things off:<pre class=prettyprint>library x_pizza_test;<br /><br />import 'dart:html';<br />import 'dart:async';<br />import 'dart:convert';<br />import 'package:polymer/polymer.dart';<br />import 'package:scheduled_test/scheduled_test.dart';<br /><br /><b>@initMethod<br />main() {<br />  initPolymer();<br /><br />  // Actual tests go here...<br />}</b></pre>But when I try to run that test by loading the page (either in <a href="http://www.dartlang.org/dartium/">Dartium</a> or <code>content_shell</code>), I get a big old stacktrace from deep within Polymer that mostly amounts to:<pre class=prettyprint>Uncaught Error: NotSupportedError: Registration failed for type 'polymer-element'. A type with that name is already registered.</pre>This, and a few other related errors had me stuck. It turns out that the <code>@initMethod</code> annotation above the <code>main()</code> entry point in <code>test.dart</code> was the culprit. I had pulled that back from the 0.10 code and figured that it was just an annotation—and one that probably had no effect in 0.9 code—so how much harm could it cause?  Well the answer is that it seems to pull in enough Polymer code to cause my stack trace. <br /><br />After removing the <code>@initMethod</code> annotation, my tests… still fail. They fail, but don't error out. The failures are due to differences between the MDV approach that I have in this “play” Polymer example and the one that I used in the actual book code. The actual book code is cleaner, but I am not going to worry about clean code in my play area. Instead, I update the <code>XPizzaComponent</code> page object class to extract topping information from the attributes that I want to test anyway (I have an internal property in the “real” code):<pre class=prettyprint>class XPizzaComponent {<br />  PolymerElement el;<br />  XPizzaComponent(this.el);<br /><br />  // Extract information from the page<br />  String get wholeToppings => el.attributes['toppings'];<br />  String get firstHalfToppings => el.attributes['toppings1'];<br />  String get secondHalfToppings => el.attributes['toppings2'];<br />  // ...<br />}</pre>Then I can write my nice, clean Page Objects tests that verify that my new attributes behave as desired:<pre class=prettyprint><code>  group("[adding toppings]", (){<br />    test('updates the pizza state accordingly', (){<br /><br />      schedule(()=> xPizza.addWholeTopping('green peppers'));<br /><br />      schedule((){<br />        expect(xPizza.wholeToppings, contains('green peppers'));<br />        expect(xPizza.firstHalfToppings, isNull);<br />        expect(xPizza.secondHalfToppings, isNull);<br />      });<br />    });<br />  });</code></pre>Which does the trick nicely:<pre class=prettyprint>PASS: [defaults] it has no toppings<br />PASS: [adding toppings] updates the pizza state accordingly<br />All 2 tests passed.</pre>Dang it. I was so close last night. If I had only guessed the right thing to investigate, I could have performed a little test driven development on my new model-driven attributes. Ah well, there is still time for that. But first, I will investigate how <code>@initMethod</code> <i>should</i> be used in Polymer.dart 0.9. I never really expected it to have an effect on my code. Since it does, it must be used for something in 0.9. If that something is similar to the Polymer test setup that I had to do in 0.10, then I believe that I have some test re-organization that I can undertake.<br /><br />Tomorrow.<br /><br /><br /><span style="color: #ccc">Day #80</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/05/model-driven-attributes.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/FMiDELr33cE" height="1" width="1"/>
