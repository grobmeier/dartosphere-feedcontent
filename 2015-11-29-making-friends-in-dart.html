---
title: 'Making Friends in Dart'
layout: post
published: '2015-11-29T22:49:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/03rNk3NCN64/making-friends-in-dart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - memento

---

<div class=top-chain-links></div><br />The memento in my <a href="https://en.wikipedia.org/wiki/Memento_pattern">memento pattern</a> is a tad friendly. In the original <a href="http://en.wikipedia.org/wiki/Design_Patterns">Gang of Four book</a>, the suggested implementation has a narrow interface into the memento class. That is, only the originator of the memento can access the memento's properties. <br /><br />My <a href="http://dartlang.org">Dart</a> version is considerably more open:<pre class=prettyprint>// The Memento<br />class Playing {<br />  Song song;<br />  double time;<br />  Playing(this.song, this.time);<br />}</pre>I continue to work on the <code>VelvetFogMachine</code> application. It needs access to the auto-defined <code>song</code> and <code>time</code> getter methods when restoring a previously playing Mel Torm√© song:<pre class=prettyprint>// The "Originator"<br />class VelvetFogMachine {<br />  // ..<br />  // Restore from memento<br />  void backTo(Playing p) {<br />    print("  *** Whoa! This was a good one, let's hear it again :) ***");<br />    _play(p.song, p.time);<br />  }<br />}</pre>Really, all that the originator needs to access are the getters as shown. I do not need the auto-defined setters. I could address this with private properties paired with explicit, public getters:<pre class=prettyprint>class Playing {<br />  Song _song;<br />  double _time;<br />  Playing(this._song, this._time);<br /><br />  Song get song => _song;<br />  double get time => _time;<br />}</pre>This helps a little to address concerns with encapsulation. It is still possible for the caretaker context, which should only play or restore songs (set / restore state), to access the <code>song</code> and <code>time</code> properties. In most cases, this will not be a problem. The caretaker will merrily play and restore without ever wondering about the memento returned by <code>nowPlaying</code>:<pre class=prettyprint><code>  scatMan.play(<br />      'New York, New York Medley',<br />      'A Vintage Year'<br />  );<br />  replayer.add(scatMan.nowPlaying);<br />  //  Play other songs...<br /><br />  // The New York, New York Medley with George Shearing really is wonderful<br />  scatMan.backTo(replayer.last);</code></pre>That said, there is virtue in <a href="http://c2.com/cgi/wiki?NarrowTheInterface">narrowing the interface</a>. Another coder might come along and attempt to get access the memento song title. To achieve that, encapsulation would need to be broken, violating the very intention of the memento pattern.<br /><br />So what is to be done here? Unfortunately, I cannot think of much in Dart where there is no support for friend classes (as far as I know). The best I can come up with is an ugly hack to determine the caller of a <code>noSuchMethod()</code> invocation. <br /><br />In Dart, if a method is not found, but the class declares a <code>noSuchMethod()</code>, then that <code>noSuchMethod()</code> method is invoked. I could rewrite the public getters for <code>song</code> and <code>time</code> as:<pre class=prettyprint>class Playing {<br />  Song _song;<br />  double _time;<br />  Playing(this._song, this._time);<br /><br />  noSuchMethod(Invocation i) {<br />    if (i.memberName == #song) return this._song;<br />    if (i.memberName == #time) return this._time;<br /><br />    return super.noSuchMethod(i);<br />  }<br />}</pre>That is fairly straight-forward. If the <code>noSuchMethod()</code> method is invoked with <code>song</code> as the method name, then the private <code>_song</code> property is returned. The same thing happens with <code>time</code>. If something else if invoked, then the superclass <code>noSuchMethod()</code> is invoked, likely throwing a halting exception.<br /><br />This does nothing to prevent classes other than <code>VelvetFogMachine</code> from accessing <code>song</code> and <code>time</code>. For that, I need access to the class that invoked the getter. As far as I know there is no "real" way to accomplish this in Dart. The best I can do is throw an exception and catch the stacktrace:<pre class=prettyprint>class Playing {<br />  Song _song;<br />  double _time;<br />  Playing(this._song, this._time);<br /><br />  noSuchMethod(Invocation i) {<br />    try { throw new Error(); }<br />    catch (_exception, stackTrace) {<br />      if (!stackTrace.toString().contains(new RegExp(r'\#1\s+VelvetFogMachine'))) {<br />        return super.noSuchMethod(i);<br />      }<br />    }<br /><br />    if (i.memberName == #song) return this._song;<br />    if (i.memberName == #time) return this._time;<br /><br />    return super.noSuchMethod(i);<br />  }<br />}</pre>That works and <code>dartanalyzer</code> doesn't complain (with a <code>@proxy</code> annotation applied to the class). But yuck. Further, I an unsure if this works in all Dart VMs (it does <a href="https://dartpad.dartlang.org/a894d0d57d25ac04b65f">not work</a> on DartPad, for instance).<br /><br />So, unless someone has any ideas, it seems safe to say that Dart classes are friendly to everyone. In other words, Dart classes are slightly too friendly for the memento pattern.<br /><br /><br /><span style="color: #ccc">Day #18</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/memento-not-as-state.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/03rNk3NCN64" height="1" width="1" alt=""/>
