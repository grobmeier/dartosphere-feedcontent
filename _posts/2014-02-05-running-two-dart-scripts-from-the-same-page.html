---
title: 'Running Two Dart Scripts from the Same Page'
layout: post
published: '2014-02-05T23:59:00-05:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/axLXxZKR8vk/running-two-dart-scripts-from-same-page.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - isolates
    - polymer

---

<div class=top-chain-links></div><br /><a href="http://dartlang.org">Dart</a>'s double main limitation: sigh.<br /><br />I am thinking about how (and even if) to present reuse of <a href="http://www.polymer-project.org/">Polymer</a> in <a href="http://patternsinpolymer.com">Patterns in Polymer</a>. I think I already know how both the Dart and JavaScript versions of Polymer <i>want</i> me to do reuse, but my mind rebels. I don't want to use <a href="http://pub.dartlang.org/">Dart Pub</a> and <a href="http://bower.io">Bower</a> packages. I don't want to build pages that link these packages and some of their dependencies. <br /><br />I don't even want to <code>initPolymer()</code> inside the <code>main()</code> entry point of another Dart script. Due to Dart's double main limitation, which only allows one Dart script per page, I don't think I have a choice on that account (more on that in a second).<br /><br />What I really want is to add a <code>&lt;script></code> tag—either Dart or <code>dart2js</code> compiled JavaScript—to a page and have it load everything about my Polymer. With that one <code>&lt;script></code>, the Polymer polyfills should be loaded, my individual Polymer (template and code) should be loaded, and the Polymer platform should be loaded. With that one <code>&lt;script></code> tag, I ought to be able to use an <code>&lt;x-pizza></code> Polymer anywhere and it just work™. I don't think that's even possible in JavaScript yet, but I would like to explore the idea in Dart tonight.<br /><br />The main problem that I have is that if I want to run a Dart application <i>and</i> Polymer, things break. Consider a page with:<pre class=prettyprint><code>  &lt;head><br />    &lt;title>Reusing Polymers&lt;/title><br /><br />    &lt;!-- Load component(s) --><br />    &lt;link rel="import" href="packages/reuse/elements/hello-you.html"><br />    &lt;!-- Load Polymer --><br /><b>    &lt;script type="application/dart"><br />      export 'package:polymer/init.dart';<br />    &lt;/script><br />    &lt;script type="application/dart" src="main.dart">&lt;/script></b><br />  &lt;/head><br />  &lt;body><br />    &lt;div class="container"><br />      &lt;h1>Polymer Reuse&lt;/h1><br />      &lt;hello-you>&lt;/hello-you><br />    &lt;/div><br />  &lt;/body></code></pre>The problem is that both the <code>&lt;script></code> around <code>export</code> of Polymer's <code>init.dart</code> and the <code>&lt;script></code> that references <code>main.dart</code> conflict:<pre class=prettyprint>Only one Dart script tag allowed per document<br />warning: more than one Dart script tag in http://localhost:8080/index.html. Dartium currently only allows a single Dart script tag per document.</pre>In my mind, I would like the Polymer initialization and my application's <code>main.dart</code> to both run in separate isolates that share access to the page's DOM. That way Polymer could do its thing getting custom elements up and running while my application could do its thing setting up the application.<br /><br />That's just nonsense talk though. Isolates are small workers whose entire point is to share nothing, communicating only via message passing. As such, an isolate should not even have access to the web page—it should just be able to work on whatever messages are passed to it. I double check that by removing Polymer, and spawning an isolate in <code>main.dart</code>:<pre class=prettyprint>import 'dart:isolate';<br /><br />main() {<br />  ReceivePort receivePort = new ReceivePort();<br /><b>  receivePort.listen((msg) {<br />    print('Received from isolate: $msg');<br />  });</b><br /><br />  Isolate.spawnUri('main2.dart', [], receivePort.sendPort).<br />    then((ret)=> print('isolate spawned'));<br />}</pre>Then, in the <code>main2.dart</code> isolate, I send back the content of <code>document.body</code>:<pre class=prettyprint>import 'dart:html';<br />import 'dart:isolate';<br />main(List&lt;String> args, SendPort sendPort) {<br />  sendPort.send('hello');<br /><b>  sendPort.send(document.body.text);</b><br />}<br /></pre>That, of course, fails. Only the first message comes back and the isolate is never heard from again.<br /><br />So, am I out of luck here? Possibly, but I <i>can</i> get both the main.dart and the exported Polymer init.dart running at the same time. I just need to only use the dart2js compiled version on main.dart. That is, instead of relying on <code>dart.js</code> to fallback to the compiled version of main.dart, I use it from the outset:<pre class=prettyprint><code>    &lt;!-- Load component(s) --><br />    &lt;link rel="import" href="packages/reuse/elements/hello-you.html"><br />    &lt;!-- Load Polymer --><br />    &lt;script type="application/dart"><br />      export 'package:polymer/init.dart';<br />    &lt;/script><br /><b>    &lt;script src="main.dart.js">&lt;/script></b></code></pre>With that, I get both my Polymer and my simple <code>main.dart</code> console output:<br /><br /><a href="http://1.bp.blogspot.com/-v_ZyxJJjqes/UvMXz3NC3iI/AAAAAAAAVSE/eRnCRWB3sQY/s1600/01-hello_from_main.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-v_ZyxJJjqes/UvMXz3NC3iI/AAAAAAAAVSE/eRnCRWB3sQY/s400/01-hello_from_main.png" /></a><br /><br />Sure, that's cheating. I am not really running two different Dart scripts at the same time. But it seems to work. I may explore this a bit more tomorrow. Then again, the isolate exercise help solidify my thinking more than I care to admit. I did not expect it to work, but seeing it fail gave me more of an appreciation for the current <a href="https://api.dartlang.org/apidocs/channels/stable/#dart-async.Zone">zone</a> approach in Polymer.dart. Or I may even give this a go in JavaScript.<br /><br />But first, I need to finish that Angular chapter in Patterns in Polymer...<br /><br /><span style="color: #ccc">Day #1,018</span>  <br /><br /><p class=bottom-chain-links><a href="">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/02/cat-hat-in-dartium.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/axLXxZKR8vk" height="1" width="1"/>
