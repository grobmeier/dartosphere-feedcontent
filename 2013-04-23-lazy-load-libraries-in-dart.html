---
title: 'Lazy Load Libraries in Dart'
layout: post
published: '2013-04-23T22:47:00-07:00'
feed: 'Seth Ladd''s Blog'
link: 'http://feedproxy.google.com/~r/SethLaddsBlog/~3/EhU7euhpr50/lazy-load-libraries-in-dart.html'
author:
    name: Anonymous
    email: noreply@blogger.com
    url: 'http://www.blogger.com/profile/13906800552603557213'
tags:
    - dart
    - dartlang

---

<span style="font-size: x-large;">UPDATE: This article is now DEPRECATED, but the feature lives on! Dart now formally supports lazy loading (deferred) libraries. Learn more in the <a href="https://www.dartlang.org/docs/spec/deferred-loading.html">Deferred Loading in Dart article</a>.</span><br /><br /><span style="color: #999999;">Dart is a statically analyzable language, and its tree-shaking compiler does a good job of eliminating dead code and producing a single, optimized application file. However, sometimes developers need to control when certain libraries are loaded and thus need to control which libraries are included in the main application file. To help, the dart2js compiler, which converts Dart code into JavaScript code, now supports lazy-loaded libraries.</span><br /><span style="color: #999999;"><br /></span><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-mt92rQOSk_Q/UXdx0aKXAfI/AAAAAAAAV1Y/zCqHR0Le-hc/s1600/87885327_b0db9347cf.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><span style="color: #999999;"><img border="0" src="http://1.bp.blogspot.com/-mt92rQOSk_Q/UXdx0aKXAfI/AAAAAAAAV1Y/zCqHR0Le-hc/s1600/87885327_b0db9347cf.jpg" /></span></a></div><span style="color: #999999;"><br /></span><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999; font-size: large;">Lazy Load</span><br /><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999;">As an example, consider an application that has many different screens. Some screens are more obscure than others, and aren't required for the application to start. A developer should be able to say "I don't need these screens now, but pull them in when I do need them." This lazy-loading is a common deployment strategy for web apps, because small initial loads means faster application startup.</span></div><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999;">You can mark a library as "lazy", and the dart2js compiler will output a separate JavaScript file for that library. Note that dart2js still performs tree shaking (aka dead code elimination) across the entire app (technically, across the entire isolate). This means that only the functionality required from the lazy-loaded library will actually be compiled into the separate file.</span></div><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999;">The lazy-loaded library is still part of the application structure, and must exist and be available to dart2js when the program is compiled. This is not "dynamic loading", per se, because the application must statically import all libraries (lazy or not).</span></div><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999;">(Note: as of the time of this writing, dart2js emits at most one other JavaScript file. This restriction will be removed and you will be able to emit multiple files for a single application. Please track <a href="https://code.google.com/p/dart/issues/detail?id=3940">Dartbug 3940</a> to learn more.)</span></div><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999; font-size: large;">DeferredLibrary Example</span></div></div><div><span style="color: #999999;"><br /></span></div><div><span style="color: #999999;">The main application can mark a library with an&nbsp;@lazy metadata. Then, it declares an instance of <a href="http://api.dartlang.org/docs/bleeding_edge/dart_async/DeferredLibrary.html">DeferredLibrary</a> that points to the outputted JavaScript file.</span></div><div><span style="color: #999999;"><br /></span></div><div><div class="p1"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s1">import </span>'dart:html'<span class="s1">;</span></span></div><div class="p1"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s1">import </span>'dart:async'<span class="s1">;</span></span></div><div class="p2"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">@lazy</span></div><div class="p1"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s1">import </span>'reverser.dart'<span class="s1">;</span></span></div><div class="p2"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s2">const</span> lazy = <span class="s2">const</span> DeferredLibrary(<span class="s3">'reverser'</span>, uri: <span class="s3">'./part.js'</span>);</span></div><div class="p2"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s2">void</span> main() {</span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">&nbsp; lazy.load().then((_) {</span></div><div class="p1"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s1">&nbsp; &nbsp;&nbsp;print(</span>'library loaded'<span class="s1">);</span></span></div><div class="p1"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s1">&nbsp; &nbsp;&nbsp;query(</span>"#sample_text_id"<span class="s1">)</span></span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp;&nbsp;..text = <span class="s3">"Click me!"</span></span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp;&nbsp;..onClick.listen(reverseText);</span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;});</span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">}</span></div><div class="p2"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><br /></span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;"><span class="s2">void</span> reverseText(MouseEvent event) {</span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">&nbsp; query(<span class="s3">"#sample_text_id"</span>).text =</span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; reverse(query(<span class="s3">"#sample_text_id"</span>).text);</span></div><div class="p3"><span style="color: #999999; font-family: Courier New, Courier, monospace;">}</span></div><div class="p3"><span style="color: #999999;"><br /></span></div><div class="p3"><span style="color: #999999;">Notice how the library doesn't come into existence until after the Future from <span style="font-family: Courier New, Courier, monospace;">lazy.load()</span> completes. Only then can you call into the library.</span></div><div class="p3"><span style="color: #999999;"><br /></span></div><div class="p3"><span style="color: #999999;">The runtime throws NoSuchMethodError if you try to access functionality from a library that it not yet loaded.</span></div><div class="p3"><span style="color: #999999;"><br /></span></div><div class="p3"><span style="color: #999999; font-size: large;">More to come</span></div><div class="p3"><span style="color: #999999;"><br /></span></div><div class="p3"><span style="color: #999999;">The lazy-load functionality of dart2js is just the beginning. In the future, you will be able to mark multiple libraries as "lazy", and really control how you deploy and load your web application.</span><br /><span style="color: #999999;"><br /></span><span style="color: #999999;">Also, this functionality only currently works with dart2js. Please star <a href="https://code.google.com/p/dart/issues/detail?id=10171">Dartbug 10171</a> if you are interested in seeing the same lazy-loading for the VM and Dartium.</span></div><div class="p3"><span style="color: #999999;"><br /></span></div><div class="p3"><span style="color: #999999;">Please try this out, we look forward to your feedback!</span></div><div class="p3"><span style="color: #999999;"><br /></span></div><div class="p3"><span style="color: #999999;"><br /></span></div></div><span style="color: #999999;">(Photo Credit: <a href="http://www.flickr.com/photos/87603889@N00/87885327/">Marcus Hansson</a>&nbsp;licensed under&nbsp;<a href="http://creativecommons.org/licenses/by/2.0/">cc</a>)</span><img src="http://feeds.feedburner.com/~r/SethLaddsBlog/~4/EhU7euhpr50" height="1" width="1" alt=""/>
