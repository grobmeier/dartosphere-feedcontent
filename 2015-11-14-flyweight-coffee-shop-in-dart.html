---
title: 'Flyweight Coffee Shop in Dart'
layout: post
published: '2015-11-14T23:21:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/Ar4lvVCT-fg/flyweight-coffee-shop-in-dart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight

---

<div class=top-chain-links></div><br />The current <a href="https://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight pattern</a> example with which I have been playing is vaguely unsatisfying to me. I co-opted a tree decoration example from the Wikipedia article and it seemed a nice start. I know it is just an example, but it does not feel like something from the real-world. Plus it really seemed like it had two flyweights in there, confusing things.<br /><br />Eventually, I'd like to pull find some real-world examples (anyone know where flyweight was used in live Dart code?), but for now, I am going to play with the Scala example from the same Wikipedia article. It is a coffee-ordering example so that ought to feel more real.<br /><br />Borrowing from the Scala coffee shop example, I would to be able to deliver a bunch of orders to different people. At the end of the day, I would like to be able to tally up some totals. The main thread of the application should look something like:<br /><br /><pre class=prettyprint>main() {<br />  var shop = new CoffeeShop()<br />    ..order('Cappuccino', 'large',  who: 'Fred', fooFoo: 'Extra Shot')<br />    ..order('Espresso',   'small',  who: 'Bob')<br />    ..order('Frappe',     'large',  who: 'Alice')<br />    ..order('Frappe',     'large',  who: 'Elsa', fooFoo: '2 Percent Foam')<br />    ..order('Coffee',     'small')<br />    ..order('Coffee',     'medium', who: 'Chris');<br /><br />  shop.serve();<br />  print('-----');<br />  print(shop.report);<br />}</pre>The flyweight in this example will be the coffee "flavor" (Cappuccino, Espresso, Coffee, etc.). Intrinsic to the coffee flavor is the name and maybe some nutritional information or cost data. The rest of the information is specific to the order: who placed it, the size, and any silly instructions.<br /><br />The <code>Order</code> class would be something simple along the lines of:<pre class=prettyprint>class Order {<br />  CoffeeFlavor flavor;<br />  int size;<br />  String instructions;<br />  String who;<br /><br />  Order(this.flavor, this.size, this.who, this.instructions);<br /><br />  String get service => "${flavor.name} to ${who}";<br />}</pre>I am going to stick with last night's factory constructor (instead of the previous night's factory class). So the flyweight + factory is:<pre class=prettyprint>class CoffeeFlavor {<br />  static Map _cache = {};<br />  static int get totalCount => _cache.length;<br /><br />  factory CoffeeFlavor(name) =><br />      _cache.putIfAbsent(name, () => new CoffeeFlavor._(name));<br /><br />  String name;<br />  CoffeeFlavor._(this.name);<br />}</pre>What's left is the <code>CoffeeShop</code> class which is responsible for keeping a list of orders for serving and for end-of-day reporting. To handle orders as above, the <code>order()</code> method should look something like:<pre class=prettyprint><code>  void order(name, sizeName, {who, fooFoo}) {<br />    var flavor = new CoffeeFlavor(name);<br />    int size = sizes[sizeName];<br />    _orders.add(new Order(flavor, size, who, fooFoo));<br />  }</code></pre>The rest of the class declares the private list of <code>_orders</code> and a mapping of size names to fluid ounces:<pre class=prettyprint>class CoffeeShop {<br />  static Map sizes = {<br />    'small': 8,<br />    'medium': 12,<br />    'large': 20<br />  };<br /><br />  List _orders = [];<br /><br />  void order(name, sizeName, {who, fooFoo}) {<br />    var flavor = new CoffeeFlavor(name);<br />    int size = sizes[sizeName];<br />    _orders.add(new Order(flavor, size, who, fooFoo));<br />  }<br />}</pre>Next, I need a method to serve drinks:<pre class=prettyprint><code>  void serve() {<br />    _orders.forEach((o) { print("Served ${o.service}.");});<br />  }</code></pre>Finally, I can define a simple <code>report</code> getter to produce some daily stats:<pre class=prettyprint><code>  String get report => "Served ${_orders.length} coffee drinks.\n"<br />      "Served ${CoffeeFlavor.totalCount} kinds of coffee drinks.\n";</code></pre>With that, I can run a coffee shop:<pre class=prettyprint>Served Cappuccino to Fred.<br />Served Espresso to Bob.<br />Served Frappe to Alice.<br />Served Frappe to Elsa.<br />Served Coffee to null.<br />Served Coffee to Chris.<br />-----<br />Served 6 coffee drinks.<br />Served 4 kinds of coffee drinks.</pre>That is very similar to what I had the previous night with the tree example, but it does have a more real world feel to it. At least to this coffee drinker.<br /><br />What I am keen to explore next is building with additional properties that are intrinsic to the <code>CoffeeFlavor</code> flyweight object. For instance, what if each flavor had a profit of $USD0.10 per fluid ounce except for "Frappe" drinks, which are $USD0.50? That could be represented in the flyweight as a <code>profitPerFluidOunce</code> getter method:<pre class=prettyprint>class CoffeeFlavor {<br />  //...<br />  float get profitPerOunce => name == 'Frappe' ? .5 : 0.1;<br />}</pre>The <code>Order</code> class can then determine profit for each order instance:<pre class=prettyprint>class Order {<br />  //...<br />  float get profit => size * flavor.profitPerOunce;<br />}</pre>Now the coffee shop report can quickly include the day's take:<pre class=prettyprint>class CoffeeShop {<br />  // ...<br />  String get report => "Served ${_orders.length} coffee drinks.\n"<br />      "Served ${CoffeeFlavor.totalCount} kinds of coffee drinks.\n"<br />      "For a profit of: \$${profit}";<br /><br />  float get profit {<br />    var sum = 0;<br />    _orders.forEach((o){ sum += o.profit; });<br />    return sum;<br />  }<br />}</pre>Which results in a profit of a little over $USD24 for a handful of drinks:<pre class=prettyprint>Served 6 coffee drinks.<br />Served 4 kinds of coffee drinks.<br />For a profit of: $24.8</pre>Nice!<br /><br />I appreciate this example's "real world" feel. What I most appreciate about it is the obvious ability to add intrinsic properties to the flyweightâ€”and a quick way to use them.<br /><br />(Try it on DartPad: <a href="https://dartpad.dartlang.org/c5d130cf24ddbbab6a11">https://dartpad.dartlang.org/c5d130cf24ddbbab6a11</a>)<br /><br /><span style="color: #ccc">Day #3</span>  <br /><br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/factory-class-vs-factory-constructor-in.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2015/11/searching-for-flyweight.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/Ar4lvVCT-fg" height="1" width="1" alt=""/>
