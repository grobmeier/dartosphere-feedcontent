---
title: 'Repeating Undos in Command'
layout: post
published: '2015-12-13T23:11:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/z0lpxNSyUpw/repeating-undos-in-command.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - command
    - dart
    - dartlang
    - 'design patterns'

---

<div class=top-chain-links></div><br />My rather complicated <a href="https://en.wikipedia.org/wiki/Command_pattern">command pattern</a> has a bug. Perhaps my first instinct ought to be to simplify the implementation and maybe I will do that in the end. But first, I am going to see if I can fix the bug and, in doing so, see if this has something to say about my implementation of the pattern.<br /><br /><i>Last night's implementation on DartPad: <a href="https://dartpad.dartlang.org/efac76d03df17f6e3920">https://dartpad.dartlang.org/efac76d03df17f6e3920</a>.</i><br /><br />The problem is in the undo operation. Complicating the undo is that some of the commands in my <a href="http://dartlang.org">Dart</a> implementation accept arguments:<pre class=prettyprint><code>  btnPlay.call(['It Had to Be You']);<br />  btnPlay.call(['Cheek to Cheek']);<br />  btnPlay.call(['At Last']);<br />  Button.undo();</code></pre>I resolved a similar issue with these argument-commands <a href="http://japhr.blogspot.com/2015/12/multiple-command-undos.html">the other night</a>, but after some naming-inspired refactoring last night, the problem is back.<br /><br />In the above, I am simulating a Mel Tormé aficionado playing songs on the velvet fog machine. The above script plays <i>It Had to Be You</i>, <i>Cheek to Cheek</i>, then <i>At Last</i>. While playing <i>At Last</i>, the Mel fan hits the undo button, which sends the song back to <i>Cheek to Cheek</i>. That still works:<pre class=prettyprint>$ ./bin/jukebox.dart<br />Play It Had to Be You<br />Play Cheek to Cheek<br />Play At Last<br />Undoing Instance of 'PlayCommand'<br />Play Cheek to Cheek</pre>The problem occurs if I hit the undo button twice:<pre class=prettyprint>$ ./bin/jukebox.dart<br />Play It Had to Be You<br />Play Cheek to Cheek<br />Play At Last<br />Undoing Instance of 'PlayCommand'<br />Play Cheek to Cheek<br />Undoing Instance of 'PlayCommand'<br />Play Cheek to Cheek</pre>Instead of playing <i>At Last</i> after the second undo, the velvet fog machine is still playing <i>Cheek to Cheek</i>.<br /><br />My solution from the other night was to store the previous state information in the concrete command object—the <code>PlayCommand</code> in this case:<pre class=prettyprint>class PlayCommand implements Command {<br />  VelvetFogMachine machine;<br />  String _prevSong;<br /><br />  PlayCommand(this.machine);<br /><br />  void call([List args]) {<br />    _prevSong = machine.currentSong;<br />    machine.play(args.first);<br />  }<br /><br />  void undo() {<br />    machine.play(_prevSong);<br />  }<br />}</pre>Whenever the command is called, it first stores the current song being played, then tells the machine to play the requested selection. The whole point of the command pattern is to objectify the receiver (the velvet fog machine) and action (play), so this is all above board—I am not violating encapsulation. <br /><br />This approach seemed to work the other night, but no longer. So what gives? <br /><br />I initially thought this was caused by storing the history as a static property of the <code>Button</code> class:<pre class=prettyprint>class Button {<br />  static List _history = [];<br />  // ...<br />  void call([List args]) {<br />    command.call(args);<br />    _history.add(command);<br />  }<br />  // ...<br />}</pre>That turns out not to be the cause. Instead, this is a pre-existing bug that I only noticed because of last night's reworking. <br /><br />When the above code adds the <code>command</code> object to the history list, it is always adding the same instance when repeating commands. That is, multiple play button presses always send the same command to <code>call()</code>:<pre class=prettyprint><code>  var btnPlay =<br />    new Button("Play", play);<br />  btnPlay.call(['It Had to Be You']);<br />  btnPlay.call(['Cheek to Cheek']);<br />  btnPlay.call(['At Last']);</code></pre>To resolve this, I have to clone the command before adding it to the history list:<pre class=prettyprint>class Button {<br />  static List _history = [];<br />  // ...<br />  void call([List args]) {<br />    command.call(args);<br />    _history.add(command._clone());<br />  }<br />  // ...<br />}</pre>That way, the previous song is remembered in the clone and not in the re-used instance.<br /><br />Since there is no built-in <code>clone()</code> method in Dart, I have to make one of my own:<pre class=prettyprint>class PlayCommand implements Command {<br />  VelvetFogMachine machine;<br />  String _prevSong;<br />  PlayCommand(this.machine);<br />  // ...<br />  PlayCommand _clone() =><br />    new PlayCommand(machine)<br />        .._prevSong = _prevSong;<br />}</pre>With that, I am able to undo to my heart's content:<pre class=prettyprint>$ ./bin/jukebox.dart                                       <br />Play It Had to Be You<br />Play Cheek to Cheek<br />Play At Last<br />Undoing Instance of 'PlayCommand'<br />Play Cheek to Cheek<br />Undoing Instance of 'PlayCommand'<br />Play It Had to Be You</pre>Although that does resolve my problem, I am not entirely satisfied. I have previously found that I need to clone receivers for similar reasons and now I have to clone commands. That is a lot of cloning to keep in order. I do not know if anything can be done to improve the situation. I think not, though I may take a look tomorrow. For now, I call this good enough.<br /><br /><i>Play with the code on DartPad: <a href="https://dartpad.dartlang.org/164484663ae8487e4aa3">https://dartpad.dartlang.org/164484663ae8487e4aa3</a>.</i><br /><br /><br /><span style="color: #ccc">Day #32</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/12/whats-in-invoker-name.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="https://dartpad.dartlang.org/3b2ac3f421db89c2b56a">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/z0lpxNSyUpw" height="1" width="1" alt=""/>
