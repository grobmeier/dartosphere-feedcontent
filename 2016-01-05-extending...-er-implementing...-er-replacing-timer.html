---
title: 'Extending... er, Implementing… er, Replacing Timer'
layout: post
published: '2016-01-05T22:50:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/vdicmjD0miY/extending-er-implementing-er-replacing.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - 'adapter pattern'
    - chain
    - dart
    - dartlang
    - 'design patterns'

---

<div class=top-chain-links></div><br />The timer in my <a href="http://dartlang.org">Dart</a> implementation of the <a href="https://en.wikipedia.org/wiki/Adapter_pattern">adapter pattern</a> bugs me. More to the point, its very existence annoys me. <br /><br />The asynchronous interface of the robot currently returns <code>Timer</code> instances for the various movement actions:<pre class=prettyprint>class UniversalRemoteRobot {<br />  // ...<br />  Timer moveForward()  => _executeControlledCommand(_ubot.moveForward);<br />  Timer moveBackward() => _executeControlledCommand(_ubot.moveBackward);<br />  Timer moveLeft()     => _executeControlledCommand(_ubot.moveLeft);<br />  Timer moveRight()    => _executeControlledCommand(_ubot.moveRight);<br />  // ...<br />}</pre>This exposes the underlying implementation detail of the movement commands. I am moving procedural robots once per second with a periodic <code>Timer</code>. The outside world only need a command runner object to be used when canceling movement. The <code>Timer</code> class includes a <code>cancel()</code> method, so this works, but exposes too much information.<br /><br />I have tried replacing the <code>Timer</code> with a quick subclass, but that has proven unsuccessful. Tonight, I take a closer look. This ought be easy, after all.<br /><br />I start by defining a simple <code>Runner</code> class that subclasses <code>Timer</code>:<pre class=prettyprint>class Runner extends Timer {}</pre>Even with that simple declaration, I get a bunch of warnings from the type analyzer:<pre class=prettyprint>[error] The generative constructor 'Timer(Duration duration, () → void callback) → Timer' expected, but factory found<br />[warning] Missing concrete implementation of 'Timer.cancel' and getter 'Timer.isActive'<br />[warning] The class 'Runner' does not have a constructor 'periodic'</pre>All right, I understand that I need the <code>periodic()</code> named constructor, but what gives with the rest of that? Why do I need to implement <code>cancel()</code> again—can't the superclass' implementation handle that? And what's with that factory constructor warning...?<br /><br />Oh, dear. I see what the problem is. All of the constructors in <code>Timer</code> are factory constructors. That means my subclass needs to define its own factory or generative constructors to implement <code>Timer</code>. Bother.<br /><br />Well, not that much of a bother, I suppose, but I would have preferred a simpler <code>extends</code> than this, if only to keep any complexity out of the supporting code. In live code, minor complexity is no big deal. In illustrative code, it can be a discussion killer. <br /><br />I may stick with vanilla <code>Timer</code> in the end, but let's see what it looks like. The lack of public constructors likely means that I can implement a <code>Runner</code> independent of <code>Timer</code>, but I will start by at least implementing the interface (the <code>isActive</code> and <code>cancel()</code> action are both useful for running commands):<pre class=prettyprint>class Runner implements Timer {<br />  Timer _t;<br />  Runner.periodic(Duration d, Function cb) {<br />    _t = new Timer.periodic(d, cb);<br />  }<br />  bool get isActive => _t.isActive;<br />  void cancel() { _t.cancel(); }<br />}</pre>I still need a <code>Timer</code> instance to move my robots once a second. If <code>Timer</code> won't give it to me, I create my own instance variable. The two <code>Timer</code> methods can then delegate to this instance. I still need a regular, unnamed constructor. I can actually use a redirecting constructor here... and get a little fancy:<pre class=prettyprint>const oneSecond = const Duration(seconds: 1);<br /><br />class Runner implements Timer {<br />  Timer _t;<br />  Runner(Function cb): this.periodic(oneSecond, (_){cb();});<br />  Runner.periodic(Duration d, Function cb) {<br />    _t = new Timer.periodic(d, cb);<br />  }<br />  // ...<br />}</pre>My movement commands all take zero arguments while a periodic timer callback requires one argument (the timer, so it can be canceled). While redirecting the main constructor, I convert the supplied callback from a zero argument callback to a zero argument callback that is wrapped by a one argument function. This means I can create new command runners as: <code>new Runner(command))</code>.<br /><br />That's nice. It is fun to play with redirecting constructors, but it is completely unnecessary in this case. I can remove the <code>extends Timer</code> constraint and make things much clearer:<pre class=prettyprint>const oneSecond = const Duration(seconds: 1);<br /><br />class Runner {<br />  Timer _t;<br />  Runner(Function cb) {<br />    _t = new Timer.periodic(oneSecond, (_){ cb(); });<br />  }<br />  bool get isActive => _t.isActive;<br />  void cancel() { _t.cancel(); }<br />}<br /></pre>So, in the end, it was not a big deal replacing the <code>Timer</code> class with something similar, but a little closer to the domain. I do wonder why <code>Timer</code> only provides factory constructors. I would hazard a guess that this has to do with compiling to JavaScript and the underlying <code>setTimeout()</code> implementation. It may not be a big deal, but it is not something that just works™ like so many things in Dart. Thankfully, it only requires a little noodling through.<br /><br /><br /><span style="color: #ccc">Day #55</span>  <br /><br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2016/01/the-coolest-command-is-also-dartiest.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2016/01/dart-delegation.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/vdicmjD0miY" height="1" width="1" alt=""/>
