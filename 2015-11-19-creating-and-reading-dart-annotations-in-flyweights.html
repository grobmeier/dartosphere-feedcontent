---
title: 'Creating and Reading Dart Annotations in Flyweights'
layout: post
published: '2015-11-19T22:44:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/nVZr19bCljA/creating-and-reading-dart-annotations.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - annotations
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight
    - mirrors

---

<div class=top-chain-links></div><br />I am settling comfortably into <a href="http://dartlang.org">Dart</a> mirrors as a solution for obtaining concrete instances in the <a href="https://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight pattern</a>. They are not a one-size-fits-all solution, but they strike a nice balance between usability in the client context (especially when paired with Dart's factory constructors) and maintainability of the flyweight code. That said, I do not want to leave reasonable options unexplored.<br /><br />While reasonable people can disagree on what reasonable options are, I felt the siren's song of code annotation more than once while working with this pattern. So today, I give into that temptation. Hopefully I won't be dashed on rocks for my trouble.<br /><br />While working other angles on the problem of concrete classes, annotations were appealing mostly because of their constant nature. My current <code>CoffeeFlavor</code> interface is a regular (non-constant) class:<pre class=prettyprint>class CoffeeFlavor {<br />  // Lots of static, mirror code from last night here...<br />  // Factory constructor:<br />  factory CoffeeFlavor(name) {<br />    return _cache.putIfAbsent(name, () =><br />        classMirrors[new Symbol(name)].<br />            newInstance(new Symbol(''), []).<br />            reflectee<br />    );<br />  }<br />  // Normal class stuff:<br />  String get name => "Fake Coffee";<br />  double get profitPerOunce => 0.0;<br />}</pre>Concrete implementations that get used as flyweights are similarly non-constant:<pre class=prettyprint>class Cappuccino implements CoffeeFlavor {<br />  String get name => 'Cappuccino';<br />  double get profitPerOunce => 0.35;<br />}<br /></pre>Due to the factory constructor, various solutions to the flyweight caching felt like a constant was the only solution. In the end, I could not make them work — hence last night's mirror solution.<br /><br />Somewhere in my brain I thought that, since annotations are constants, maybe they can help here. But now that I am faced with the blank page, all I can think to do is mark a concrete class with an annotation to help finding and caching it:<pre class=prettyprint>@flavor<br />class Cappuccino implements CoffeeFlavor {<br />  String get name => 'Cappuccino';<br />  double get profitPerOunce => 0.35;<br />}<br /></pre>That seems to offer nothing new over yesterday's solution which made use of the implemented interface to find concrete classes. If anything, the annotation is one extra line. <br /><br />Still, while I am here, it might be fun to write some Dart code that can read and apply annotations. I start by defining the class and annotation <code>const</code>:<pre class=prettyprint>// Annotation Class<br />class Flavor { const Flavor(); }<br />// Annotation instance<br />const flavor = const Flavor();</pre>Yesterday's code found concrete <code>classMirrors</code> by filtering for “super interfaces” that contained <code>CoffeeFlavor</code>:<pre class=prettyprint><code>  static Map classMirrors = _allDeclarations.<br />    keys.<br />    where((k) => _allDeclarations[k] is ClassMirror).<br />    where((k) =><br />      _allDeclarations[k].superinterfaces.contains(reflectClass(CoffeeFlavor))<br />    ).<br />    fold({}, (memo, k) => memo..[k]= _allDeclarations[k]);</code></pre>Tonight, I need to similarly work though all class declarations, but filter on <code>metadata</code> (annotations):<pre class=prettyprint><code>  static Map classMirrors = _allDeclarations.<br />    keys.<br />    where((k) => _allDeclarations[k] is ClassMirror).<br />    where((k) =><br />      _allDeclarations[k].metadata.map((m)=> m.type.reflectedType).contains(Flavor)<br />    ).<br />    fold({}, (memo, k) => memo..[k]= _allDeclarations[k]);</code></pre>The <code>_allDeclarations.keys</code> is a map of symbols (e.g. <code>#Cappuccino</code>) pointing to declaration mirrors. So iterating over all the keys, then filtering on <code>_allDeclarations[k]</code> gives me individual declarations like the concrete class definition. From there, I map the annotations/metadata to the corresponding annotation type. In this case I want the <code>Flavor</code> annotation so that any classes with the <code>Flavor</code> annotation are returned.<br /><br />If I had declared <code>Flavor</code> with properties and set them in the <code>const</code> declaration, then I could get those properties with the <code>getField()</code> method. Here, however, I just need to know if the <code>@flavor</code> annotation is being used. So I am already done!<br /><br />My code continues to pass <code>dartanalyzer</code> and the coffee shop code that relies on this flyweight code similarly continues to work. Annotations do not buy me anything substantive in this case (at least that I can see). Still it is good to know how to extract and apply them.<br /><br />(Play with this code on DartPad: <a href="https://dartpad.dartlang.org/c7dabc0c57a93e8d88d7">https://dartpad.dartlang.org/c7dabc0c57a93e8d88d7</a>)<br /><br /><br /><span style="color: #ccc">Day #8</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/locking-down-flyweights-mirrors-in-dart.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/nVZr19bCljA" height="1" width="1" alt=""/>
