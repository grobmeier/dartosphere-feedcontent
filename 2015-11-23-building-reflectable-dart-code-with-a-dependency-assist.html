---
title: 'Building Reflectable Dart Code with a Dependency Assist'
layout: post
published: '2015-11-23T21:41:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/HSxHq5Il5KI/building-reflectable-dart-code-with.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight
    - mirrors

---

<div class=top-chain-links></div><br />OK, let's try that again.<br /><br />Yesterday I was unable to build my <a href="https://pub.dartlang.org/packages/reflectable">Reflectable</a>-based <a href="http://dartlang.org">Dart</a> code—either into fully assembled Dart or into JavaScript. Thanks to a hint from <a href="https://plus.google.com/117034297637525232661">Sigurd Meldgaard</a> in the <a href="http://japhr.blogspot.com/2015/11/cant-transform-my-reflectable-flyweight.html#comments">comments</a>, I am ready.<br /><br />I am still exploring approaches to the <a href="https://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight Pattern</a> for <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. I have already more or less settled on a simple reflection approach, but am exploring code annotations for marking concrete flyweight classes, which is where Reflectable enters the story. And almost exited yesterday—until Sigurd told me that Reflectable currently requires an overridden dependency on the analyzer package.<br /><br />So I add the appropriate <code>dependency_overrides</code> entry to my <code>pubspec.yaml</code> file:<pre class=prettyprint>name: flyweight_code<br />dependencies:<br />  reflectable: any<br />dependency_overrides:<br />  analyzer: '0.26.1+14'<br />transformers:<br />- reflectable:<br />    entry_points:<br />      - bin/coffee_orders.dart<br />    formatted: true</pre>With that... everything works. My code builds without issue:<pre class=prettyprint>$ pub build --mode=debug bin          <br />Loading source assets... <br />Loading reflectable transformers... <br />Building flyweight_code... (3.8s) <br />[Info from Dart2JS]:<br />Compiling flyweight_code|bin/coffee_orders.dart...<br />[Info from Dart2JS]:<br />Took 0:00:04.819196 to compile flyweight_code|bin/coffee_orders.dart.<br />[Info from Dart2JS]:<br />Compiling flyweight_code|bin/coffee_orders_reflectable_original_main.dart...<br />[Info from Dart2JS]:<br />Took 0:00:01.456035 to compile flyweight_code|bin/coffee_orders_reflectable_original_main.dart.<br />Built 589 files to "build".</pre>The compiled code is compact:<pre class=prettyprint>$ ls -lh build/bin/coffee_orders.dart*<br />-rw-r--r-- 1 chris chris 5.0K Nov 24 00:17 build/bin/coffee_orders.dart<br />-rw-r--r-- 1 chris chris 100K Nov 24 00:17 build/bin/coffee_orders.dart.js</pre>By way of comparison, the same code based on the built-in <code>dart:mirrors</code> library was nearly 300K the <a href="http://japhr.blogspot.com/2015/11/impact-of-reflection-on-annotations-in.html">other night</a>. Sure, I am still compiling 5K of Dart into 100K of JavaScript, but that's a nearly 66% improvement. <br /><br />Of course, what matters most is that the code actually work, which it does. Running the compiled JavaScript in Node results in my usual coffee shop output:<pre class=prettyprint>$ node build/bin/coffee_orders.dart.js<br />Served Cappuccino to Fred.<br />Served Espresso to Bob.<br />Served Frappe to Alice.<br />Served Frappe to Elsa.<br />Served Coffee to null.<br />Served Coffee to Chris.<br />Served Mochachino to Joy.<br />-----<br />Served 7 coffee drinks.<br />Served 5 kinds of coffee drinks.<br />For a profit of: $27.2<br /></pre>The verdict here is that Reflectable is a huge win all around. The minor, temporary issue of a out-of-sync dependency aside, Reflectable is simply better than <code>dart:mirrors</code>. The resulting generated code is smaller. It is <a href="http://japhr.blogspot.com/2015/11/impact-of-reflection-on-annotations-in.html">easier to build</a>. From my perspective, the biggest win is that it makes my code much cleaner.<br /><br />To find classes annotated with the custom <code>@flavor</code> annotation in <code>dart:mirrors</code>, I had to traverse libraries and declarations. It was ugly:<pre class=prettyprint><code>  static Map _allDeclarations = currentMirrorSystem().<br />      libraries.<br />      values.<br />      fold({}, (memo, library) => memo..addAll(library.declarations));<br /><br />  static Map classMirrors = _allDeclarations.<br />    keys.<br />    where((k) => _allDeclarations[k] is ClassMirror).<br />    where((k) =><br />      _allDeclarations[k].metadata.map((m)=> m.type.reflectedType).contains(Flavor)<br />    ).<br />    fold({}, (memo, k) => memo..[k]= _allDeclarations[k]);</code></pre>The equivalent code with Reflectable is mercifully easy to read:<pre class=prettyprint><code>  static Map classMirrors = flavor.<br />    annotatedClasses.<br />    fold({}, (memo, c) => memo..[c.simpleName]= c);</code></pre>The Reflectable <code>@flavor</code> annotation just knows the classes that it annotates. What could be easier?<br /><br />That said, I am not sold on annotations as the best approach to concrete flyweight classes in Dart. I may try my original, not-annotated solution again—but with Reflectable. It could be that Reflectable is optimized for annotations, but other cases still work equally or more well in <code>dart:mirrors</code>. I will find out with at least one other case. Tomorrow.<br /><br /><br /><span style="color: #ccc">Day #12</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/cant-transform-my-reflectable-flyweight.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/HSxHq5Il5KI" height="1" width="1" alt=""/>
