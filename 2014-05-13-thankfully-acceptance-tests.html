---
title: 'Thankfully, Acceptance Tests'
layout: post
published: '2014-05-13T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/cHDmIDgCZoY/thankfully-acceptance-tests.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - testing

---

<div class=top-chain-links></div><br />I may have a solution to the problem of how best to introduce MVC in <a href="http://dart4hipsters.com/">Dart for Hipsters</a>.<br /><br />I am in the process of another rewrite and have found—thanks to some super helpful errata reports—that things are amiss in the chapter that introduces MVC. Unfortunately, this is an important chapter, so problems in it are more worrisome than in other chapters. It is the bridge chapter between intro-to-Dart material and really putting Dart through its paces. But if this chapter is wonky, the chapters that fully explore Dart's power are harder to understand—or worse, the reader gets frustrated and drops the book altogether. So I need to fix this.<br /><br />Last night's proposed solution looks something like this:<pre class=prettyprint>main() {<br />  var comics_view, comics_collection;<br /><br />  comics_collection = new ComicsCollection(<br />    onChange: ()=> comics_view.render()<br />  );<br />  comics_view = new ComicsView(<br />    el: document.query('#comics-list'),<br />    collection: comics_collection<br />  );<br />  comics_collection.fetch();<br /><br />  // ...<br />}</pre>Clearly, things can be improved, but that's rather the point of a middle-of-the-book chapter. The <code>onChange</code> callback hints at callback hell that will never arise thanks to Darts awesome streams. Still, it ought to make some sense to the reader—when the collection changes, the view needs to re-render. The view is attached to an element with the same comic book “collection.” The collection is a collection of models. I have views, collections and models—an MVC-like solution. <br /><br />What I like most about this solution is that it works (always important)—I can run this application code in a browser to add and remove comic books from a REST-like backend:<br /><br /><a href="http://3.bp.blogspot.com/-Rv89UMcShB4/U3LhkDkxkaI/AAAAAAAAZHQ/uwhlLIzcVc0/s1600/01-worky_dart_comix_cb_hell.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-Rv89UMcShB4/U3LhkDkxkaI/AAAAAAAAZHQ/uwhlLIzcVc0/s400/01-worky_dart_comix_cb_hell.png" /></a><br /><br />So tonight, I set out to fix my tests. Surely my test must be failing because I removed a bunch of event-based code that was the source of many an errata. And indeed they are failing, but only because I changed the code location. Once the tests are updated to reference the new location of the MVC code, everything passes:<pre class=prettyprint>➜  code git:(master) ✗ ./test_runner.sh<br />CONSOLE MESSAGE: PASS: [skeleton] the skeleton app returns OK<br />CONSOLE MESSAGE: PASS: [main] the app returns OK<br />CONSOLE MESSAGE: PASS: [main] populates the list<br />CONSOLE MESSAGE: PASS: [numbers] 2 + 2 = 4<br />...<br />CONSOLE MESSAGE: PASS: [canvas] player is drawn<br />CONSOLE MESSAGE:<br />CONSOLE MESSAGE: All 163 tests passed.<br /><br />Static type analysis...<br />Analyzing test.dart... <br /><br />Looks good!<br /></pre>My first reaction to all of my tests passing is that of the great Frozone: “Aw, now that ain't right.”<br /><br />It turns out that my tests are more of the acceptance test variety:<pre class=prettyprint><code>    test('populates the list', (){<br />      Main.main();<br />      expect(el.innerHtml, contains('Sandman'));<br />    });</code></pre>In other words, the tests are less brittle than unit tests which might have tested the under-the-covers implementation. To make sure that I am not seeing a false positive, I intentionally choose an invalid expectation, which causes my test to fail:<pre class=prettyprint>CONSOLE MESSAGE: FAIL: [main] populates the list<br />  Expected: contains 'Sandmän'<br />    Actual: '      &lt;li id="cd46d1d0-b420-11e3-a31b-29d8b92ba7e6"><br />'<br />    '        Sandman<br />'   <br />    '        (Neil Gaiman)<br />'   <br />    '        &lt;a class="delete">[delete]&lt;/a><br />'   <br />    '      &lt;/li>'<br /></pre>To leave the code a little better than I found it, I opt to write another test. This one will click on the add-comic element, fill out the form for a Superman comic, submit the form, and expect that the Superman comic is now included on the list:<pre class=prettyprint><code>    group('adding', (){<br />      setUp((){<br />        Main.main();<br />        query('#add-comic').click();<br />        query('input[name=title]').value = 'Superman';<br />        query('input[value="Create!"]').click();<br />      });<br /><br />      test('populates the list', (){<br />        expect(el.innerHtml, contains('Superman'));<br />      });<br />    });</code></pre>That does not quite work because I am not allowing for form submission and page-update-on-success. To accommodate those, I add a small delay to the setup block:<pre class=prettyprint><code>    group('adding', (){<br />      setUp((){<br />        Main.main();<br />        query('#add-comic').click();<br />        query('input[name=title]').value = 'Superman';<br />        query('input[value="Create!"]').click();<br /><br /><b>        var completer = new Completer();<br />        new Timer(<br />          new Duration(milliseconds: 20),<br />          completer.complete<br />        );<br />        return completer.future;</b><br />      });<br /><br />      test('populates the list', (){<br />        expect(el.innerHtml, contains('Superman'));<br />      });<br />    });</code></pre>If this were written with <code>scheduled_test</code>, I could make that a little prettier, but it is not horrible as is. Returning a future from <code>setUp()</code> tells unittest that it should wait for the future to complete before running any tests in the group. In this case, I complete the completer after a simple 20 milliseconds delay. With that, I have 164 passing tests and assurance that the proposed code changes to the MVC chapter are behaving as needed.<br /><br />So I seem to be in pretty good shape. Now I just need to adapt my narrative to fit the new code…<br /><br /><br /><span style="color: #ccc">Day #62</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/05/rethinking-introductions-to-event.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/05/bug-potpourri-as-new-dart-approaches.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/cHDmIDgCZoY" height="1" width="1"/>
