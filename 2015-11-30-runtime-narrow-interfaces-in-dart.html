---
title: 'Runtime Narrow Interfaces in Dart'
layout: post
published: '2015-11-30T22:57:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/RWoYDdAGz4k/runtime-narrow-interfaces-in-dart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - memento

---

<div class=top-chain-links></div><br />My memento has a wide interface. I continue to work with the <a href="https://en.wikipedia.org/wiki/Memento_pattern">memento pattern</a> in <a href="http://dartlang.org">Dart</a>. The initial implementation went well, but the devil is in the details. <br /><br />The details in this case come in the form of implementation item #1 from the <a href="http://en.wikipedia.org/wiki/Design_Patterns">Gang of Four book</a>, which suggest that only the originator class should have access to the properties of the memento object. As I found last night, that is not an easy thing to do in Dart. There is no concept of <a href="https://en.wikipedia.org/wiki/Friend_class">friend classes</a> in Dart. There is not even an easy way to obtain the caller of a function to determine access.<br /><br />In the end, I hacked a caller into the memento object in my example code by examining the stacktrace of a thrown exception. There is no world in which that is a good idea, so tonight, I try to do a little better. Since neither the requirements nor the limitations have changed, I have to try an alternate approach. And I think it all has to be done at runtime.<br /><br />The originator class in my example is the <code>VeletFogMachine</code>, which plays various songs from the late, great Mel Tormé. The memento class is <code>Playing</code>, which the caretaker context can use to replay previous songs. Again, the caretaker should not be able to access any song information—only supply the <code>Playing</code> memento to the originator so that it can be handled properly.<br /><br />What I come up with is a runtime secret, supplied to by the <code>VelvetFogMachine</code>:<pre class=prettyprint>class Playing {<br />  Song _song;<br />  double _time;<br />  double _secret;<br /><br />  // Narrow interface for the world<br />  Playing();<br /><br />  // Wide interface for the VelvetFogMachine<br />  Playing.forTheVelvetFogMachine(this._song, this._time, this._secret);<br />  // ...<br />}</pre>This named constructor suggests that it only works with the <code>VelvetFogMachine</code>. In reality, it is possible to use it from outside that context, but it ought to feel really strange to just about anyone.<br /><br />The secret supplied to the constructor can then be used to check access to a particular method, like the <code>secretSong()</code> method:<pre class=prettyprint>class Playing {<br />  // ...<br />  Song secretSong(double secret) {<br />    // Runtime check for access<br />    _checkAccess(secret, #secretSong);<br />    return _song;<br />  }<br />  // ...<br /><br />  _checkAccess(secret, memberName) {<br />    if (secret == _secret) return;<br /><br />    throw new NoSuchMethodError(this, memberName, [secret], {});<br />  }<br />}</pre>The secret itself has to come from the <code>VelvetFogMachine</code> originator class and it has to be private to that class so that no other classes can get access:<pre class=prettyprint>import 'dart:math';<br />final rand = new Random(1);<br /><br />// The "Originator"<br />class VelvetFogMachine {<br />  Song currentSong;<br />  double currentTime;<br />  final double _secret = rand.nextDouble();<br />  // ...<br /><br />  // Create a memento of the current state<br />  Playing get nowPlaying {<br />    // Simulate playing at some time later:<br />    var time = 5*rand.nextDouble();<br /><br />    return new Playing.forTheVelvetFogMachine(currentSong, time, _secret);<br />  }<br />  // ...<br />}</pre>That works. The original code continues to function properly when used inside the originator:<pre class=prettyprint>class VelvetFogMachine {<br />  // ...<br />  void backTo(Playing p) {<br />    print("  *** Whoa! This was a good one, let's hear it again :) ***");<br />    _play(p.secretSong(_secret), p.secretTime(_secret));<br />  }<br />}</pre>Furthermore, the caretaker code is unable to access the <code>secretSong()</code> method:<pre class=prettyprint>List&lt;Playing> replayer = [];<br /><br />  var scatMan = new VelvetFogMachine();<br />  // ...<br /><br />  scatMan.play(<br />      'New York, New York Medley',<br />      'A Vintage Year'<br />  );<br />  replayer.add(scatMan.nowPlaying);<br />  // ...<br /><br />  // This should not work:<br />  try {<br />    print("Caretaker says last remembered song is: ${replayer.last.secretSong(0.0)}");<br />  }<br />  on NoSuchMethodError {<br />    print("Yay! Caretaker was denied access to the memento song.");<br />  }</code></pre>This results in the <code>NoSuchMethodError</code> output:<pre class=prettyprint>$ ./bin/play_melvie.dart                                       <br />...<br />Playing New York, New York Medley // A Vintage Year @ 0.00<br />Playing The Lady is a Tramp // The Velvet Frog: The Very Best of Mel Tormé @ 0.00<br />  *** Whoa! This was a good one, let's hear it again :) ***<br />Playing New York, New York Medley // A Vintage Year @ 4.60<br /><br />Yay! Caretaker was denied access to the memento song.</pre>So this works, but it is an awful lot of work and there are still ways around it. Still, unless someone has a suggestion, I will likely stick with this as the best approach to narrowing the interface of the memento when discussing in <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>.<br /><br /><i>Play with this code on DartPad: <a href="https://dartpad.dartlang.org/a1971dcad8f0466d7cfe">https://dartpad.dartlang.org/a1971dcad8f0466d7cfe</a></i><br /><br /><br /><span style="color: #ccc">Day #19</span>  <br /><br /><p class=bottom-chain-links><a href="https://japhr.blogspot.com/2015/11/making-friends-in-dart.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2015/12/dart-has-friend-class-baked-in.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/RWoYDdAGz4k" height="1" width="1" alt=""/>
