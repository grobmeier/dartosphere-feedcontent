---
title: '@MirrorsUsed'
layout: post
published: '2014-07-01T23:57:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/4ILH5AXMCJ0/mirrorsused.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - mirrors

---

<div class=top-chain-links></div><br /><a href="http://dartlang.org">Dart</a> mirrors have been trying to distract me from my task of late. Tonight, I finally give into the distraction—if only for a little while.<br /><br />My task remains to begin to understand what questions I need to ask in order to do a proper job with <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. Toward that end, I have been poking and prodding the <a href="http://en.wikipedia.org/wiki/Factory_method_pattern">Factory Method</a> pattern as best I can. This has ranged from the classic subclass approach, to mirrors and benchmarking.<br /><br />Along the way, I have seen the following more than once:<pre class=prettyprint>This import is not annotated with @MirrorsUsed, which may lead to unnecessarily large generated code.<br />Try adding '@MirrorsUsed(...)' as described at <a href="https://goo.gl/Akrrog">https://goo.gl/Akrrog</a>.</pre>So tonight I see if following this advice does result in smaller code.<br /><br />I compile my <code>benchmark.dart</code> code to JavaScript with:<pre class="prettyprint">$ dart2js -o tool/benchmark.dart.js tool/benchmark.dart</pre>Without the <code>@MirrorsUsed</code> annotation I find that the resulting JavaScript code is very much on the large side:<pre class=prettyprint>$ ls -lh tool/benchmark.dart.js                        <br />-rw-r--r-- 1 chris chris <b>1.6M</b> Jul  1 22:36 tool/benchmark.dart.js</pre>Let's see if <code>@MirrorsUsed</code> makes a difference. At first I do not read <a href="https://api.dartlang.org/apidocs/channels/stable/dartdoc-viewer/dart:mirrors.MirrorsUsed">the documentation</a> closely enough, and place the annotation above the class definition. This results in no change in the warnings nor the resulting JavaScript size. <br /><br />Upon better reading, I realize that I need to place the annotation above the <code>import</code> of the mirrors package:<pre class=prettyprint>library factory_method_mirror;<br /><br /><b>@MirrorsUsed(symbols: 'productMaker', override: '*')<br />import 'dart:mirrors';</b><br /><br />abstract class Creator { /* ... * }<br />abstract class Product {}<br />class ConcreteCreator extends Creator { /* ... */ }<br />class ConcreteProduct extends Product {}</pre>With that, I recompile with the same <code>dart2js</code> command and find:<pre class=prettyprint>$ dart2js -o tool/benchmark.dart.js tool/benchmark.dart<br />$ ls -lh tool/benchmark.dart.js                        <br />-rw-r--r-- 1 chris chris <b>171K</b> Jul  1 23:46 tool/benchmark.dart.js</pre>That is a <i>huge</i> improvement.<br /><br />Unfortunately, my guess at the annotation's arguments appears to have been wrong. My benchmark code no longer runs:<pre class=prettyprint>node tool/benchmark.dart.js<br />Factory Method — Subclass(RunTime): 0.09522241981403347 us.<br />Factory Method — Map of Factories(RunTime): 4.226399783608331 us.<br /><br /><b>/home/chris/repos/design-patterns-in-dart/factory_method/tool/benchmark.dart.js:1930<br />      throw H.wrapException(P.UnsupportedError$("Cannot find class for: " + H.<br />              ^<br />Unsupported operation: Cannot find class for: ConcreteProduct0<br />    at dart.wrapException (/home/chris/repos/design-patterns-in-dart/factory_method/tool/benchmark.dart.js:829:15)</b><br />    ...</pre><strike>Unfortunately, I am stumped here.</strike><br /><br />Eventually, I figure out that I need to supply <code>ConcreteProduct</code> as a target of mirroring. In my full Factory Method mirror implementation, it looks like:<pre class=prettyprint><b>@MirrorsUsed(targets: 'ConcreteProduct')</b><br />import 'dart:mirrors';<br /><br />abstract class Creator {<br />  Type productClass;<br />  Product productMaker() {<br />    return reflectClass(productClass).<br />      newInstance(const Symbol(''), []).<br />      reflectee;<br />  }<br />}<br /><br />abstract class Product {}<br /><br />class ConcreteCreator extends Creator {<br />  Type productClass = ConcreteProduct;<br />}<br /><br /><b>class ConcreteProduct extends Product {}</b></pre>I can understand why this works and why it is implemented. Even so, it is a bit of a concern.<br /><br />The target of a <code>@MirrorUsed</code> annotation is how I identify to <code>dart2js</code> that a particular class might be mirrored. As such, even if normal tree shaking does not see this class used, dart2js knows that it still needs to include the class in the resulting output.<br /><br />The problem that I see is that the implementation that I have been using for the Factory Method is that of a framework. The mirror code (inside the abstract <code>Creator</code>) would reside in the framework package while the concrete implementations would reside in separate codebases. The implication is that my framework has no way of knowing which concrete classes will be defined so it certainly cannot contain a <code>@MirrorsUsed</code> annotation. At the same time, it is the only place mirrors are actually used (the concrete class supplies a type, but does no reflection). So I would seem to have a catch-22 on my hands.<br /><br />Except that there are other options for <code>@MirrorsUsed()</code> that might help. I will pick back up with them tomorrow. For now, I have working mirror code compiled into much smaller JavaScript. That is enough of a win for one day.<br /><br /><br /><span style="color: #ccc">Day #109</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/06/benchmarking-dart-and-dart2js-code-in.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/4ILH5AXMCJ0" height="1" width="1"/>
