---
title: 'Still, Still, Still Can''t Test Keyboard Events in Dart (Still)'
layout: post
published: '2014-09-24T23:57:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/eAG4cqZNEAo/still-cant-test-dart-keyboard-events-still.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - testing

---

<div class=top-chain-links></div><br />I have spent <a href="http://japhr.blogspot.com/2013/08/keyboard-event-support-remains-rough-in.html">a</a> <a href="http://japhr.blogspot.com/2013/08/keyidentifier-and-other-arcane-keyboard.html">lot</a> <a href="http://japhr.blogspot.com/2013/10/keyevents-are-for-unit-tests.html">of</a> <a href=" http://japhr.blogspot.com/2013/08/hacking-cross-browser-support-of.html">time</a> <a href="http://japhr.blogspot.com/2013/09/again-i-cannot-generate-keyboard-events.html">trying</a> <a href="http://japhr.blogspot.com/2013/08/intentionally-sloppy-outside-in-test.html">to</a> <a href="http://japhr.blogspot.com/2013/06/still-cant-dynamically-create-keyboard.html">test</a> <a href="http://japhr.blogspot.com/2013/08/keyname-is-key-name-in-dart.html">keyboard</a> <a href="http://japhr.blogspot.com/2013/06/dynamically-creating-keyboard-events-in.html">events</a> <a href="http://japhr.blogspot.com/2013/10/trying-to-figure-out-what-i-can-test.html">in</a> <a href="http://japhr.blogspot.com/2013/05/bdd-dart-menu.html">Dart</a>. <a href="http://japhr.blogspot.com/2013/06/manually-cleaning-up-dart-stream.html">A</a> <a href="http://japhr.blogspot.com/2013/08/better-but-still-not-great-keyboard.html">lot</a> <a href="http://japhr.blogspot.com/2013/11/still-cant-keyevent-in-dart.html">of</a> <a href="http://japhr.blogspot.com/2013/10/bleeding-edge-dart-key-events.html">time</a>. And all with no success. Until last night.<br /><br />As a side note, there is a school of thought that says that you cannot really know a language until you know its weaknesses. I generally have a tough time thinking of these on the spot so I keep a few in my proverbial back pocket. For the longest time, my greatest <a href="http://dartlang.org">Dart</a> annoyance has been the inability to create (and thus test) custom keyboard events. If this ever gets 100% fixed, I am going to have to think long and hard for other Dart foibles. <br /><br />Assuming that my woes really are fixed.<br /><br />Sadly, last night's solution is likely not an indicator that all is well. I had previously been unsuccessful in generating <code>TextInput</code> events in <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> elements, so when it worked last night, I though this astounding. It turns out that I <a href="http://japhr.blogspot.com/2013/06/dart-testing-with-lots-of-events.html">have been testing</a> with <code>TextInput</code> events for a while. A bunch of tests in the <a href="https://github.com/eee-c/ice-code-editor">ICE Code Editor</a> still rely on these to generate useful results.<br /><br />But I might as well try the keyboard events again. It has been a while. In the ICE Code Editor, we have acceptance tests that read like:<pre class=prettyprint><code>      test("down arrow key moves forward in list", (){<br />        helpers.typeCtrl('O');<br />        helpers.typeIn('project 1');<br /><br />        // project 11<br />        // project 10 *<br />        // project 1<br /><br />        helpers.arrowDown(2);<br /><br />        expect(<br />          document.activeElement.text,<br />          equals('Project 10')<br />        );<br />      });</code></pre>If I hate Dart's keyboard event support, I love its tests. This test says that I:<ol><li>type Ctrl+O to open the Open Project dialog</li><li>type in “project 1” to filter all projects that contain that substring (the three that we have are included in comments)</li><li>Hit the down arrow key twice</li></ol>After that, the expectation is that the active menu item will be “project 10.”<br /><br />Ideally, a test like that would use keyboard events for just about all of that. Is the letter “o” pressed with the Control key modifier? On keyup in the project filter input, change the list of projects. On keyup when the key is an arrow key, move the active element up or down. But none of those tests actually use keyboard events. Some get away with <code>TextInput</code> events. Some, like the <code>arrowDown()</code> helper function, use absolutely awful hacks:<pre class=prettyprint>arrowDown([times=1]) {<br />  // var e = new KeyEvent('keydown', keyCode: KeyCode.DOWN).wrapped;<br /><b>  var fake_button = document.query('#fake_down_key');<br />  if (fake_button == null) return;</b><br /><br />  new Iterable.generate(times, (i) {<br />    // document.activeElement.dispatchEvent(e);<br /><b>    fake_button.click();</b><br />  }).toList();<br />}<br /></pre>Instead of using keyboard events, I use a fake input field. Awful.<br /><br />The reason the keyboard events do not work? Because Dart does not populate the <code>keyCode</code> property of the event being dispatched. This tends to make dispatching such events useless, hence the awful hack.<br /><br />To see if thing have changed, I remove the hacks and reinstate the keyboard event code:<pre class=prettyprint>arrowDown([times=1]) {<br />  var e = new KeyEvent('keydown', keyCode: KeyCode.DOWN).wrapped;<br />  new Iterable.generate(times, (i) {<br />    document.activeElement.dispatchEvent(e);<br />  }).toList();<br />}</pre>The <a href="https://api.dartlang.org/apidocs/channels/stable/dartdoc-viewer/dart-dom-html.KeyEvent">KeyEvent</a> class is the only way to add character data to keyboard events in Dart. Its <code>wrapped</code> property gives me the usual keyboard event for dispatch. The documentation for <code>KeyEvent</code> looks suspiciously unchanged and indeed, running this test still fails:<pre class=prettyprint><code>CONSOLE MESSAGE: FAIL: Keyboard Shortcuts Open Projects Dialog down arrow key moves forward in list<br />  Expected: 'Project 10'<br />    Actual: ''<br />     Which: is different. Both strings start the same, but the given value is missing the following trailing characters: Project 10 ...</code></pre>Dang.<br /><br />The suggested use of KeyEvents in the documentation is of no use to me in tests. I would have to create a Stream wrapper around this particular input field <i>inside</i> the application code, but somehow expose it outside the application so my test could add events to that stream. That might be acceptable if I had a single stream that I needed to expose for testing, but I have dozens.<br /><br />So it seems the hack must remain. On the bright side, I still have a ready answer for something about Dart that I dislike. Actually, that is not much of a bright side.<br /><br /><br /><span style="color: #ccc">Day #193</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/09/verifying-polymerdart-fix-with-text.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/09/polymer-and-angular-dart-are-wildly.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/eAG4cqZNEAo" height="1" width="1"/>
