---
title: 'Unboxing Packages: A Requiem for scheduled_test'
layout: post
published: '2017-06-14T14:19:00-07:00'
feed: 'Dart News & Updates'
link: 'https://news.dartlang.org/2017/06/unboxing-packages-requiem-for.html'
author:
    name: 'Natalie Weizenbaum'
    email: noreply@blogger.com
    url: 'http://www.blogger.com/profile/17561686962317321958'
tags:
    - 'Unboxing Packages'

---

<p>Long long ago in the dawning days of Dart, when <code>Future</code>s were new and <code>Stream</code>s unknown, <a href="https://github.com/munificent">Bob</a> saw the need for a package manager to bring the people together. Together he and I spun formless bits into code and wove that code into <a href="https://pub.dartlang.org/">pub</a>, which even today carries code into the eager hands of Dartisans. In those olden days, we had no modern marvels such as the twins <code>async</code> and <code>await</code>, and our tests grew heavy and graceless under the weight of their <code>chain()</code>s<a href="#fn:1" id="fnref:1" title="See footnote" class="footnote"><sup>1</sup></a>.</p> <p>So it was that I came up with an idea for a new way of writing tests. Instead of gluing the steps together with the cumbersome <code>Future</code> API, each step would register an asynchronous callback in a queue. Once all the steps were queued up, the library would run them in order. All the API boilerplate would be hidden away from the user, and the tests would look <a href="https://github.com/dart-lang/pub/blob/85fc22001f8293793fa714ef9dbded16544cc1c2/test/pub_lish_test.dart#L53-L59">nice and clean</a>. After honing this technique on pub‚Äôs tests, I brought it out into its own package, which I called <a href="https://pub.dartlang.org/packages/scheduled_test"><code>scheduled_test</code></a>.</p> <p>If this whole idea of queuing up tasks and running them later sounds complicated, that‚Äôs because it was. <code>scheduled_test</code> did a great job of pushing complexity away from test cases, but in return any infrastructure that ran those test cases got much more complex. You couldn‚Äôt just write normal Dart code, you had to make sure to wrap everything in <code>schedule()</code> and allow users to pass in <code>Future</code>s and all sorts of hassle. I had created a better sort of tests, but not one without flaws.</p>   <h2 id="the-beginning-of-the-end">The Beginning of the End</h2> <p>Then in Dart 1.9, support for <code>async</code> and <code>await</code> landed and completely changed the equation. No longer did asynchronous APIs have to involve a mess of nesting and callbacks‚Äîeven the most <code>Future</code>-heavy tests were free to look like plain old synchronous code with some extra keywords sprinkled on top. The driving purpose of <code>scheduled_test</code>, making asynchronous tests look simple and comprehensible, was now supported by the language itself.</p> <p>You may then wonder, why didn‚Äôt <code>scheduled_test</code> fade into obscurity and disuse fifteen Dart versions ago? You may ask, ‚ÄúNatalie, when you created the new <a href="https://pub.dartlang.org/packages/test"><code>test</code> package</a>, why did you decide to use <code>scheduled_test</code> when it no longer had a purpose?‚Äù The answer to these questions is <em>infrastructure</em>.</p> <p>Over the years we had built up a number of APIs around the core functionality of <code>scheduled_test</code>, and even when that functionality got less relevant the APIs that used it were very useful. We couldn‚Äôt migrate old code until we had a good replacement, and even for new code <code>scheduled_test</code> was still the best option for testing files and subprocesses.</p>   <h2 id="the-final-blow">The Final Blow</h2> <p>This year<a href="#fn:2" id="fnref:2" title="See footnote" class="footnote">2</a>, one of my goals was to finally rid the world of <code>scheduled_test</code> once and for all. This meant buckling down and replacing all the infrastructure we‚Äôd built on it over the years with new packages that use nothing more than <code>dart:async</code> and the base <code>test</code> API. It took a lot of work, but I did it. I‚Äôm pleased to say that <a href="https://github.com/dart-lang/pub/pull/1629">pub no longer uses <code>scheduled_test</code></a>, <a href="https://github.com/dart-lang/test/pull/634">nor does <code>test</code></a>. These were <code>scheduled_test</code>‚Äôs biggest users, and they serve as a proof-of-concept for the suitability of its replacements:</p> <ul><li><p>The <code>scheduled_test/descriptor</code> library, which provided a simple and readable API for creating and validating files and directories, is replaced by the <a href="https://pub.dartlang.org/packages/test_descriptor"><code>test_descriptor</code></a> package.</p></li><li><p>The <code>scheduled_test/scheduled_process</code> library, which wrapped <code>dart:io</code>‚Äôs <code>Process</code> library to provide better debugging and easier line-by-line access to the standard IO streams, is replaced by the <a href="https://pub.dartlang.org/packages/test_process"><code>test_process</code></a> package.</p></li><li><p>The <code>scheduled_test/scheduled_stream</code> library provided a pull-based API for streams which has been replaced by the <code>async</code> package‚Äôs <a href="https://www.dartdocs.org/documentation/async/1.13.3/async/StreamQueue-class.html"><code>StreamQueue</code></a> class, and the stream matchers have been replaced by <a href="https://github.com/dart-lang/test#stream-matchers">a suite of matchers</a> in <code>test</code> itself.</p></li><li><p>The <code>scheduled_test/scheduled_server</code> library, which provided a server that validates and handles individual requests, has been moved to the <a href="https://pub.dartlang.org/packages/shelf_test_handler"><code>shelf_test_handler</code></a> package.</p></li><li><p>The core of <code>scheduled_test</code> may be going away, but it had a few useful features that I salvaged. The <code>test</code> package can now <a href="https://www.dartdocs.org/documentation/test/latest/test/printOnFailure.html">print a message only when a test fails</a> and <a href="https://www.dartdocs.org/documentation/test/latest/test/addTearDown.html">add tear-downs at runtime</a>, both of which were originally supported in <code>scheduled_test</code> only.</p></li></ul> <p>I hope these APIs can be used more widely now that they‚Äôre no longer tangled up with <code>scheduled_test</code>. In fact, I encourage you to try them out right away if they seem useful‚Äîor write your own libraries if they don‚Äôt!</p> <div class="footnotes"><hr><ol><li id="fn:1">Fun fact: <code>Future.then()</code> used to be called <code>Future.chain()</code>! <a href="#fnref:1" title="Return to article" class="reversefootnote">‚Ü©</a></li><li id="fn:2">Excluding April and parts of March and May, when I was out recovering from surgery. I‚Äôm doing great, thanks for asking! üòä <a href="#fnref:2" title="Return to article" class="reversefootnote">‚Ü©</a></li></ol></div>
