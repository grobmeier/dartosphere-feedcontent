---
title: 'Building a reactive FPS Counter in Dart'
layout: post
published: '2017-05-01T02:24:36+00:00'
feed: 'Stories by Matan Lurey on Medium'
link: 'https://medium.com/@matanlurey/building-a-reactive-fps-counter-in-dart-5f7c0177289e?source=rss-abdbfcd4679f------2'
author:
    name: 'Matan Lurey'
    email: null
    url: null
tags:
    - game-development
    - javascript
    - dartlang
    - reactive-programming
    - functional-programming

---

<p>As an example of how to build FRP (<a href="https://en.wikipedia.org/wiki/Functional_reactive_programming"><em>functional-reactive program[s]</em></a>) in Dart, I decided to try building an FPS counter — that is, an utility to determine what the frame rate of a running application is.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*QUkCJdrV24CKRYOlYOMyVg.png" /><figcaption>The end result after building <strong>package:fps</strong>.</figcaption></figure><p>I decided I’d like to have a few goals:</p><ol><li>The library, hereby <em>package:fps</em>, should be platform agnostic. That is, I didn’t want to require the use of the browser (<em>requestAnimationFrame</em>) — it should work also in the <a href="https://www.dartlang.org/dart-vm/tools/dart-vm">standalone command-line VM</a> and <a href="https://flutter.io/">Flutter</a>.</li><li>I wanted it to be extensible — it should be relatively trivial to get the average FPS over a duration of time so the number doesn’t spike back and forth while running.</li><li>I wanted to be able to specify a <em>target</em> FPS (say <em>60</em>), and be able to dynamically change that target if it’s clear the application won’t be able to perform.</li></ol><p>Here’s what I wanted my API to look like:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/72cc0057b2d1ef2f6bb6533ff4b9b965/href">https://medium.com/media/72cc0057b2d1ef2f6bb6533ff4b9b965/href</a></iframe><p>Determining frames-per-second means I want to check, at sporadic moments in my application, how long it’s been since I last was able to check. Assume the following:</p><ul><li>Rendering is normally measured in seconds, or how many frames fit</li><li>1000 milliseconds (ms) is one second</li><li>Time it takes to render a frame is the difference between two timestamps</li><li>We can start with emitting a timestamp every “frame”</li></ul><blockquote>In Dart, which is single-threaded and based on an event loop, we’ll assume that if we can get control of the event loop at least once every &lt;duration&gt; (idle time) that all previous work was effectively the frame.</blockquote><p>I tried implementing it rather naively — I created a new <em>StreamController</em>, and used <em>Future.delayed (</em>which delegates to a <em>Timer</em> on all platforms) to inform when the next frame is:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/4d23f21a682398c97cdcf38b7bbc3819/href">https://medium.com/media/4d23f21a682398c97cdcf38b7bbc3819/href</a></iframe><blockquote><strong>Note:</strong> This is not always accurate — on web specifically we can do this much better with <em>window.animationFrame</em>, but again, I wanted something that would run cross-platform out of the box.</blockquote><p>OK, so instead of adding the <em>timestamp</em>, I need to calculate and output the <em>frames per second. </em>I could have done this inline, but instead to make it yet-more-extensible I’ve implemented it via a simple <a href="https://api.dartlang.org/stable/1.23.0/dart-async/StreamTransformer-class.html"><em>StreamTransformer</em></a><em>, </em>which is code I can use <a href="https://www.dartlang.org/articles/libraries/creating-streams#transforming-an-existing-stream">on-top of any <em>Stream</em> via <em>transform</em></a>:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/cd3ce75ea96ca0a289c43480a9f51a40/href">https://medium.com/media/cd3ce75ea96ca0a289c43480a9f51a40/href</a></iframe><p>I now get output something like this:</p><blockquote>60<br>60<br>60<br>60<br>60<br>60<br>60<br>60<br>60</blockquote><p>Looks good! I’ve <a href="https://github.com/matanlurey/fps">included the source code and an example repo on github</a>.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=5f7c0177289e" width="1" height="1">
