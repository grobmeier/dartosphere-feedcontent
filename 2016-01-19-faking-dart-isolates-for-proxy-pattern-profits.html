---
title: 'Faking Dart Isolates for Proxy Pattern Profits'
layout: post
published: '2016-01-19T22:48:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/kYYfGIsGk3Y/faking-dart-isolates-for-proxy-pattern.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - 'proxy pattern'

---

<div class=top-chain-links></div><br />Perhaps the best answer is "not."<br /><br />I have been struggling with how best to present <a href="https://api.dartlang.org/1.13.2/dart-isolate/dart-isolate-library.html">isolates</a> (isolated workers) as a remote <a href="https://en.wikipedia.org/wiki/Proxy_pattern">proxy pattern</a> vehicle. As of last night, I think I have the bare minimum of what I can do in my <a href="http://dartlang.org">Dart</a> code. It's good—functional, well named, proper—but still complex enough that it would distract from the main discussion.<br /><br />So what if I get rid of isolates altogether? Well, for one thing, I likely would not <i>really</i> need a remote proxy pattern implementation. The main function could speak directly to the worker function without required go-betweens like send and receive ports. For the sake of argument and illustration, let's stipulate that there is a requirement for main and worker functions to speak only over streams. <br /><br />I start by replacing the isolate / send-port / receive-post dance with two stream controllers in <code>main()</code>—one for sending messages to the worker function, the other for receiving messages from the worker:<pre class=prettyprint>main() async {<br />  var mainOut = new StreamController.broadcast(),<br />      mainIn = new StreamController.broadcast();<br />  // ...<br />}</pre>Next, I create a remote <code>ProxyCar</code> instance, supplying these two stream controllers for communication with the real subject (which will reside in the <code>worker()</code> function):<pre class=prettyprint>main() async {<br />  var mainOut = new StreamController.broadcast(),<br />      mainIn = new StreamController.broadcast();<br /><br />  // Create proxy car with send/receive streams<br />  ProxyCar car = new ProxyCar(mainOut, mainIn);<br />  // ...<br />}</pre>This requires two minor changes to the <code>ProxyCar</code> declaration, neither of which should really affect ease of understanding. First, the <code>_in</code> and <code>_out</code> instance variables become <code>StreamController</code>s instead of <code>ReceivePort</code> and <code>SendPort</code>. Second, I need to listen on the <code>StreamController</code>'s <code>stream</code> instead of directly on the <code>StreamController</code> object:<pre class=prettyprint>class AsyncCar implements AsyncAuto {<br />  StreamController _out, _in;<br /><br />  AsyncCar(this._out, this._in) {<br />    _in.stream.listen((message) {<br />      print("[AsyncCar] $message");<br />      if (message == #drive) _car.drive();<br />      if (message == #stop)  _car.stop();<br />      _out.add(state);<br />    });<br />  }<br />  // Proxied methods remain unchanged...<br />}</pre>Back in <code>main()</code>, I also sent the <code>mainOut</code> and <code>mainIn</code> stream controllers to the worker:<pre class=prettyprint><code>  // Start "worker"<br />  worker(mainIn, mainOut);</code></pre>Inside the <code>worker()</code> function, these two arguments are mirrors of the arguments in <code>main()</code>—<code>mainIn</code> in <code>main()</code> is <code>workerOut</code> inside <code>worker()</code>:<pre class=prettyprint>worker(StreamController workerOut, StreamController workerIn) {<br />  new AsyncCar(workerOut, workerIn);<br />}</pre>The <code>AsyncCar</code> class requires the same minor <code>StreamController</code> changes that I made to <code>ProxyCar</code>, but the actual functionality remains unchanged from the isolate version of the code.<br /><br />And that does the trick. Back in <code>main()</code>, I can invoke the usual vehicle methods on the <code>ProxyCar</code> and those requests are forwarded onto the real <code>AsyncCar</code> in <code>worker()</code>:<pre class=prettyprint>main() async {<br />  var mainOut = new StreamController.broadcast(),<br />      mainIn = new StreamController.broadcast();<br /><br />  ProxyCar car = new ProxyCar(mainOut, mainIn);<br />  worker(mainIn, mainOut);<br /><br />  await car.drive();<br />  print("Car is ${car.state}");<br /><br />  print("--");<br /><br />  await car.stop();<br />  print("Car is ${await car.state}");<br />}</pre>Along with some debugging code inside the car classes, this code produces the following output:<pre class=prettyprint>$ ./bin/drive.dart                          <br />[AsyncCar] Symbol("drive")<br />[ProxyCar] driving<br />Car is driving<br />--<br />[AsyncCar] Symbol("stop")<br />[ProxyCar] idle<br />Car is idle<br /></pre>I like that. The example is certainly contrived, but experienced Dartisans will recognize where this can go while folks new to the language should not be completely lost. Once the main discussion is done, I would then be free to show a quick code transformation into an isolate—or even a web socket—solution.<br /><br /><i>And best of all is that this approach can be seen on DartPad: <a href="https://dartpad.dartlang.org/7cc9f080e49939ac4cad">https://dartpad.dartlang.org/7cc9f080e49939ac4cad</a>.</i><br /><br /><br /><span style="color: #ccc">Day #69</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2016/01/a-naming-convention-for-dart-isolate.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2016/01/driving-cars-with-websockets.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/kYYfGIsGk3Y" height="1" width="1" alt=""/>
