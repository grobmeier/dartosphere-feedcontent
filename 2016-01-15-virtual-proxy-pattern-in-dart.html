---
title: 'Virtual Proxy Pattern in Dart'
layout: post
published: '2016-01-15T22:48:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/hEg-ApFFJlw/virtual-proxy-pattern-in-dart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - 'proxy pattern'

---

<div class=top-chain-links></div><br />Tonight I look at the virtual flavor of the <a href="https://en.wikipedia.org/wiki/Proxy_pattern">proxy pattern</a>. The Java example on Wikipedia seems a fine place to start. Hopefully this works better than the remote-in-<a href="http://dartlang.org">Dart</a>-isolates flavor of the past few days. <br /><br />I start with the <code>Image</code> interface, which declares that all classes that implement it will sport a <code>displayImage()</code> method:<pre class=prettyprint>abstract class Image {<br />  void displayImage();<br />}</pre>For this simple example, the <code>RealImage</code> class will have print-to-stdout placeholder methods for actions. The real image needs to be able to load itself from the filesystem when constructed and to display itself when required:<pre class=prettyprint>class RealImage implements Image {<br />  String _filename;<br /><br />  RealImage(this._filename) {<br />    _loadImageFromDisk();<br />  }<br /><br />  void _loadImageFromDisk() {<br />    print("Loading    $_filename");<br />  }<br /><br />  void displayImage() {<br />    print("Displaying $_filename");<br />  }<br />}</pre>That is simple enough, but it is a nice part of the example. This real subject of the pattern performs an expensive operation when created (or it pretends to). In this case, <code>RealImage</code> loads a large image file from the filesystem. <br /><br />The project subject, on the other hand, delays expensive operations a long as possible. When created, it stores a reference to the <code>_filename</code>, but only constructs the real image when it has to—when the image needs to display:<pre class=prettyprint>class ProxyImage implements Image {<br />  RealImage _image;<br />  String _filename;<br /><br />  ProxyImage(this._filename);<br /><br />  void displayImage() {<br />    _image ??= new RealImage(_filename);<br />    _image.displayImage();<br />  }<br />}</pre>The assign-if-null operator (<code>??=</code>) in <code>displayImage()</code> also maintains a reference to the real image should the image need to be displayed a second time.<br /><br />That is all there is to the basic, virtual proxy. The "virtual" in the name comes from the behavior of the proxy subject—it is very close to behaving in the same manner as the real subject. Aside from the on-demand nature, the two are nearly the same.<br /><br />And this works as expected. The following main entry point into the code:<pre class=prettyprint>main() {<br />  Image image1 = new ProxyImage("HiRes_10MB_Photo1");<br />  Image image2 = new ProxyImage("HiRes_10MB_Photo2");<br /><br />  image1.displayImage(); // loading necessary<br />  image1.displayImage(); // loading unnecessary<br />  image2.displayImage(); // loading necessary<br />  image2.displayImage(); // loading unnecessary<br />  image1.displayImage(); // loading unnecessary<br />}</pre>Produces the following output:<pre class=prettyprint>$ ./bin/display_images.dart             <br />Loading    HiRes_10MB_Photo1<br />Displaying HiRes_10MB_Photo1<br />Displaying HiRes_10MB_Photo1<br />Loading    HiRes_10MB_Photo2<br />Displaying HiRes_10MB_Photo2<br />Displaying HiRes_10MB_Photo2<br />Displaying HiRes_10MB_Photo1</pre>I will probably make a go of implementing that for real tomorrow. To better simulate a real image gallery, I might first use a nearly zero-cost blank image:<pre class=prettyprint>final BlankImage = new RealImage("blank");</pre>The proxy can display that immediately, then load a not-too-much-higher-cost low resolution version of the image before finally displaying the real thing:<pre class=prettyprint>class ProxyImage implements Image {<br />  // ...<br />  void displayImage() {<br />    if (_image != null) return _image.displayImage();<br /><br />    print("[ProxyImage] cache miss $_filename");<br />    BlankImage.displayImage();<br />    new RealImage(_lowFilename)..displayImage();<br />    _image = new RealImage(_filename)..displayImage();<br />  }<br /><br />  String get _lowFilename =><br />    _filename.replaceFirst(new RegExp(r'HiRes_\d+\w+_'), 'LoRes_');<br />}</pre>Running that now produces:<pre class=prettyprint>[ProxyImage] cache miss HiRes_10MB_Photo1<br />Loading    blank<br />Displaying blank<br />Loading    LoRes_Photo1<br />Displaying LoRes_Photo1<br />Loading    HiRes_10MB_Photo1<br />Displaying HiRes_10MB_Photo1<br />Displaying HiRes_10MB_Photo1<br />[ProxyImage] cache miss HiRes_10MB_Photo2<br />Displaying blank<br />Loading    LoRes_Photo2<br />Displaying LoRes_Photo2<br />Loading    HiRes_10MB_Photo2<br />Displaying HiRes_10MB_Photo2<br />Displaying HiRes_10MB_Photo2<br />Displaying HiRes_10MB_Photo1</pre>Each low resolution image is loaded only once, acting as a second (though more helpful) placeholder after the initial blank image. But once the full resolution image is available, it is used going forward. I will give that a go with real images tomorrow. For now...<br /><br /><i>Play with the code on DartPad: <a href="https://dartpad.dartlang.org/22ba8996f50d61cea887">https://dartpad.dartlang.org/22ba8996f50d61cea887</a>.</i><br /><br /><br /><span style="color: #ccc">Day #65</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2016/01/cleaning-up-that-dart-isolate-mess.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2016/01/a-real-virtual-proxy-pattern.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/hEg-ApFFJlw" height="1" width="1" alt=""/>
