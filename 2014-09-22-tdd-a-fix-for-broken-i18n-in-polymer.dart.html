---
title: 'TDD a Fix for Broken i18n in Polymer.dart'
layout: post
published: '2014-09-22T23:57:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/xhNhQ9UHs40/tdd-fix-for-broken-i18n-in-polymerdart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />I think my <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> element is broken. Somewhere in the various upgrades to Polymer.dart, the internationalization project code for <a href="http://patternsinpolymer.com/">Patterns in Polymer</a> stopped working. It sure would have been nice had my continuous integration server been working when that happened, but I can only change the future. <br /><br />The problem is not that localization does not work at all. When I specify the locale with an attribute (<code>&lt;hello-you locale="fr">&lt;hello-you></code>), it localizes just fine:<br /><br /><a href="http://1.bp.blogspot.com/-E3YgdcWWJGY/VCDmW7aNYbI/AAAAAAAAfe8/PoX-ttH0koQ/s1600/01-twice_localized.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-E3YgdcWWJGY/VCDmW7aNYbI/AAAAAAAAfe8/PoX-ttH0koQ/s400/01-twice_localized.png" /></a><br /><br />The problem occurs when changing locales with the drop-down menu. Specifically, the labels for the element remain in the original locale when the drop-down changes:<br /><br /><a href="http://2.bp.blogspot.com/-PRcE5EUUB-E/VCDnUnYeiHI/AAAAAAAAffE/UHOff2MUsQs/s1600/02-not_changing_locale.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-PRcE5EUUB-E/VCDnUnYeiHI/AAAAAAAAffE/UHOff2MUsQs/s400/02-not_changing_locale.png" /></a><br /><br />Since I can only change the future, I refuse to allow this to happen to me again. I will have tests that catch this problem. The needs for such tests is that much more important by virtue of the code already failing once.<br /><br />Before jumping into writing the test case for my failure, I start with a simpler case. I know that specifying the locale via published Polymer attribute works, so I start with a test for that:<pre class=prettyprint><code>    test('starts in French', (){<br />      schedule((){<br />        expect(_el.shadowRoot.text, contains('Bonjour'));<br />      });<br />    });</code></pre>The <code>schedule()</code> comes from the <a href="https://pub.dartlang.org/packages/scheduled_test">scheduled_test</a>, which is a testing package for readable asynchronous tests built on top of unittest. This schedule is guaranteed to come after any schedules in the test setup, which can be quite helpful.<br /><br />Helpful perhaps, but it does not solve all problems. This test fails:<pre class=prettyprint>FAIL: &lt;hello-you locale="fr"/> (French) starts in French<br />  Caught ScheduleError:<br />  | Expected: contains 'Bonjour'<br />  |   Actual: '\n'<br />  |   '    \n'<br />  |   '      Hello \n'<br />  |   '    \n'</pre>The test itself is sound. The problem winds up being in the setup of my test:<pre class=prettyprint><code>    setUp((){<br />      schedule(()=> Polymer.onReady);<br /><br />      schedule((){<br />        var _completer = new Completer();<br />        _el = createElement('&lt;hello-you locale="fr">&lt;/hello-you>');<br />        document.body.append(_el);<br /><br /><b>        _el.async((_){ _completer.complete(); });</b><br /><br />        return _completer.future;<br />      });<br />    });<br />    // ...<br />  });</code></pre>There are two schedules in my setup. One waits until the Polymer library itself is ready. The second one waits for this particular element is ready. A Polymer element is really ready when it updates its bound variables and renders. Polymer normally does this when appropriate, but it is possible to encourage this to happen <a href="http://japhr.blogspot.com/2014/03/ok-polymer-why-500ms.html">immediately with <code>async()</code></a>. So the second schedule tells my Polymer element to update its bound variables, draw itself, then invoke the supplied callback which completes the schedule's completer.<br /><br />Normally, this is enough when testing Polymer elements. But in this case, completing the completer when the element is ready is not sufficient. I also have to wait a few milliseconds for the JSON localization files to load and apply to the Polymer element:<pre class=prettyprint><code>      schedule((){<br />        var _completer = new Completer();<br />        _el = createElement('<hello-you locale="fr"></hello-you>');<br />        document.body.append(_el);<br /><br /><b>        _el.async((_){<br />          // wait for l10n to be loaded<br />          new Timer(<br />            new Duration(milliseconds: 50),<br />            ()=> _completer.complete()<br />          );<br />        });</b><br /><br />        return _completer.future;<br />      });</code></pre>In all likelihood this a Polymer code smell. The complexity of this test setup is probably trying to tell me that my custom element should itself expose a future that completes when all localization data is loaded. I table that for the moment as I would like to focus on the task at hand.<br /><br />With the additional wait time, my element now renders both French and Spanish versions:<pre class=prettyprint>CONSOLE MESSAGE: PASS: &lt;hello-you locale="fr"/> (French) starts in French<br />CONSOLE MESSAGE: PASS: &lt;hello-you locale="es"/> (Spanish) starts in Spanish</pre>Perhaps this is all I need for my switching code?<br /><br />Well, no. Even with the delay, a test for changing the locale still fails:<pre class=prettyprint><code>    test('defaults to English', (){<br />      schedule((){<br />        expect(_el.shadowRoot.text, contains('Hello'));<br />      });<br />    });<br /><br /><b>    test('can localize to French', (){<br />      schedule(()=> _el.locale = 'fr');<br />      schedule((){<br />        expect(_el.shadowRoot.text, contains('Bonjour'));<br />      });<br />    });</b></code></pre>The text inside the Polymer element remains English, which is not too surprising. I have only written new test code so far, not made code changes.<br /><br />So what is the actual problem? Eventually, I realize that the <code>&lt;hello-you></code> element and its translation strategy element, <code>&lt;x-translate></code> do not seem to be communicating via the bound variables that they share:<pre class=prettyprint>&lt;polymer-element name="hello-you"><br />  &lt;template><br />    &lt;!-- ... --><br /><b>    &lt;x-translate id="l10n"<br />                 locale={{locale}}<br />                 labels={{labels}}>&lt;/x-translate></b><br />  &lt;/template><br />  &lt;script type="application/dart" src="hello_you.dart">&lt;/script><br />&lt;/polymer-element></pre>I know that the properties are set correctly—otherwise my working tests would not be working—it is possible set the locale once via attribute, just not update them. Wait…<br /><br />I know this. In fact I <a href="http://japhr.blogspot.com/2014/09/updating-published-polymer-attributes.html">just ran into this</a> in the JavaScript version of Polymer. The solution there was to mark a Polymer element's property as published and reflectable. I know how to do that in JavaScript, but what about Dart?<br /><br />The answer is <code>@PublishedProperty</code>. Instead of declaring <code>locale</code> as just published:<pre class=prettyprint>@CustomTag('x-translate')<br />class XTranslate extends PolymerElement {<br /><b>  @published String locale = 'en';</b><br />  // ...<br />}</pre>I need to instead declare it as a published property whose value is reflected in the attribute whenever a change is made:<pre class=prettyprint>@CustomTag('x-translate')<br />class XTranslate extends PolymerElement {<br /><b>  @PublishedProperty(reflect: true)<br />  String locale = 'en';</b><br />  // ...<br />}</pre>With that, I have my element changing locales in response to drop-down menu changes:<br /><br /><a href="http://2.bp.blogspot.com/-BjJjs3gUbRo/VCDufX66XlI/AAAAAAAAffU/xVtOV3TU0Ek/s1600/03-woring-en.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-BjJjs3gUbRo/VCDufX66XlI/AAAAAAAAffU/xVtOV3TU0Ek/s400/03-woring-en.png" /></a><br /><br />More importantly, I now have 5 passing tests to ensure that this never again breaks without my knowledge:<pre class=prettyprint>CONSOLE MESSAGE: PASS: &lt;hello-you/> (i18n) defaults to English<br />CONSOLE MESSAGE: PASS: &lt;hello-you/> (i18n) can localize to French<br />CONSOLE MESSAGE: PASS: &lt;hello-you/> (i18n) can localize to Spanish<br />CONSOLE MESSAGE: PASS: &lt;hello-you locale="fr"/> (French) starts in French<br />CONSOLE MESSAGE: PASS: &lt;hello-you locale="es"/> (Spanish) starts in Spanish<br />CONSOLE MESSAGE: <br />CONSOLE MESSAGE: All 5 tests passed.</pre>This “reflectable” property stuff is starting to get on my nerves. This is at least the third time that its behavior has surprised me. Maybe someday I will expect the actual behavior. Until then, I have tests verifying that I have correctly written my code for my desired behavior. <br /><br /><br /><span style="color: #ccc">Day #191</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/09/pub-as-simple-test-server.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/09/verifying-polymerdart-fix-with-text.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/xhNhQ9UHs40" height="1" width="1"/>
