---
title: 'More Dart Testing of JavaScript Polymer Elements'
layout: post
published: '2014-06-20T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/UBF1ae9MYoE/more-dart-testing-of-javascript-polymer.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - javascript
    - polymer
    - testing

---

<div class=top-chain-links></div><br />I finally got so fed up with JavaScript testing frameworks last night that I did something truly silly. I started testing my JavaScript with <a href="http://dartlang.org">Dart</a>.<br /><br />I begin to despair of the state of testing in JavaScript. It seems that no matter how much progress is made, testing new things will always be prohibitively hard. The ever growing number of JavaScript testing frameworks and runners do a fair job of facilitating known coding domains, but stray too far from the known and… ick.<br /><br />The ick last night came in the form if a simple <a href="http://www.polymer-project.org/">Polymer</a> element, <code>&lt;apply-author-styles></code>. This element copies CSS from the main page into other Polymer elements—the idea being that native elements inside these other Polymer elements should look like native elements on the page. The actual test is ridiculously easy: add a <code>&lt;style></code> to the page, insert <code>&lt;apply-author-styles></code> into test element, and verify that the same <code>&lt;style></code> is now part of the test element's shadow DOM.<br /><br />Four days ago I made the mistake of starting a post exploring this test with the questions, “how hard can it be?”<br /><br />Well, <a href="http://karma-runner.github.io">Karma</a> can not handle it because there is no way to alter the test page to insert a <code>&lt;style></code> tag (at least not without resorting to JavaScript which won't work on this element). It turns out that grunt-contrib-jasmine will not work either, mostly because its browser is incompatible with Polymer.<br /><br />I have no doubt that there is a test runner / test framework out there that is capable of the job, but I have no desire to spend my days building on an already too familiar knowledge of so many JavaScript testing frameworks. Life is too damn short.<br /><br />So last night, I gave up and used Dart. And it just worked. I am not going to claim that Dart is the end solution for all JavaScript testing, but it worked in this case and not without good reason. The default implementation is embedded in a Chrome variant so both Dart and JavaScript code should work. Dart has an <i>excellent</i> built-in testing framework and runner. So it seemed worth a try and I was rewarded. That said, there are still a couple of outstanding questions.<br /><br />First up, is why does the test pass in <code>content_shell</code>, but not in Dartium? As mentioned above, the test is simple enough: I define a page style that includes orange button borders, include <code>&lt;apply-author-styles></code> to a test fixture tag <code>&lt;x-foo></code>, then test:<pre class=prettyprint><code>  group("[styles]", (){<br />    test('the app returns OK', (){<br />      var xFoo = query('x-foo');<br />      expect(xFoo.shadowRoot.text, contains('orange'));<br />    });<br />  });</code></pre>Isn't that a pretty test? I find the <code>&lt;x-foo></code> tag on the test page and set my expectation that its shadow root contains “orange.” This works fine in <code>content_shell</code>, the headless testing version of Dartium:<pre class=prettyprint>CONSOLE MESSAGE: unittest-suite-wait-for-done<br />CONSOLE MESSAGE: PASS: [styles] the app returns OK<br />CONSOLE MESSAGE: <br />CONSOLE MESSAGE: All 1 tests passed.<br />CONSOLE MESSAGE: unittest-suite-success<br />CONSOLE WARNING: line 213: PASS</pre>But fails in Dartium proper:<pre class=prettyprint>unittest-suite-wait-for-done<br />ERROR: [styles] the app returns OK<br />  Test failed: Caught The null object does not have a getter 'text'.<br />  <br />  NoSuchMethodError: method not found: 'text'<br />  Receiver: null<br />  Arguments: []<br />  dart:core-patch/object_patch.dart 45                                                                                       Object.noSuchMethod<br />  test.dart 22:30 </pre>It seems that my test <code>&lt;x-foo></code> element simply does not have a <code>shadowRoot</code>. Since it is null, calling <code>text</code> on it raises an exception. But why?<br /><br />If I inspect the actual element on the page, it really does not have a shadow DOM:<br /><br /><a href="http://4.bp.blogspot.com/-2tVEvMg3VbU/U6T5fW2Z_yI/AAAAAAAAbMs/HSosFi42AVc/s1600/01-no_shadow_dome.png" imageanchor="1" ><img border="0" src="http://4.bp.blogspot.com/-2tVEvMg3VbU/U6T5fW2Z_yI/AAAAAAAAbMs/HSosFi42AVc/s400/01-no_shadow_dome.png" /></a><br /><br />Compare the same element as seen on Chrome 35:<br /><br /><a href="http://1.bp.blogspot.com/-weY9UtSJkOM/U6T5fc1ylNI/AAAAAAAAbMw/WfKL-_wMZBY/s1600/02-with_shadow_root.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-weY9UtSJkOM/U6T5fc1ylNI/AAAAAAAAbMw/WfKL-_wMZBY/s400/02-with_shadow_root.png" /></a><br /><br />In the JavaScript console settings for Dartium, the “Show Shadow DOM” setting is enabled and yet… no shadow DOM. And I cannot figure out why. My best guess is that the version of Chromium (34) against with Dartium is built lacks some native functionality that Polymer would otherwise use. Lacking that, it places the element directly in the light DOM which works visually, but breaks my test.<br /><br />I am a little concerned that <code>content_shell</code> works differently than Dartium. Interestingly, it reports a really old Chrome version in the <code>navigator.userAgent</code> property:<pre class=prettyprint>"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) <b>Chrome/19.77.34.5</b> (Dart) Safari/537.36"</pre>I may have to report that. For now, I am content that it behaves like it ought to behave.<br /><br />To prove that it is not all sunshine and roses, I still need to deal with some impedance mismatch between Dart and JavaScript. Specifically, the project is laid out like a <a href="http://bower.io">Bower</a> project, not a Dart project. This forces me manually symlink a bunch of things in the test directory:<pre class=prettyprint>➜  apply-author-styles git:(master) ✗ ls -l test<br />total 28<br />drwxr-xr-x 2 chris chris 4096 Jun 19 23:37 apply-author-styles<br />lrwxrwxrwx 1 chris chris   29 Jun 19 23:32 core-ajax -> ../bower_components/core-ajax<br />lrwxrwxrwx 1 chris chris   39 Jun 19 23:32 core-component-page -> ../bower_components/core-component-page<br />-rw-r--r-- 1 chris chris  634 Jun 19 23:49 index.html<br />lrwxrwxrwx 1 chris chris   11 Jun 19 23:37 packages -> ../packages<br />lrwxrwxrwx 1 chris chris   28 Jun 19 23:32 platform -> ../bower_components/platform<br />lrwxrwxrwx 1 chris chris   27 Jun 19 23:32 polymer -> ../bower_components/polymer<br />-rw-r--r-- 1 chris chris  773 Jun 20 23:07 test.dart<br />-rwxr-xr-x 1 chris chris  292 Jun 20 22:18 test_runner.sh<br />-rw-r--r-- 1 chris chris  300 Jun 19 23:44 x-foo.html<br /></pre>Crazy as it might seem, I am still using <a href="http://gruntjs.com/">Grunt</a> to manage the test run (mostly for the simple, static web server). Thankfully, it includes symlink and clean tasks. So I install those:<pre class=prettyprint>$ npm install grunt-contrib-symlink --save-dev<br />$ npm install grunt-contrib-clean --save-dev</pre>Then I load those tasks in my <code>Gruntfile.js</code>:<pre class=prettyprint>module.exports = function(grunt) {<br />  grunt.initConfig({<br />    // ...<br />  });<br /><br />  grunt.loadNpmTasks('grunt-contrib-watch');<br /><b>  grunt.loadNpmTasks('grunt-contrib-symlink');</b><br />  grunt.loadNpmTasks('grunt-shell');<br />  grunt.loadNpmTasks('grunt-contrib-connect');<br /><b>  grunt.loadNpmTasks('grunt-contrib-clean');</b><br /><br />  grunt.registerTask('default', ['symlink:test_files', 'connect', 'shell:test', 'clean:test_files']);<br />};</pre>Also in there, I start my default testing task with a new <code>symlink:test_files</code> task and end with a <code>clean:test_files</code> task. Configuration of both is fairly easy thanks to the nice documentation:<pre class=prettyprint>module.exports = function(grunt) {<br />  // Project configuration.<br />  grunt.initConfig({<br />    pkg: grunt.file.readJSON('package.json'),<br />    // ...<br /><b>    symlink: {<br />      test_files: {<br />        files: [<br />          {<br />            expand: true,<br />            overwrite: true,<br />            cwd: 'bower_components',<br />            src: ['*'],<br />            dest: 'test'<br />          }<br />        ]<br />      }<br />    },<br />    // ...<br />    clean: {<br />      test_files: ['test/core-*', 'test/platform', 'test/polymer']<br />    }</b><br />  });<br />  // ...<br />  grunt.registerTask('default', ['symlink:test_files', 'connect', 'shell:test', 'clean:test_files']);<br />};<br /></pre>That cleans things up fairly nicely. Now when I run my default <code>grunt</code> command, it starts by creating the necessary symbolic links, runs the static server, then the tests, and finally cleans everything up after itself.<br /><br />Unfortunately, this leaves me in a state of using NPM, Grunt, Bower, <i>and</i> Dart on this very simple Polymer element. It might be worth investigating replacing Grunt/NPM with something like Hop in Dart. But I leave that for another day.<br /><br /><br /><span style="color: #ccc">Day #99</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/06/testing-javascript-polymers-with-dart.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/06/dart-factory-method-pattern.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/UBF1ae9MYoE" height="1" width="1"/>
