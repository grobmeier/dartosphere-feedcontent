---
title: 'Compile Time Constant Factory Method'
layout: post
published: '2014-06-26T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/kvNHIYU4iVI/compile-time-constant-factory-method.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - 'factory method pattern'
    - typedef

---

<div class=top-chain-links></div><br />Tonight I continue to poke and prod the first design pattern destined for <a href="http://designpatternsindart.com">Design Patterns in Dart</a>...<br /><br />I really like yesterday's map-of-factories approach to the <a href="http://en.wikipedia.org/wiki/Factory_method_pattern">Factory Method</a> pattern in <a href="http://dartlang.org">Dart</a>. The approach, first <a href="http://japhr.blogspot.com/2014/06/dart-mirrors-for-better-factor-method.html#comments">suggested to me</a> by Vadim Tsushko removes the immediate responsibility of Factory Methods from subclasses of the creator class and instead places them in a Map of factories. I think I may have left some room for improvement though...<br /><br />The classic Factory Method pattern starts with an abstract creator class that includes an abstract creator method:<pre class=prettyprint>abstract class Creator {<br />  Product productMaker();<br />  // ...<br />}</pre>The <code>Product</code> is similarly abstract—the concrete subclass of <code>Product</code> is deferred to the concrete subclass of <code>Creator</code>. Leaving the <code>productMaker()</code> method abstract says just that: the subclass needs to define a <code>productMaker()</code> method that returns a subclass of <code>Product</code>:<pre class=prettyprint>class ConcreteCreator extends Creator {<br />  productMaker()=> new ConcreteProduct();<br />}</pre>Yesterday's variation does away with the creator subclass, which is quite nice if the factory method is the only reason to define a subclass. Instead, the top-level creator class now looks up the factory method in a simple Map:<pre class=prettyprint>typedef Product productFactory();<br />class Creator {<br />  static Map&lt;Type, productFactory> factory = new Map();<br />  Product productMaker(type) => factory[type]();<br />  // ...<br />}<br /></pre>Here, I <code>typedef</code> a function that takes no arguments and returns some kind of concrete <code>Product</code> (just like the original <code>productMaker()</code> factory method). The static <code>factory</code> map is then a key/value store in which the keys are types and the values are product factories. <br /><br />Either approach (subclass or map-of-factories) will work as a Factory Method implementation. I have yet to benchmark the two. In the absence of that admittedly useful information, the choice between the two comes down to context or personal preference. In the web MVC framework example that I used yesterday, it probably makes more sense to use the subclass approach as I have to create subclasses anyway and the map-of-factories was a little awkward. If the concrete classes are all part of the same codebase or if a parallel class hierarchy needs factories, then the map-of-factories approach seems the better approach.<br /><br />I do not want to dwell on those question too much just yet. Instead, I am wondering if including the map-of-factories in the creator class is the right approach. Perhaps this was just the codebase upon which I was experimenting last night, but it felt a little messy having it in the same class.<br /><br />Instead, I would like an entirely separate <code>Factory</code> class to hold this information. Something along the lines of:<pre class=prettyprint>typedef Product productFactory();<br />class Factory {<br />  static Map&lt;Type, productFactory> factory = new Map();<br />}</pre>So I give that a try in my <a href="https://github.com/eee-c/hipster-mvc">Hipster MVC</a> (abstract creator and product) and <a href="https://github.com/eee-c/dart-comics">Dart Comics</a>  (concrete creator and product) codebases. In Hipster MVC, the <code>HipsterCollection</code> class had served as the abstract creator, creating <code>HipsterModel</code> objects from attributes fetched via a RESTful backend. Last night it got the map-of-factories treatment. Tonight, I move that out into a separate <code>Factory</code> class:<pre class=prettyprint>typedef HipsterModel modelMaker(Map attrs);<br /><br />class Factory {<br />  static Map<Type, modelMaker> factory = new Map();<br />}</pre>This works just fine. <code>HipsterCollection</code> is now capable of creating concrete instances of <code>HipsterModel</code> (e.g. <code>ComicBook</code> from Dart Comics) using this <code>Factory</code>:<pre class=prettyprint>class HipsterCollection extends IterableBase {<br />  // ...<br />  HipsterModel modelMaker(attrs) => Factory.factory[this.runtimeType](attrs);<br />  // ...<br />}</pre>But you know what? <code>Factory.factory</code> looks ugly. It would be much cooler if that were just:<pre class=prettyprint><code>  HipsterModel modelMaker(attrs) => <b>Factory[this.runtimeType]</b>(attrs);</code></pre>Unfortunately operators, like the square bracket lookup operator, cannot be static:<pre class=prettyprint>class _Factory {<br />  static Map&lt;Type, modelMaker> factory = new Map();<br /><br /><b>  // This won't work!!!<br />  static operator [](type) => factory[type];</b><br />}</pre>I know this does not work because I try it out only to get a nice little exception:<pre class=prettyprint>Internal error: 'package:hipster_mvc/hipster_factory.dart': error: line 11 pos 19: operator overloading functions cannot be static<br />  static operator [](type) => factory[type];</pre>Bah!<br /><br />All is not lost… as long as I am willing to resort to some compile time constant chicanery. And of course I am more than willing. I rename the <code>Factory</code> class as <code>_Factory</code> and declare a compile time constant of <code>Factory</code> which of type <code>_Factory</code>:<pre class=prettyprint>_Factory Factory = const _Factory();<br /><br />class _Factory {<br />  static Map&lt;Type, modelMaker> factory = new Map();<br /><br />  const _Factory();<br />  operator [](type) => factory[type];<br />  operator []=(type, function) { factory[type] = function; }<br />}<br /></pre>Which does the trick, though it feels a little dirty. Dirty because I declare a compile-time <i>constant</i> whose sole purpose is to store changing key-value pairs. But it works because the instance variable <code>factory</code> fails on the <code>_Factory</code> instance which leaves Dart to fall back on static variable lookup.<br /><br />And it is at this point that I realize that, yes, I am an idiot.<br /><br />Because I have gone to all of this effort even though an empty <code>HashMap</code> is also a compile time constant. So the <code>_Factory</code> class and <code>Factory</code> compile time constant can be replaced with:<pre class=prettyprint>typedef HipsterModel modelMaker(Map attrs);<br />Map&lt;Type, modelMaker> Factory = {};<br /></pre>Well, that was a long way to go to wind up with a simple <code>HashMap</code> lookup. <br /><br />Ah well, maybe that <code>const</code> + static method trick will come in handy some day. Stranger things have happened.<br /><br />But for today, I have my map-of-factories in better shape with an extremely small amount of code. Demonstrating publicly that I'm a dummy is a small price to pay for that!<br /><br />Tomorrow: benchmarking.<br /><br /><br /><br /><span style="color: #ccc">Day #104</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/06/a-map-of-factories-for-factory-method.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/kvNHIYU4iVI" height="1" width="1"/>
