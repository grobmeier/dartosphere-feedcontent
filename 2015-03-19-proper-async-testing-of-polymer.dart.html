---
title: 'Proper (Async) Testing of Polymer.dart'
layout: post
published: '2015-03-19T00:24:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/moe8AwIaQyM/proper-async-testing-of-polymerdart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - polymer
    - testing

---

<div class=top-chain-links></div><br />I have this test. It's not even really a test. It's not making assertions about my very simple <code>&lt;hello-you></code> element. It just verifies that <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> is working correctly. It even works when run in <a href="http://www.dartlang.org/dartium/">Dartium</a>:<br /><br /><a href="http://2.bp.blogspot.com/-CEGC94n9Zdc/VQo_DAlSkSI/AAAAAAAAnq8/WW13zEr957U/s1600/01-polymer_0_16_test_works_in_dartium.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-CEGC94n9Zdc/VQo_DAlSkSI/AAAAAAAAnq8/WW13zEr957U/s320/01-polymer_0_16_test_works_in_dartium.png" /></a><br /><br />Buy my very simple test does not work in headless testing. Stranger still is that it used to work. But in the latest development version of <a href="http://dartlang.org">Dart</a> (1.9.0-dev.10.7) and the latest Polymer.dart (0.16.0+3), my simple test will not work headless. <br /><br />Well, I <i>think</i> it is not working. When I run the test in <code>content_shell</code>, which is nomrally the easiest way to headless test in Dart, I get nothing:<pre class=prettyprint>$ content_shell --dump-render-tree ./test/index.html <br />...<br /><br />#EOF<br />#EOF<br />#EOF<br /></pre>So what is going wrong here? Is the development version of Dart buggy? Is the newly released Polymer.dart to blame? Is <code>content_shell</code> not longer a good solution for headless testing? The answer is almost certainly that I am doing something wrong, but what?<br /><br />The actual test that I got working in Dartium last night seems harmless enough:<pre class=prettyprint>import 'package:unittest/unittest.dart';<br />import 'package:unittest/html_config.dart';<br />import 'package:polymer/polymer.dart';<br /><br />main() {<br />  useHtmlConfiguration();<br /><br />  initPolymer();<br />  Polymer.onReady.then((_) {<br />    // Setup to add the element to the page here...<br /><br />    group("&lt;hello-you>", (){<br />      test("has a shadowRoot", (){<br />        expect(<br />          query('hello-you').shadowRoot,<br />          isNotNull<br />        );<br />      });<br />    });<br />  });<br />}</pre>I import unittest, a unittest HTML formatter, and Polymer. I use the HTML formatter, initialize Polymer, and, as I found last night, I have to wait for Polymer to be ready before making my assertions. In the browser, this works. My <code>&lt;hello-you></code> element has a <a href="http://www.polymer-project.org/platform/shadow-dom.html">Shadow DOM</a> like all web components should. But for whatever reason, there is not even any output from <code>content_shell</code>.<br /><br />It does little good to whine about the problem. So I start breaking it down. Do simple tests work from <code>content_shell</code>? Let's try testing my sanity:<pre class=prettyprint>main() {<br />  useHtmlConfiguration();<br /><br />  test("sanity", (){<br />    expect(1 + 1, 2);<br />  });<br />  // Polymer tests below...<br />}</pre>Surprisingly, that works:<pre class=prettyprint>content_shell --dump-render-tree ./test/index.html<br />...<br />PASS<br />1       PASS<br />Expectation: sanity .<br /><br />All 1 tests passed<br />#EOF<br />#EOF<br />#EOF<br /></pre>It works, but… why does this new test count as “All 1 tests”? I did not delete the Polymer test. It is not even seeing it. Wait…<br /><br />Ah, the joys of asynchronous testing. It is super nice that Dart has facilities built-in for elegant asynchronous testing, but it sure would be nice if it would tell you when you're doing something wrong. The problem in this case is nothing in my test is blocking the browser from exiting. I have a <code>Future</code> waiting around to execute if <code>Polymer.onReady</code> ever completes. But for all <code>content_shell</code> knows, this will never complete.<br /><br />I have to instruct my tests that this is an asynchronous operation. More to the point, I have to find a way to instruct the test runner to block until this asynchronous function is called when <code>Polymer.onReady</code> completes. This is the purview of <code>expectAsync()</code>.<br /><br />The <code>expectAsync()</code> method is a simple wrapper around a function that does just what I need—it blocks the test runner until the expected asynchronous function is called. The more immediate help for me is that <code>content_shell</code> now knows to wait for this asynchronous test to be invoked. <br /><br />Since <code>expectAsync()</code> is a test matcher, it needs to reside inside a <code>test()</code>. So I have to rearrange my test such that the <code>expectAsync()</code> for <code>Polymer.onReady()</code> is inside the <code>test()</code>:<pre class=prettyprint><code>  group("&lt;hello-you>", (){<br />    var _el;<br />    setUp((){<br />      _el = createElement('&lt;hello-you>&lt;/hello-you>');<br />      document.body.append(_el);<br />    });<br /><br />    tearDown((){<br />      _el.remove();<br />    });<br /><br />    test("has a shadowRoot", (){<br /><b>      Polymer.onReady.then(expectAsync((_) {</b><br />        expect(<br />          query('hello-you').shadowRoot,<br />          isNotNull<br />        );<br />      }));<br />    });<br />  });</code></pre>That seems like the kind of thing that might make for a nice Polymer.dart test matcher. I may root around to see if one is already defined in Polymer itself. It would be <i>really</i> nice if something in unittest were able to identify this kind of problem. I have definitely seen this before—and probably should have recognized the symptoms sooner. But it would be nice not to have to worry about missing this in the future. Perhaps a better solution is to switch to the better async-supporting <code>scheduled_test</code> library. One way or another, this will impact <a href="http://patternsinpolymer.com/">Patterns in Polymer</a>—even if only the testing chapters. A topic for tomorrow.<br /><br /><span style="color: #ccc">Day #2</span>  <br /><br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/12/a-solution-for-karma-testing-polymer-on.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2015/03/simple-solutions-to-asynchronous.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/moe8AwIaQyM" height="1" width="1" alt=""/>
