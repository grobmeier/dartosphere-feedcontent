---
title: 'Benchmarking Dart (and dart2js) Code in the Browser'
layout: post
published: '2014-06-30T23:58:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/JsQhDDOOOFg/benchmarking-dart-and-dart2js-code-in.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - benchmarking
    - chain
    - dart
    - dart2js
    - dartlang
    - design-patterns
    - 'factory method pattern'

---

<div class=top-chain-links></div><br />I am a benchmarking fool. I so enjoyed benchmarking various implementations of the <a href="http://en.wikipedia.org/wiki/Factory_method_pattern">Factory Method</a> pattern, that I try it again today. Yesterday I ran the benchmarks from the command-line. Today, I wonder what my options are for benchmarking Dart code in the browser. <br /><br />To benchmark <a href="http://dartlang.org">Dart</a> from the command-line, I used the <code>dart</code> system command that comes with the SDK. For good measure, I also compiled my benchmark harness into JavaScript and ran it with <a href="http://nodejs.com/">node.js</a>. Amazingly, that worked without any effort on my part. <br /><br />It worked so well, I thought why not try it in the browser? There may wind up being a web-specific design pattern or two in <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>, so while this benchmarking stuff is fresh in my brain, I ought to see how it might work in the browser instead of from the command-line. With a qualifier...<br /><br />Even though these benchmarks will be run in the browser, I want the results readily accessible from the command-line. I would like the ability to review progress of any benchmarks as I refine pattern approaches and that needs to be automated or it simply won't happen.<br /><br />So I create a <code>web</code> sub-directory in my factory_method sample code, copy in yesterday's <code>benchmark.dart</code> and start with a simple <code>index.html</code>:<pre class=prettyprint>&lt;!DOCTYPE html><br />&lt;html><br />  &lt;head><br /><b>    &lt;script type="application/dart" src="benchmark.dart">&lt;/script></b><br />    &lt;script src="packages/browser/dart.js">&lt;/script><br />  &lt;/head><br />  &lt;body>&lt;/body><br />&lt;/html><br /></pre>I do not know how these things are normally done in JavaScript, but if I want the <code>console.log</code> output from Dart code, I stick with <code>content_shell</code>, which is bundled with the SDK. And this works right off the bat:<pre class=prettyprint>$ content_shell --dump-render-tree web/index.html<br />#READY<br /><b>CONSOLE MESSAGE: Factory Method â€” Subclass(RunTime): 0.09106837778077291 us.<br />CONSOLE MESSAGE: Factory Method â€” Map of Factories(RunTime): 1.8514472763359118 us.<br />CONSOLE MESSAGE: Factory Method â€” Mirrors(RunTime): 12.328632014991616 us.</b><br />Content-Type: text/plain<br />layer at (0,0) size 800x600<br />  RenderView at (0,0) size 800x600<br />layer at (0,0) size 800x8<br />  RenderBlock {HTML} at (0,0) size 800x8<br />    RenderBody {BODY} at (8,8) size 784x0<br />#EOF<br />#EOF<br />#EOF</pre>Nice. Those numbers are comparable to the Dart command-line numbers from yesterday, so all appears to be in good shape with benchmarking pure Dart in the browser. What about dart2js compiled JavaScript?<br /><br />I could try dumping it into a test runner like <a href="http://karma-runner.github.io">Karma</a>, but that seems crazy. I mean more crazy than most of the stuff I try. Maybe <code>content_shell</code> will work for this as well? To test that out, I <code>pub build</code> my benchmark application which compiles the <code>index.html</code> page and associated code:<pre class=prettyprint>$ pub build<br />Loading source assets...<br />Building factory_method_code...<br />[Info from Dart2JS]:<br />Compiling factory_method_code|web/benchmark.dart...<br />[Dart2JS on factory_method_code|web/benchmark.dart]:<br />1 warning(s) suppressed in dart:_js_mirrors.<br />[Warning from Dart2JS]:<br />web/benchmark.dart:<br />2391 methods retained for use by dart:mirrors out of 3411 total methods (70%).<br />[Info from Dart2JS on factory_method_code|web/benchmark.dart]:<br />packages/factory_method_code/mirrors.dart:3:1:<br />This import is not annotated with @MirrorsUsed, which may lead to unnecessarily large generated code.<br />Try adding '@MirrorsUsed(...)' as described at https://goo.gl/Akrrog.<br />import 'dart:mirrors';<br />^^^^^^^^^^^^^^^^^^^^^^<br />[Info from Dart2JS]:<br />Took 0:00:13.648601 to compile factory_method_code|web/benchmark.dart.<br />Built 5 files to "build".</pre>Note to self: I really need to look into that @MirrorUsed annotation. Some other day.<br /><br />For now, I have compiled JavaScript and page in the build directory:<pre class=prettyprint>$ tree -L 2 build<br />build<br />└── web<br />    ├── benchmark.dart.js<br />    ├── benchmark.dart.precompiled.js<br />    ├── index.html<br />    └── packages<br /><br />2 directories, 3 files</pre>I cannot just run that code because <code>content_shell</code> from the Dart SDK has the Dart VM included. With the Dart VM available, <code>content_shell</code> would try to run the Dart code which was not included in the build process. <br /><br />So, just to see if this works, I hand-edit the generated HTML to directly point to the compiled <code>benchmark.dart.js</code> file instead of relying on the usual <code>browser/dart.js</code> to do it:<pre class=prettyprint>&lt;!DOCTYPE html><br />&lt;html><br />  &lt;head><br /><b>    &lt;!-- &lt;script type="application/dart" src="benchmark.dart">&lt;/script> --><br />    &lt;!-- &lt;script src="packages/browser/dart.js">&lt;/script> --><br />    &lt;script src="benchmark.dart.js">&lt;/script></b><br />  &lt;/head><br />  &lt;body>&lt;/body><br />&lt;/html><br /></pre>With that, I can run <code>content_shell</code> against <code>build/web/index.html</code> to find:<pre class=prettyprint>content_shell --dump-render-tree build/web/index.html<br /><b>CONSOLE MESSAGE: line 14349: Factory Method — Subclass(RunTime): 0.46883995866706923 us.<br />CONSOLE MESSAGE: line 14349: Factory Method — Map of Factories(RunTime): 5.1614768017425146 us.<br />CONSOLE MESSAGE: line 14349: Factory Method — Mirrors(RunTime): 16.81279790176282 us.</b><br />Content-Type: text/plain<br />layer at (0,0) size 800x600<br />  RenderView at (0,0) size 800x600<br />layer at (0,0) size 800x8<br />  RenderBlock {HTML} at (0,0) size 800x8<br />    RenderBody {BODY} at (8,8) size 784x0<br />#EOF<br />#EOF<br />#EOF<br /></pre>Again, those numbers are comparable to the command-line dart2js results from yesterday which seems to confirm that this will work.<br /><br />Unless someone cares an awful lot (and tells me that I am mistaken), this seems a reasonable approach to benchmarking in the browser. I may poke around a little more tomorrow—or jump right into added a <code>pub build</code> transformer to automatically change the <code>&lt;script></code> tags that I hand edited today.<br /><br />But so far, this seems promising.<br /><br /><br /><span style="color: #ccc">Day #108</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/06/benchmarking-dart2js-code.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/JsQhDDOOOFg" height="1" width="1"/>
