---
title: 'Working Tests Again on Polymer.dart 0.12'
layout: post
published: '2014-07-31T23:57:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/6TXNvgvyXDw/working-tests-again-on-polymerdart-012.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'page objects'
    - polymer
    - testing

---

<div class=top-chain-links></div><br />Time to get back to <a href="http://patternsinpolymer.com/">Patterns in Polymer</a>. It has been two months since the last release of the book and the last real changes to the code. So no doubt everything is broken.<br /><br />Not that I'm complaining. I signed on for this when I started a book on a technology that was quite up front about being in the the pre-alpha stages.  Truth be told, that is part of the fun!. So let's see what broke. The quickest way to figure this out is tests, so I start with the testing with <a href='https://code.google.com/p/selenium/wiki/PageObjects'>Page Objects</a> chapter. To ease my way back in, I start with the <a href="http://dartlang.org">Dart</a> version of the code.<br /><br />After clearing up <a href="https://github.com/eee-c/polymer-patterns/commit/fb044d82e77b6549fd1ac516e362a8e3dea6ec12">a spurious curly brace</a> (seriously, how did I manage to commit code with an extra curly brace in it?), I make sure that my tests pass against the old version of Polymer (and Dart):<pre class=prettyprint>$ ./test/run.sh<br />CONSOLE WARNING: ShadowRoot.resetStyleInheritance and ShadowRoot.applyAuthorStyles now deprecated in dart:html.<br />Please remove them from your code.<br /><br />CONSOLE MESSAGE: PASS: [defaults] it has no toppings<br />CONSOLE MESSAGE: PASS: [adding toppings] updates the pizza state accordingly<br />CONSOLE MESSAGE:<br />CONSOLE MESSAGE: All 2 tests passed.</pre>I am <a href="http://japhr.blogspot.com/2014/06/a-tag-named-apply-author-styles.html">none too surprised</a> that <code>applyAuthorStyles</code> is deprecated (though I'm a little sad that I left it in there). That aside, everything appears to be in order. So let's change that.<br /><br />I start a <code>pub upgrade</code>:<pre class=prettyprint>$ pub upgrade<br />Resolving dependencies... (4.9s)<br />...<br />> polymer 0.12.0 (was 0.10.0-pre.9) (1 newer version available)<br />> polymer_expressions 0.12.0 (was 0.10.0-pre.1)<br />...<br />> web_components 0.5.0 (was 0.3.3)<br />...<br />Changed 30 dependencies!</pre>That is sure to break all kinds of things. And sure enough, my test suite fails to even start.<br /><br />Fortunately, I have not been completely away from Polymer in the intervening time. <a href="https://plus.google.com/+JamesHurford">James Hurford</a> and I went through this pain when we updated the <code>&lt;ice-code-editor></code> element (from <a href="https://github.com/eee-c/ice-code-editor">ICE Code Editor</a>). From that experience, I rework the test context page to load the Polymer platform JavaScript source (previously it was Dart):<pre class=prettyprint>&lt;head><br /><b>  &lt;!-- Load Polymer --><br />  &lt;script src="packages/web_components/platform.js">&lt;/script></b><br /><br />  &lt;!-- Load component(s) --><br />  &lt;link rel="import" href="packages/page_objects/elements/x-pizza.html"><br /><br />  &lt;!-- The actual tests --><br />  &lt;script type="application/dart" src="test.dart">&lt;/script><br />  &lt;script src="packages/unittest/test_controller.js">&lt;/script><br />&lt;/head></pre>This code was built on an experimental version of <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a>, so I also have to remove some mime-type tomfoolery. I also have to reintroduce a <code>initPolymer()</code> call to the test's <code>main()</code> entry point:<pre class=prettyprint>// ...<br />main() {<br /><b>  initPolymer();</b><br />  // Actual tests go here...<br />}</pre>Even with that, I was still getting a rather unhelpful error when I attempted to run the tests:<pre class=prettyprint>CONSOLE WARNING: line 213: FAIL<br />CONSOLE ERROR: Exception: NoSuchMethodError: method not found: 'whenPolymerReady'<br />Receiver: Instance of 'JsFunction'<br />Arguments: [Closure: () => dynamic]</pre>This turns out to also be caused by a jump from a pre-release version of Polymer.dart to 0.12. The fix for this was to simply import Polymer into the top-level Polymer element definition (I am testing <code>&lt;x-pizza></code>):<pre class=prettyprint><b>&lt;link rel="import" href="../../../packages/polymer/polymer.html"></b><br />&lt;link rel="import" href="x-pizza-toppings.html"><br />&lt;polymer-element name="x-pizza"><br />  &lt;template><br />    &lt;!-- ... --><br />  &lt;/template><br />  &lt;script type="application/dart" src="x_pizza.dart">&lt;/script><br />&lt;/polymer-element></pre>With that, I have my tests passing again:<pre class=prettyprint>$ ./test/run.sh<br />...<br />CONSOLE WARNING: line 12: flushing %s elements<br />CONSOLE MESSAGE: unittest-suite-wait-for-done<br /><b>CONSOLE MESSAGE: PASS: [defaults] it has no toppings<br />CONSOLE MESSAGE: PASS: [adding toppings] updates the pizza state accordingly<br />CONSOLE MESSAGE:<br />CONSOLE MESSAGE: All 2 tests passed.</b></pre>I will worry about that “flushing %s elements” another time. For now, I am satisfied to have my tests passing.<br /><br />I also find that I need to update the actual page that demonstrates this Polymer element. As in the test, I need to load the web components polyfill JavaScript code. I also have to <code>initPolymer()</code>, which is done under normal circumstances with the built-in <code>init.dart</code>:<pre class=prettyprint>&lt;!DOCTYPE html><br />&lt;html lang="en"><br />  &lt;head><br /><b>    &lt;!-- Load platform polyfills --><br />    &lt;script src="packages/web_components/platform.js">&lt;/script></b><br /><br />    &lt;!-- Load component(s) --><br />    &lt;link rel="import"<br />          href="packages/page_objects/elements/x-pizza.html"><br /><br /><b>    &lt;!-- Start Polymer --><br />    &lt;script type="application/dart"><br />      export 'package:polymer/init.dart';<br />    &lt;/script></b><br />  &lt;/head><br />  &lt;body><br />    &lt;div class="container"><br />      &lt;h1>Ye Olde Dart Pizza Shoppe&lt;/h1><br />      &lt;x-pizza>&lt;/x-pizza><br />    &lt;/div><br />  &lt;/body><br />&lt;/html><br /></pre>With that, I have it working again in both Dart and JavaScript (the latter courtesy of Polymer.dart's built-in <code>dart2js</code> transformer:<br /><br /><a href="http://3.bp.blogspot.com/-TsKaRPt8osM/U9sOczZYm-I/AAAAAAAAdlk/8wnxniDw6u4/s1600/01-working_again_in_dart_and_js.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-TsKaRPt8osM/U9sOczZYm-I/AAAAAAAAdlk/8wnxniDw6u4/s400/01-working_again_in_dart_and_js.png" /></a><br /><br />I am back in business! No doubt I have other clean-up to do and some associated rewriting. And of course, screencasts for readers of the “Extras” version of <a href="http://patternsinpolymer.com">Patterns in Polymer</a>. For today, it is good to be back.<br /><br /><br /><span style="color: #ccc">Day #139</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/07/declaring-and-immediately-invoking.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/08/page-objects-testing-still-viable-with.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/6TXNvgvyXDw" height="1" width="1"/>
