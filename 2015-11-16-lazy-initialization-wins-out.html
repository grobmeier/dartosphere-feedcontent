---
title: 'Lazy Initialization Wins Out'
layout: post
published: '2015-11-16T23:20:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/8tXu5YD2XK0/lazy-loading-wins-out.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight

---

<div class=top-chain-links></div><br />Design patterns trend mundane once you figure them out. "Oh, that's all the Flyweight is?" Given that they were originally inspired by something as fanciful as <a href="https://en.wikipedia.org/wiki/The_Timeless_Way_of_Building">The Timeless Way of Building</a>, I still half expect the sublime from every design pattern that I explore. The sublime may not always be there. Then again, maybe I just need to explore a little more.<br /><br />I enjoy finding examples that are concise yet still show some of the power of design patterns. Certainly such examples are important for <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. But once I have them, I fear tweaking them and exploring further will yield diminishing returnsâ€”perhaps the sublime just isn't in this design pattern. On the other hand, how can I ever find the sublime if I don't explore. And so tonight I risk wasting my time in search of the sublime.<br /><br />The esteemed <a href="https://www.google.com/+JamesHurford">James Hurford</a> supplied <a href="https://dartpad.dartlang.org/f204f60fe7b388f00348">some pointers and suggestions</a> to my recent <a href="http://japhr.blogspot.com/2015/11/flyweight-coffee-shop-in-dart.html">flyweight coffee shop</a>. The code was excellent, as to be expected. Well, except for this bit in the flyweight:<pre class=prettyprint>abstract class Coffee {<br />  factory Coffee.create(name) => _cache.putIfAbsent(name, () => _create(name));    <br />  static Coffee _create(name) {<br />    switch(name) {<br />      case 'Flat White':<br />        return new FlatWhite();<br />      case 'Mockachino':<br />        return new Mockachino();<br />      case 'Cappuccino':<br />        return new Cappuccino();<br />      case 'Espresso':<br />        return new Espresso();<br />      case 'Frappe':<br />        return new Frappe();<br />      case 'Long Black':<br />        return new LongBlack();<br />      case 'Americano':<br />        return new Americano();<br />    }<br />    <br />    return new FakeCoffee();<br />  }<br />}<br /></pre>I'm not giving James too hard a time here. The code has two things that I appreciate: it works and it produces concrete flyweight instances of different varieties. I always like working code and I appreciate concrete instances because <a href="http://dartlang.org">Dart</a>'s static typing is one of the things I very much want to explore in the book. <br /><br />But that <code>case</code> statement: ick. Not only is it long and unsightly, but it also necessitates two changes every time a new coffee drink is added to the menu. Maybe the load-time fun from last night can help. Or not...<br /><br />Following along with the DWT approach, I ought to be able to define a concrete flyweight along the lines of:<pre class=prettyprint>class Mochachino implements Coffee {<br />  static var type = Coffee.register(new Mochachino());<br />  String get name => "Mochachino";<br />  double get profitPerOunce => 0.3;<br />}</pre>Registering the <code>Mochachino</code> will cache a reference to the flyweight instance such that all future instances will be the original. Except this does not work.<br /><br />I did not give this enough thought last night, but the DWT must be so old that some of the code, the flyweight implementation included, no longer works because of lazy initialization. Lazy initialization is great until you expect code like the <code>type</code> assignment to be evaluated at compile time. <br /><br />For <code>type</code> to be registered at compile-time, I need to use the <code>const</code> keyword instead of <code>new</code>. Unfortunately, adding objects to a <code>Map</code> at compile-time does not lend itself to compile-time constants.<br /><br />In other words, I think I'm out of luck. If I want concrete flyweight objects, I either need to stick with James' long <code>case</code> statement approach or move away from factory constructor back to factory classes. Neither is particular appealing, but I might opt for the latter as that was how the original pattern was envisioned. That is something to explore tomorrow.<br /><br /><br /><br /><span style="color: #ccc">Day #5</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/searching-for-flyweight.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2015/11/concrete-flyweight-objects-with-dart.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/8tXu5YD2XK0" height="1" width="1" alt=""/>
