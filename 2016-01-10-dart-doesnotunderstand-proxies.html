---
title: 'Dart doesNotUnderstand Proxies'
layout: post
published: '2016-01-10T23:04:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/JI3aja5dhgM/dart-doesnotunderstand-proxies.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - 'proxy pattern'

---

<div class=top-chain-links></div><br />Patterns can be kinda dull. Consequences and implementations are pretty damn fun.<br /><br />I got the <a href=""https://en.wikipedia.org/wiki/Proxy_pattern>proxy pattern</a> working in <a href="http://dartlang.org">Dart</a> last night without much trouble. Let's see if I can cause trouble with the second implementation (a.k.a. <code>doesNotUnderstand</code>) from the <a href="http://en.wikipedia.org/wiki/Design_Patterns">Gang of Four book</a> chapter on the pattern. The <code>doesNotUnderstand</code> method is a Smalltalk construct, but I think Dart's <code>noSuchMethod</code> ought to serve a similar purpose.<br /><br />The Gang of Four's <code>doesNotUnderstand</code> implementation was framed as a generic solution. I am going to keep mine somewhat generic. I continue to use last night's protection proxy example for driving automobiles. The protection came in the form of preventing underage drivers from getting behind the wheel:<pre class=prettyprint>// Proxy Subject<br />class ProxyCar implements Automobile {<br />  // ...<br />  void drive() {<br />    if (_driver.age <= 16) {<br />      print("Sorry, the driver is too young to drive.");<br />      return;<br />    }<br /><br />    _car.drive();<br />  }<br />}</pre>Instead of protection solely in the <code>drive()</code> method, I am going to switch to a <code>noSuchMethod()</code> implementation.     This protection proxy follows standard proxy practices in that it does not create an instance of the real subject (the car) until it is needed. The <code>car</code> getter method returns the private <code>_car</code> instance if it has been defined, otherwise it creates and assigns it:<pre class=prettyprint>class ProxyCar implements Automobile {<br />  Driver driver;<br />  Car _car;<br /><br />  ProxyCar(this.driver);<br /><br />  Car get car => _car ??= new Car();<br />  // noSuchMethod will go here...<br />}</pre>To make the <code>noSuchMethod()</code> approach work, I am going to need to invoke arbitrary methods on the real subject. That means that I need to import <code>dart:mirrors</code>:<pre class=prettyprint>import 'dart:mirrors';</pre>I next need to delete the existing <code>drive()</code> method. Once gone, invoking the <code>drive()</code> method on <code>ProxyCar</code> will send the call to <code>noSuchMethod()</code>. If the <code>noSuchMethod()</code> method is not defined in <code>ProxyCar</code>, then the call gets sent to the <code>noSuchMethod()</code> in <code>ProxyCar</code>'s superclass, <code>Object</code>. <code>Object</code>'s <code>noSuchMethod()</code> throws a <code>NoSuchMethodError</code>, which I do not want, so I declare <code>noSuchMethod()</code> in <code>ProxyCar</code>.    With <code>dart:mirrors</code>, I can reflect on the car, then send the message and arguments that reached <code>noSuchMethod()</code> to the <code>car</code> instance:<pre class=prettyprint>class ProxyCar implements Automobile {<br />  // ...<br />  dynamic noSuchMethod(i) {<br />    if (driver.age <= 16)<br />      throw new IllegalDriverException(driver, "too young");<br /><br />    return reflect(car).invoke(i.memberName, i.positionalArguments);<br />  }<br />}</pre>I have switched to an exception here to really ensure that this registers as something wrong.  With that, my client code is once again working. I create a 25 year-old driver, then send the <code>drive()</code> message to the proxy car:<pre class=prettyprint><code>  // Proxy will allow access to real subject<br />  print("* 25 year-old driver here:");<br />  car = new ProxyCar(new Driver(25));<br />  car.drive();</code></pre>Since <code>drive()</code> is not defined on <code>ProxyCar</code>, it gets sent to <code>noSuchMethod()</code>, which checks that the driver's age is greater than 16, then tells the car to drive:<pre class=prettyprint>$ ./bin/drive.dart<br />* 25 year-old driver here:<br />Car has been driven!<br /></pre>If a 16 year-old tries to get behind the wheel, the <code>noSuchMethod()</code> guard clause kicks in, giving me the appropriate exception:<pre class=prettyprint>$ ./bin/drive.dart<br />* 16 year-old driver here:<br />Unhandled exception:<br />IllegalDriverException: 16 year old driver is too young!</pre>I can add other gaurd clauses to <code>noSuchMethod()</code> as well. For example, I can guard against the same conditions as in the Gang of Four example—illegal messages:<pre class=prettyprint>class ProxyCar implements Automobile {<br />  // ...<br />  dynamic noSuchMethod(i) {<br />    if (i.memberName != #drive)<br />      throw new IllegalAutomobileActionException(i.memberName);<br />    if (driver.age <= 16)<br />      throw new IllegalDriverException(driver, "too young");<br /><br />    return reflect(car).invoke(i.memberName, i.positionalArguments);<br />  }<br />}</pre>Now if the driver tries to do something wrong with the car, an exception will arise regardless of age:<pre class=prettyprint><code>  print("* 25 year-old driver here:");<br />  car = new ProxyCar(new Driver(25));<br />  car.fly();<br />  // ==> IllegalAutomobileActionException: Symbol("fly")</code></pre>The Gang of Four makes this completely generic, but I am hard pressed to think of a situation in which I could define a list of valid methods that would not apply to a single interface (like <code>Automobile</code> in this case). Regardless, this <code>noSuchMethod()</code> proxy approach works quite nicely—I think I will be using this in the future.  <p><i>Play with the code on DartPad: <a href="https://dartpad.dartlang.org/c919e79c50e968cd314d">https://dartpad.dartlang.org/c919e79c50e968cd314d</a>.</i></p><span style="color: #ccc">Day #60</span>    <p class=bottom-chain-links><a href="http://japhr.blogspot.com/2016/01/a-simple-proxy-pattern-in-dart.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2016/01/remote-proxy-pattern-and-dart-isolates.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/JI3aja5dhgM" height="1" width="1" alt=""/>
