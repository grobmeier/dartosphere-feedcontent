---
title: 'Can''t Transform My Reflectable Flyweight'
layout: post
published: '2015-11-22T23:51:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/q1a2pOQVNaM/cant-transform-my-reflectable-flyweight.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight
    - mirrors

---

<div class=top-chain-links></div><br />Up tonight, I try compiling my <a href="https://pub.dartlang.org/packages/reflectable">Reflectable</a> <a href="http://dartlang.org">Dart</a> code into JavaScript. Even if the compiled JavaScript is twice the size of the <code>dart:mirrors</code> equivalent, I would likely stick with Reflectable. The Dart code is just that pretty.<br /><br />For books like <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>, I tend to favor built-in libraries to external libraries—even external libraries that are maintained on the core project like Reflectable. I will make an exception for an external package that makes my job of explaining central concepts easier. Reflectable fits that criteria since it converted something like a dozen lines of library and declaration processing into <code>flavor.annotatedClasses</code> (<code>flavor</code> being a custom constant used to annotate my code).<br /><br />So tonight, I try explore the other promise of Reflectable: better JavaScript compilation. Following along with the project README, I update the <code>pubspec.yaml</code> to include a Reflectable transformer:<pre class=prettyprint>name: flyweight_code<br />dependencies:<br />  reflectable: any<br />transformers:<br />- reflectable:<br />    entry_points:<br />      - bin/coffee_orders.dart<br />    formatted: true</pre>Next, I run <code>pub build</code> to transform this code:<pre class=prettyprint>$ pub build --mode=debug bin                   <br />Loading source assets... <br />Loading reflectable transformers... <br />Building flyweight_code... (3.0s) <br />[Info from Dart2JS]:<br />Compiling flyweight_code|bin/coffee_orders.dart...<br />[Info from Dart2JS]:<br />Took 0:00:01.592568 to compile flyweight_code|bin/coffee_orders.dart.<br />Built 600 files to "build".</pre>Unfortunately, when I run the code from Dart, I get a bad state error:<pre class=prettyprint>$ dart build/bin/coffee_orders.dart                        <br />here!!!!!!!!!!<br />Cappuccino<br />Instance of 'Flavor'<br />Unhandled exception:<br />Bad state: Reflectable has not been initialized. Did you forget to add the main file to the reflectable transformer's entry_points in pubspec.yaml?<br />#0      data (package:reflectable/src/reflectable_transformer_based.dart:119:5)<br />#1      data (package:reflectable/src/reflectable_transformer_based.dart:118:33)<br />#2      ReflectableImpl.annotatedClasses (package:reflectable/src/reflectable_transformer_based.dart:1260:50)<br />#3      CoffeeFlavor.classMirrors (package:flyweight_code/coffee_shop.dart:61:5)<br />#4      CoffeeFlavor.classMirrors (package:flyweight_code/coffee_shop.dart:60:14)<br />#5      CoffeeFlavor.CoffeeFlavor (package:flyweight_code/coffee_shop.dart:69:11)<br />#6      CoffeeShop.order (package:flyweight_code/coffee_shop.dart:24:22)<br />#7      main (file:///home/chris/repos/design-patterns-in-dart/flyweight/build/bin/coffee_orders.dart:39:7)<br />#8      _startIsolate.&lt;anonymous closure> (dart:isolate-patch/isolate_patch.dart:261)<br />#9      _RawReceivePortImpl._handleMessage (dart:isolate-patch/isolate_patch.dart:148)</pre>The first few lines of output there are debug <code>print()</code> statements, but when I hit Reflectable code, it crashes. I am unsure that I understand the error—I clearly put the <code>main()</code> entry file into the <code>pubspec.yaml</code>. Based on the <a href="https://github.com/dart-lang/reflectable/blob/master/test_reflectable/pubspec.yaml">pubspec.yaml</a> for the <code>test_reflectable</code> code, I <i>think</i> I am doing this correctly. But still, I get that error.<br /><br />I try following the suggestion of the README to use <code>build/bin/packages</code> as the package-root, but I still get the same error:<pre class="prettyprint">$ dart -p ./build/bin/packages build/bin/coffee_orders.dart<br />here!!!!!!!!!!<br />Cappuccino<br />Instance of 'Flavor'<br />Unhandled exception:<br />Bad state: Reflectable has not been initialized. Did you forget to add the main file to the reflectable transformer's entry_points in pubspec.yaml?<br />#0      data (package:reflectable/src/reflectable_transformer_based.dart:119:5)<br />...</pre>Not surprisingly, this also fails if I try to run the JavaScript-compiled version of the code:<pre class=prettyprint>$ node build/bin/coffee_orders.dart.js<br />here!!!!!!!!!!<br />Cappuccino<br />Instance of 'Flavor'<br />/home/chris/repos/design-patterns-in-dart/flyweight/build/bin/coffee_orders.dart.js:671<br />      throw H.wrapException(ex);<br />              ^<br />Bad state: Reflectable has not been initialized. Did you forget to add the main file to the reflectable transformer's entry_points in pubspec.yaml?<br />    at dart.wrapException (/home/chris/repos/design-patterns-in-dart/flyweight/build/bin/coffee_orders.dart.js:658:17)<br />...</pre>And, if I compare the transformed version of the <code>bin/coffee_orders.dart</code> file with the original, I find no differences:<pre class=prettyprint>$ diff bin/coffee_orders.dart build/bin/coffee_orders.dart<br />$ echo $?<br />0</pre>At this point, I have to admit that I am stumped. I try converting this all to a <code>web</code> script with identical results. No matter what I can think to try, I do not seem to get a transformed version of the Dart code that I list in my <code>pubspec.yaml</code>.<br /><br />This is a bit of a bummer. I still might make use of Reflectable in the book. I assume that I am doing something dumb or there is a minor bug in Reflectable that will get resolved. Likely the former, but if it is the latter, it will surely be resolved long before the book is ready.  I may try to identify simpler test cases or try <code>test_reflectable</code> myself tomorrow.<br /><br />If anyone has any suggestions, my code is at: <a href="https://github.com/eee-c/design-patterns-in-dart/tree/master/flyweight">https://github.com/eee-c/design-patterns-in-dart/tree/master/flyweight</a>.<br /><br /><br /><span style="color: #ccc">Day #11</span>  <br /><br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/beautiful-clean-mirrors-in-dart-with.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <a href="http://japhr.blogspot.com/2015/11/building-reflectable-dart-code-with.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/q1a2pOQVNaM" height="1" width="1" alt=""/>
