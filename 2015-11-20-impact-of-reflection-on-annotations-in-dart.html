---
title: 'Impact of Reflection on Annotations in Dart'
layout: post
published: '2015-11-20T23:09:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/oL0FdVAWeyM/impact-of-reflection-on-annotations-in.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight
    - mirrors

---

<div class=top-chain-links></div><br />I had a good time messing about with code annotations last night. Ostensibly I am still working on the <a href="https://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight Pattern</a> in <a href="http://dartlang.org">Dart</a> for the forthcoming <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. Tonight, however, I am really just exploring annotations a little further.<br /><br />I am somewhat surprised that the <a href="https://dartpad.dartlang.org">DartPad</a> for last night's code (<a href="https://dartpad.dartlang.org/c7dabc0c57a93e8d88d7">https://dartpad.dartlang.org/c7dabc0c57a93e8d88d7</a>) compiled. I am a little fuzzy on the details of DartPad, but there has to be some JavaScript compilation taking place to make it work. The thing is, when I compile last night's code into JavaScript, it is <i>huge</i>.<br /><br />The code itself is a little over 4k of Dart:<pre class=prettyprint>$ ls -lh bin/coffee_orders.dart lib/coffee_shop.dart <br />-rwxr-xr-x 1 chris chris 1.6K Nov 21 00:12 bin/coffee_orders.dart<br />-rw-r--r-- 1 chris chris 2.8K Nov 21 00:18 lib/coffee_shop.dart</pre>But when I compile it:<pre class=prettyprint>$ dart2js bin/coffee_orders.dart -o bin/tmp.js                                                                 <br />bin/coffee_orders.dart:<br />Warning: <br />****************************************************************<br />* WARNING: dart:mirrors support in dart2js is experimental,<br />*          and not recommended.<br />*          This implementation of mirrors is incomplete,<br />*          and often greatly increases the size of the generated<br />*          JavaScript code.<br />*<br />* Your app imports dart:mirrors via:<br />*   coffee_orders.dart => package:flyweight_code => dart:mirrors<br />*<br />* You can disable this message by using the --enable-experimental-mirrors<br />* command-line flag.<br />*<br />* To learn what to do next, please visit:<br />*    http://dartlang.org/dart2js-reflection<br />****************************************************************<br /><br /><br />Hint: 2 hint(s) suppressed in package:flyweight_code.<br />Hint: When run on the command-line, the compiled output might require a preamble file located in:<br />  <sdk>/lib/_internal/js_runtime/lib/preambles.<br />bin/coffee_orders.dart:<br />Hint: 2367 methods retained for use by dart:mirrors out of 3519 total methods (67%).<br /><br />bin/packages/flyweight_code/coffee_shop.dart:4:1:<br />Info: This import is not annotated with @MirrorsUsed, which may lead to unnecessarily large generated code.<br />Try adding '@MirrorsUsed(...)' as described at https://goo.gl/Akrrog.<br />import 'dart:mirrors';<br />^^^^^^^^^^^^^^^^^^^^^^<br /></pre>I get nearly 4k of console warnings.<br /><br />I kid, I kid. What is not funny however, is that, as the warning suggests, I get very large JavaScript output:<pre class=prettyprint>ls -lh bin/tmp.js<br />-rw-r--r-- 1 chris chris 1.7M Nov 21 00:25 bin/tmp.js</pre>1.7<b>M</b>b is insane.<br /><br />The code works (if I follow the warning about preambles):<pre class=prettyprint>$ cat ~/local/dart/dart-sdk/lib/_internal/js_runtime/lib/preambles/d8.js bin/tmp.js > bin/coffee_orders.dart.js<br />$ node bin/coffee_orders.dart.js<br />Served Cappuccino to Fred.<br />Served Espresso to Bob.<br />Served Frappe to Alice.<br />Served Frappe to Elsa.<br />Served Coffee to null.<br />Served Coffee to Chris.<br />Served Mochachino to Joy.<br />-----<br />Served 7 coffee drinks.<br />Served 5 kinds of coffee drinks.<br />For a profit of: $27.2</pre>But 1.7Mb is not going to fly.<br /><br />I annotated my concrete flyweight classes with the <code>Flavor</code> constant:<pre class=prettyprint>// Annotation Class<br />class Flavor { const Flavor(); }<br />// Annotation instance<br />const flavor = const Flavor();<br /><br />@flavor<br />class Cappuccino implements CoffeeFlavor {<br />  String get name => 'Cappuccino';<br />  double get profitPerOunce => 0.35;<br />}<br />// Other concrete instances...<br /></pre>So, I ought to be able to slim the resultant JavaScript down simply by telling <code>dart2js</code> that it only has to worry about mirrors for <code>Flavor</code>. This is what the <code>@MirrorsUsed</code> annotation does. In my case, I am using mirrors as "meta targets" -- reading annotation / metadata from the code itself. I add the corresponding <code>@MirrorsUsed()</code> annotation before the import of <code>dart:mirrors</code>:<pre class=prettyprint>library coffee_shop;<br /><br />@MirrorsUsed(metaTargets: "coffee_shop.Flavor")<br />import 'dart:mirrors';<br />// ...</pre>Now, when I compile my code, <code>dart2js</code> only retain 38 methods for use with mirrors instead of 2367:<pre class=prettyprint>$ dart2js bin/coffee_orders.dart -o bin/tmp.js --enable-experimental-mirrors<br />bin/coffee_orders.dart:<br />Hint: 38 methods retained for use by dart:mirrors out of 629 total methods (6%).<br /><br />bin/packages/flyweight_code/coffee_shop.dart:4:1:<br />Info: Import of 'dart:mirrors'.<br />import 'dart:mirrors';<br />^^^^^^^^^^^^^^^^^^^^^^</pre>That is bound to lead to some smaller compiled code. And indeed, it comes in nearly 90% smaller than before:<pre class=prettyprint>$ cat ~/local/dart/dart-sdk/lib/_internal/js_runtime/lib/preambles/d8.js bin/tmp.js > bin/coffee_orders.dart.js<br />$ ls -lh bin/tmp.js bin/coffee_orders.dart.js                                                                  <br />-rw-r--r-- 1 chris chris 294K Nov 21 00:36 bin/coffee_orders.dart.js<br />-rw-r--r-- 1 chris chris 284K Nov 21 00:35 bin/tmp.js</pre>That seems a fine stopping point for tonight. I will continue this exploration tomorrow with <a href="https://pub.dartlang.org/packages/reflectable">reflectable</a>, a potential replacement for <code>dart:mirrors</code>.<br /><br /><br /><span style="color: #ccc">Day #9</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/creating-and-reading-dart-annotations.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/oL0FdVAWeyM" height="1" width="1" alt=""/>
