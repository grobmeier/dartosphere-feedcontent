---
title: 'Failure: Expected Throw, Which Threw'
layout: post
published: '2014-09-07T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/TlTSAbkfEK8/failure-expected-throw-which-threw.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - exception
    - testing

---

<div class=top-chain-links></div><br />I got started with the errata for Beta 1.0 of <a href="http://dart4hipsters.com/">Dart for <strike>Hipsters</strike></a> er… <a href="https://pragprog.com/titles/csdart1">Dart 1 for Everyone</a> (not sure I'll ever get used to that). For the most part, it is pretty OK. There are issues, but nothing insurmountable. Except…<br /><br />One of my tests is failing. Or maybe not.<br /><br />I had all of my tests passing with Dart 1.5.8, but with 1.6.0, I find:<pre class=prettyprint>CONSOLE MESSAGE: FAIL: [bad invocation from noSuchMethod] cannot supply invocation mirror arguments<br />  Expected: throws 'Yikes _ajaxSave'<br />    Actual: &lt;Closure: () => dynamic><br />     Which: threw 'Yikes _ajaxSave")'<br /><br />  package:unittest/src/simple_configuration.dart 119:7                         SimpleConfiguration.onExpectFailure<br />  package:unittest/src/simple_configuration.dart 15:28                         _ExpectFailureHandler.fail<br />  package:matcher/src/expect.dart 113:9                                        DefaultFailureHandler.failMatch<br />  package:matcher/src/expect.dart 73:29                                        expect<br />  ../varying_the_behavior/test/calling_methods_from_no_such_method.dart 38:13  run.&lt;fn>.&lt;fn><br />  package:unittest/src/test_case.dart 102:37                                   _run.&lt;fn></pre>Which is just weird, right? I expect this code throws <code>'Yikes _ajaxSave'</code>. I find that, when run under test, it threw <code>'Yikes _ajaxSave"</code>. And this is counted as a test failure?!<br /><br />I have been ignoring this as best I can so that I can focus on changes. It helps knowing that I will always have time to investigate in depth during these chain posts. Funnily enough, this problem does not take much time to track down. I noticed it back when Dart 1.6 was still in beta. I spent a little time investigating any changes to throwing errors in 1.6, but could not find any. In the end, I thought to wait on the possibility that the language had a bug that would get sorted. <br /><br />The problem turns out not to be a bug, but a change to the way that symbols are converted to strings. Had I looked closer at the failure, I might have noticed that the message includes trailing double quotes. I believe that the old format of <code>Symbol</code> <code>toString()</code> looked like <code>Symbol("_ajaxSave@XXX")</code>. I don't recall what information was embedded in the <code>XXX</code> part of the string, but the following code would try to strip away the data so that a “clean” failure could be thrown and tested::<pre class=prettyprint><code>    if (args.memberName != #save) {<br />      var method_name = args.memberName.toString().<br />        replaceAll('Symbol("', '').<br />        replaceAll(new RegExp(r'@.+'), '');<br />      throw "Yikes ${method_name}";<br />    }</code></pre>I only need to:<pre class=prettyprint><code>    if (args.memberName != #save) {<br />      var method_name = args.memberName.toString().<br />        replaceAllMapped(<br />          new RegExp(r'Symbol\("(.+)"\)'),<br />          (m)=> m[1]<br />        );<br /><br />      throw "Yikes ${method_name}";<br />    }<br /></code></pre><br /><br /><span style="color: #ccc">Day #</span>  <p class=bottom-chain-links><a href="">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/TlTSAbkfEK8" height="1" width="1"/>
