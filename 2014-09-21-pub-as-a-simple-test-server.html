---
title: 'Pub as a Simple Test Server'
layout: post
published: '2014-09-21T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/JIVciJKo8dU/pub-as-simple-test-server.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />I am fairly exited to have a <a href="http://japhr.blogspot.com/2014/09/jenkins-for-testing-dart-and-javascript.html">continuous integration solution</a> for <a href="http://patternsinpolymer.com/">Patterns in Polymer</a>. This is probably something I should have done a long time back, but I now run tests whenever <a href="http://dartlang.org">Dart</a> is updated and at least daily to check for newer versions of <a href="http://www.polymer-project.org/">Polymer</a>. This should go a <i>long</i> way toward helping (forcing) me to keep the book up to date. I am not quite done, however.<br /><br />I have the each chapter's project code under test for the JavaScript edition of the book. But the Dart edition is not quite so complete. Hopefully this will not be too hard to rectify. Many chapters share similar code so the tests can be similar (or identical), which is what I found with the JavaScript tests. But I am not going to start there. Instead, I am curious if my struggles with testing the internationalization solution in JavaScript will continue into Dart.<br /><br />I do not have any real trouble testing Polymer elements in JavaScript, just expressing the tests succinctly. The need to wait an event loop for Polymer to render changes leads to awkward <code>beforeEach()</code> blocks like:<pre class=prettyprint><code>    describe('it can localize to French', function(){<br /><b>      beforeEach(function(done) {<br />        el.locale = 'fr';<br />        setTimeout(done, 0); // One event loop for element to update<br />      });</b><br /><br />      it('(fr)', function(){<br />        expect(el.shadowRoot.textContent).toContain('Bonjour');<br />      });<br />    });</code></pre>Hopefully Dart's async support will make this a little cleaner.<br /><br />The <code>pubspec.yaml</code> configuration file depends on unconstrained versions of Polymer and scheduled_test:<pre class=prettyprint>name: i18n<br />dependencies:<br /><b>  polymer: any</b><br />dev_dependencies:<br /><b>  scheduled_test: any</b><br />transformers:<br />- polymer:<br />    entry_points: web/index.html</pre>The scheduled_test library is a slight variation on unittest (both are from the Dart core team), but with better asynchronous support.<br /><br />A test of the element is fairly straigh-forward. With scheduled_tests, I need to wrap everything that would otherwise happen asynchronously in a <code>schedule()</code>. In this case, I schedule Polymer being ready, the <code>&lt;hello-you></code> element being ready, and then the test itself:<pre class=prettyprint>main() {<br />  initPolymer();<br /><br />  PolymerElement _el;<br />  setUp((){<br /><b>    schedule(()=> Polymer.onReady);</b><br /><br /><b>    schedule((){<br />      _el = createElement('&lt;hello-you>&lt;/hello-you>');<br />      document.body.append(_el);</b><br /><br />      var _completer = new Completer();<br />      _el.async((_)=> _completer.complete());<br />      return _completer.future;<br />    });<br /><br />    currentSchedule.onComplete.schedule(() => _el.remove());<br />  });<br /><br />  group("&lt;hello-you/> (i18n)", (){<br />    test('defaults to English', (){<br /><b>      schedule((){<br />        expect(_el.shadowRoot.text, contains('Hello'));<br />      });</b><br />    });<br />  });<br />  // ...<br />}</pre>That passes, and has the definite advantage of being cleaner than the JavaScript equivalent (which required those unsightly <code>beforeEach()</code> blocks). But, this only passes when I run this in the browser from <code>pub serve</code>, which starts a test build on <code>http://localhost:8081</code>.<br /><br />The problem is that my i18n solution loads its localizations from separate JSON files via Ajax (actually <code>core-ajax</code> Polymer elememts). Loading files via Ajax will not work with a normal content_shell command-line run:<pre class=prettyprint>$ content_shell --dump-render-tree --allow-file-access-from-files test/index.html<br />#READY<br />CONSOLE MESSAGE: unittest-suite-wait-for-done<br />CONSOLE MESSAGE: FAIL: &lt;hello-you/> (i18n) defaults to English<br />  Caught The schedule had 3 errors:<br />  ScheduleError: "Instance of '_XMLHttpRequestProgressEvent'"<br />  Stack chain:<br />  | dart:html  _handleMutation<br />...</pre>It looks like I am going to have to start pub server, then run content_shell tests against that server:<pre class=prettyprint>$ content_shell --dump-render-tree http://localhost:8081/<br />#READY<br />CONSOLE MESSAGE: unittest-suite-wait-for-done<br />CONSOLE MESSAGE: PASS: &lt;hello-you/> (i18n) defaults to English<br />CONSOLE MESSAGE: <br />CONSOLE MESSAGE: All 1 tests passed.<br />CONSOLE MESSAGE: unittest-suite-success<br />CONSOLE WARNING: line 213: PASS<br /></pre>Which is not ideal, but it will work. <a href="http://pub.dartlang.org">Dart Pub</a>, which is the package manager for Dart, includes a web server that is primarily useful for smoke testing applications and elements. It normally spins up a web server on localhost:8080. But, if pub notices a <code>test</code> subdirectory, it will spin up a secondary server on localhost:8081:<pre class=prettyprint>$ pub serve<br />...<br />Loading polymer transformers... (1.1s)<br />Serving i18n web  on http://localhost:8080<br /><b>Serving i18n test on http://localhost:8081</b></pre>Since Dart pub is already installed as part of Dart, I do not need to worry about extra dependencies on my test server. I just spin up <code>pub serve</code> and run my tests as usual. In fact, this is a nice answer to the <a href="http://japhr.blogspot.com/2014/09/testing-core-ajax-polymer-elements-with.html">one of the benefits</a> of a test runner in JavaScript-land.<br /><br /><span style="color: #ccc">Day #190</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/09/indirection-clean-up-of-polymer-jasmine.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/JIVciJKo8dU" height="1" width="1"/>
