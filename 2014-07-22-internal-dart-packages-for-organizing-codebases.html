---
title: 'Internal Dart Packages for Organizing Codebases'
layout: post
published: '2014-07-22T23:54:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/LwB88hkfzes/internal-dart-packages-for-organizing.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - benchmarking
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - 'factory method pattern'

---

<div class=top-chain-links></div><br />This may very well apply only to me…<br /><br />I would like to re-use some shell and <a href="http://dartlang.org">Dart</a> benchmarking code. I will not be duplicating code so I have to find a working solution. The problem with which I am faced is that I am not working on a single Dart package, but dozens—one for each pattern that will be covered in <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>. Each package has its own internal <a href="http://pub.dartlang.org/">Dart Pub</a> structure, complete with <code>pubspec.yaml</code> and the usual subdirectories:<pre class=prettyprint>$ tree -L 2<br />.<br />├── factory_method<br />│   ├── build<br />│   ├── lib<br />│   ├── packages<br />│   ├── pubspec.lock<br />│   ├── pubspec.yaml<br />│   ├── tool<br />│   └── web<br />└── visitor<br />    ├── bin<br />    ├── lib<br />    ├── packages<br />    ├── pubspec.lock<br />    ├── pubspec.yaml<br />    └── tool</pre>The code that I would like to share currently exists only in the <a href="http://en.wikipedia.org/wiki/Visitor_pattern">Visitor Pattern</a>'s <code>tool</code> subdirectory. I suppose that I could create another top-level directory like <code>helpers</code> and then import the common code into <code>visitor</code>, <code>factory_method</code> and the still-to-be-written directories. That seems like a recipe for an unmaintainable codebase—I will wind up with crazy depths and amounts of relative imports (e.g. <code>import '../../../../helpers/benchmark.dart'</code>) strewn about. And the coding gods help me should I ever want to rename things.<br /><br />Instead, I think that I will create a top-level <code>packages</code> directory to hold my common benchmarking code, as well as any other common code that I might want to use. As the name suggests, I can create this as an actual Dart Pub package, but instead of publishing it to <a href="http://pub.dartlang.org">pub.dartlang.org</a>, I can keep it local:<pre class=prettyprint>$ tree -L 2<br />.<br />├── factory_method<br />│   └── ...<br /><b>├── packages<br />│   └── benchmarking</b><br />└── visitor<br />    └── ...</pre>I am probably going to regret this, but I named the package's subdirectory as the relatively brief ”benchmarking,” but name the package <code>dpid_benchmarking</code> in <code>pubspec.yaml</code>. The idea here is to save a few keystrokes on the directory name, but ensure that my local package names do not conflict with any that might need to be used as dependencies. So in <code>packages/benchmarking</code>, I create a <code>pubspec.yaml</code> for my local-only package:<pre class=prettyprint>name: dpid_benchmarking<br />dev_dependencies:<br />  args: any<br />  benchmark_harness: any</pre>There is nothing fancy there—it reads like any other package specification in Dart, which is nice.<br /><br />The first bit of common code that I would like to pull in is not Dart. Rather it is the common <code>_benchmark.sh</code> Bash code from last night. There is nothing in Dart's packages that prevent packaging other languages, a fact that I exploit here:<pre class=prettyprint>$ git mv visitor/tool/_benchmark.sh packages/benchmarking/lib</pre>I use the <code>lib</code> subdirectory in the package because that is the only location that is readily shared by Dart packages.<br /><br />To use <code>_benchmark.sh</code> from the <code>vistor</code> code samples, I now need to declare that it depends on my local-only package. This can be done in <code>pubspec.yaml</code> with a dependency. Since this is benchmarking code, it is not a build dependency. Rather it is a development dependency. And, since this is a local-only package, I have to specify a <code>path</code> attribute for my development dependency:<pre class=prettyprint>name: visitor_code<br /><b>dev_dependencies:<br />  dpid_benchmarking:<br />    path: ../packages/benchmarking</b></pre>I suffer a single relative path in my <code>pubspec.yaml</code> because Pub rewards me with a common, non-relative path after <code>pub install</code>. Installing this local-only package creates a symbolic link to <code>packages/dpid_benchmarking/lib</code> in the packages directory:<pre class=prettyprint>$ pwd<br />/home/chris/repos/design-patterns-in-dart/visitor<br />$ ls -l packages <br /><b>lrwxrwxrwx 1 chris chris 31 Jul 22 21:35 dpid_benchmarking -> ../../packages/benchmarking/lib</b><br />lrwxrwxrwx 1 chris chris  6 Jul 22 21:35 visitor_code -> ../lib</pre>Especially useful here is that Dart Pub creates this <code>packages</code> directory in all of the standard pub subdirectories like <code>tool</code>:<pre class=prettyprint>$ cd tool<br />$ pwd<br />/home/chris/repos/design-patterns-in-dart/visitor/tool<br />$ ls -l packages/<br /><b>lrwxrwxrwx 1 chris chris 31 Jul 22 21:35 dpid_benchmarking -> ../../packages/benchmarking/lib</b><br />lrwxrwxrwx 1 chris chris  6 Jul 22 21:35 visitor_code -> ../lib</pre>This is wonderfully useful in my visitor pattern's <code>benchmark.sh</code> Bash script. Instead of sourcing <code>_benchmark.sh</code> in the current <code>tool</code> directory, I simply change it so that it sources it from the local-only package:<pre class=prettyprint>#!/bin/bash<br /><br /><b>source ./packages/dpid_benchmarking/_benchmark.sh</b><br /><br />BENCHMARK_SCRIPTS=(<br />    tool/benchmark.dart<br />    tool/benchmark_single_dispatch_iteration.dart<br />    tool/benchmark_visitor_traverse.dart<br />)<br /><br />_run_benchmarks $1</pre>The symbolic links from Dart Pub takes care of the rest. Nice!<br /><br />Of course, Pub is the <i>Dart</i> package manager, so it works with Dart code as well. I move some obvious candidates for common benchmarking from <code>visitor/tool/src</code> into the local-only package:<pre class=prettyprint>$ git mv visitor/tool/src/config.dart packages/benchmarking/lib/<br />$ git mv visitor/tool/src/score_emitters.dart packages/benchmarking/lib/</pre>It is then a simple matter of changing the import statements to use the local-only package:<pre class=prettyprint><b>import 'package:dpid_benchmarking/config.dart';<br />import 'package:dpid_benchmarking/score_emitters.dart';</b><br />import 'package:visitor_code/visitor.dart';<br /><br />main (List<String> args) {<br />  // ...<br />}</pre>Dart takes care of the rest!<br /><br />Best of all, I rinse and repeat in the rest of my design patterns. I add the <code>dpid_benchmarking</code> local-only package as a development dependency, run <code>pub install</code>, then make use of this common code to ensure that I have beautiful data to back up some beautiful design patterns.<br /><br />That is an all-around win thanks to Dart's Pub package manager. Yay!<br /><br /><br /><span style="color: #ccc">Day #130</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/07/refactoring-bash-scripts.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/LwB88hkfzes" height="1" width="1"/>
