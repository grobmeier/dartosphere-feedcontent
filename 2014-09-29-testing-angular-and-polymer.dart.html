---
title: 'Testing Angular and Polymer.dart'
layout: post
published: '2014-09-29T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/Rr3Hx2P2n7Y/testing-angular-and-polymerdart.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - angular
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />Regardless of the solution that I use to double bind variables between <a href="https://github.com/angular/angular.dart">Angular.dart</a> and <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a>, I need to test it. Without tests, I will have no warning when new versions of the libraries break the last working version.<br /><br />Before getting to the actual test, I need to make a change to the <code>pubspec.yaml</code>. Oddly, the latest versions of Angular.dart and Polymer.dart are incompatible—they have conflicting dependencies. Luckily, <a href="http://pub.dartlang.org/">Dart Pub</a> comes with a built-in solution for this, <code>dependency_overrides</code>. This setting lets application developers say, “I love you package X and I know you <i>think</i> that can only support version 0.10 of this other library, but let's give version 0.11 a try for Chris, OK?”<br /><br />To get Angular.dart and Polymer.dart working, I had to convince Angular.dart that it might run with the following <code>dependency_overrides</code>:<pre class=prettyprint>name: angular_example<br />dependencies:<br />  angular: any<br />  polymer: any<br />  angular_node_bind: any<br /><b>dependency_overrides:<br />  args: '>=0.10.0 &lt;0.12.0'<br />  code_transformers: '>=0.1.4+2 &lt;0.3.0'<br />  html5lib: '>=0.10.0 &lt;0.13.0'</b><br />dev_dependencies:<br />  unittest: any<br />transformers:<br />- angular:<br />    html_files:<br />      - web/partials/custom.html<br />- polymer:<br />    entry_points:<br />    - web/index.html<br />    - test/index.html</pre>The problem is that the next version of Polymer.dart might depend on <code>args</code> version 0.12, which is incompatible with Angular.dart <i>and</i> my overrides. So, for book testing purposes, I need to loosen those overrides even further:<pre class=prettyprint>name: angular_example<br />dependencies:<br />  angular: any<br />  polymer: any<br />  angular_node_bind: any<br /><b>dependency_overrides:<br />  args: any<br />  code_transformers: any<br />  html5lib: any</b><br /># ...</pre>A quick <code>pub upgrade</code> and... I am still using the same versions of these overridden dependencies:<pre class=prettyprint>Warning: You are using these overridden dependencies:<br />! args 0.12.0+2<br />! code_transformers 0.2.3+1<br />! html5lib 0.12.0</pre>Nothing has changed, but I am ready for any future changes to Angular.dart or Polymer.dart that have proven troublesome in the recent pass.<br /><br />With that, I am ready to write a double binding Angular.dart and Polymer.dart test. I already have <a href="http://japhr.blogspot.com/2014/03/polymer-page-objects-in-dart.html">testing page objects</a>, so this is mostly just re-organizing to pull in the Angular code. The test becomes:<pre class=prettyprint><code>    test('angular sees the updated pizza state', (){<br />      schedule(()=> xPizza.addWholeTopping('green peppers'));<br />      schedule((){<br />        var angular_el = document.query('pre');<br />        expect(<br />          angular_el.text,<br />          contains('Whole: [green peppers]')<br />        );<br />      });<br />    });</code></pre>I am using <a href="https://pub.dartlang.org/packages/angular_node_bind">angular_node_bind</a> to bind the current state of the pizza to an Angular scope variable inside a <code>&lt;pre></code> element. If I tell the page object to add green peppers to the whole pizza, the Polymer element should update itself with new values, which should trigger the Angular element to trigger itself to update.<br /><br />There may be a simpler way to accomplish this, but the dumbest way to add an Angular application in test mode is to add it right to the test HTML:<pre class=prettyprint>&lt;!DOCTYPE html><br /><b>&lt;html ng-app lang="en"></b><br />&lt;head><br />  &lt;!-- Load platforms polyfills --><br />  &lt;script src="packages/web_components/platform.js">&lt;/script><br /><br />  &lt;!-- Load component(s) --><br />  &lt;link rel="import" href="packages/angular_example/elements/x-pizza.html"><br /><br />  &lt;!-- The actual tests --><br />  &lt;script type="application/dart" src="test.dart">&lt;/script><br />  &lt;script src="packages/unittest/test_controller.js">&lt;/script><br />&lt;/head><br />&lt;body><br /><b>  &lt;ng-view>&lt;/ng-view></b><br />&lt;/body><br />&lt;/html></pre>Unfortunately, this means that I cannot pull the <code>main.dart</code> code that I have been using directly into my tests—both invoke <code>initPolymer()</code>. For now, I add a stripped-down version of the Angular app directly to my test's setup:<pre class=prettyprint><code>    setUp((){<br />      schedule(()=> Polymer.onReady);<br /><b>      schedule((){<br />        var app = new PizzaStoreApp()<br />          ..bind(NodeBindDirective)<br />          ..bind(RouteInitializerFn, toValue: storeRouteInitializer);<br /><br />        return applicationFactory()<br />          .addModule(app)<br />          .run();<br />      });</b><br />      schedule((){<br />        var _completer = new Completer();<br />        new Timer(new Duration(milliseconds: 50), ()=> _completer.complete());<br />        return _completer.future;<br />      });<br />      schedule((){<br />        _el = document.query('x-pizza') as PolymerElement;<br />        xPizza = new XPizzaComponent(_el);<br />        return xPizza.flush();<br />      });<br /><br />      currentSchedule.onComplete.schedule(() => _el.remove());<br />    });</code></pre>That is not <i>too</i> horrible, though it might be nice to move the Angular-specific code elsewhere—especially if it can be shared between the web application and test. The important line in there is the inclusion of <code>NodeBindDirective</code> (from angular_node_bind), which allows Angular to see updates to Polymer attributes. And indeed, if I remove that line, the test fails, but if I restore it, I find:<pre class=prettyprint>PASS: Angular sees the updated pizza state from the Polymer</pre>I should note that I also need to include a 50 millisecond delay before my test will pass. The Angular application needs this time to load its custom partials and spin up. It would be good if I could eliminate that seemingly arbitrary delay.<br /><br />But, for now, I am happy to have a useful test for Angular and Polymer playing nicely. This is a good stopping point.<br /><br /><br /><span style="color: #ccc">Day #198</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/09/cant-bind-polymerdart-with-angulardarts.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/09/why-am-i-getting-fouc-warning-in.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/Rr3Hx2P2n7Y" height="1" width="1"/>
