---
title: 'Making a Dart web app offline-capable: 3 lines of code'
layout: post
published: '2017-03-28T03:07:00-07:00'
feed: 'Dart News & Updates'
link: 'https://news.dartlang.org/2017/03/making-dart-web-app-offline-capable-3.html'
author:
    name: 'Filip Hráček'
    email: noreply@blogger.com
    url: 'http://www.blogger.com/profile/11956836702424010051'
tags:
    - angular

---

<em>Another article about Dart from Istvan Soos is about Progressive Web Apps, <a href="https://medium.com/@isoos/making-a-dart-web-app-offline-capable-3-lines-of-code-e980010a7815">published today</a>. — Filip Hracek</em><br /><br /><hr /><br />Have you ever tried to load a web application (maybe a game or a measurement converter) and couldn’t use it because the network was down? That’s an awful experience, but luckily we have the technology to make such apps available for our users.<br /><br />For most apps and games, this can be done with 3 lines of Dart code and 1 command in the terminal. In this short article I’ll guide you through the steps, and make sure that you can always play <a href="https://isoos.github.io/offline_pop_pop_win/">Pop, Pop, Win!</a><br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-3oCE0oYqFws/WNmvkUMO4SI/AAAAAAAAO0Y/wCAzrcHElWoSaxOTPL0V1R9u7eVEDpirwCPcB/s1600/1-GsjtYvVghuA63qhhRdyfPQ.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://4.bp.blogspot.com/-3oCE0oYqFws/WNmvkUMO4SI/AAAAAAAAO0Y/wCAzrcHElWoSaxOTPL0V1R9u7eVEDpirwCPcB/s640/1-GsjtYvVghuA63qhhRdyfPQ.png" width="640" height="530" /></a></div><div style="font-style: italic; padding: 0 4em; text-align: center;"><a href="https://dart-lang.github.io/sample-pop_pop_win/">Pop, Pop, Win!</a> (<a href="https://github.com/dart-lang/sample-pop_pop_win">code</a>) — a Minesweeper implementation in Dart.</div><br /><h3>Service workers</h3>A service worker is a JavaScript file that runs in the background. It can control the web page or the site it is associated with, intercepting and modifying navigation and resource requests, and caching resources in a very granular fashion.<br /><br />It is a non-intrusive web technology: service workers can improve the user experience if the browser <a href="http://caniuse.com/#feat=serviceworkers">supports them</a>, but the site can operate just fine in their absence (with the default web behavior). This is a useful property that enables <strong>progressive web applications (PWA)</strong>, where you can provide more advanced features to the majority of the users, while making sure that the rest aren’t locked out.<br /><br />As a background processing thread, a service worker can help with:<br /><ul><li>offline mode (fetching resources from cache while the network is down)</li><li>caching strategies (for near-instant cached responses that can be updated later with fresh content)</li><li>push notifications (like in a mobile app)</li><li>messaging (if the application is open on multiple tabs)</li></ul>The important feature for our offline gaming experience is this: we would like to play Pop, Pop, Win!, and not meet this dinosaur:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-_iQRk9e_9l8/WNmw-2dx2tI/AAAAAAAAO0k/HokNfqE90qk4BahNiv7ISERQzILJ7ouqACPcB/s1600/1-cufcmiyxW8k4ku1-Y_zsvg.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://4.bp.blogspot.com/-_iQRk9e_9l8/WNmw-2dx2tI/AAAAAAAAO0k/HokNfqE90qk4BahNiv7ISERQzILJ7ouqACPcB/s640/1-cufcmiyxW8k4ku1-Y_zsvg.png" width="640" height="258" /></a></div><div style="font-style: italic; padding: 0 4em; text-align: center;">Fun fact: you can play with that dinosaur by pushing the up arrow key.</div><br /><h3>Progressive web app with Dart</h3>Supporting offline mode requires roughly the following:<br /><ol><li>Determining which resources to put in the cache for offline use.</li><li>Creating a service worker that prepares a cache of these resources.</li><li>Registering the service worker, so that subsequent requests can be served from the offline cache (in case the network is down).</li><li>In that service worker, pre-populating the offline cache with the URLs, and also handling the appropriate fetch request either from the cache, or from the network.</li><li>Making sure that the service worker detects changes to the app or static assets, and puts the new version in the cache.</li></ol>While the above list may sound a bit scary, we have a <a href="https://pub.dartlang.org/packages/pwa">pwa</a> package in Dart that does most of the work for us, providing a high-level API and automating most of the work.<br /><br /><h4>Changes in your application</h4>Import the <code>pwa</code> package in your <code>pubspec.yaml</code>:<br /><pre><code>dependencies:<br />  pwa: ^0.1.2</code></pre>After running <code>pub get</code>, add the client to your <code>web/main.dart</code>:<br /><pre><code>import ‘package:pwa/client.dart’ as pwa;<br />main() {<br />  // register PWA ServiceWorker for offline caching.<br />  new pwa.Client();<br />}</code></pre>The above code handles item 3 from the above list by registering the service worker (which we will create in the following step). Right now we don’t use the Client instance for anything else, but as the <code>pwa</code> package gets new features, it may become useful for other purposes.<br /><br /><h4>Automatically generated progressive web application</h4>The <code>pwa</code> package provides code generation that handles items 1–2 and 4–5 from the above list. To ensure proper cache use (both populating and invalidating the cache) use the following workflow:<br /><ol><li>Build your web app with all of the static resources landing in <code>build/web</code>: <code>pub build</code></li><li>Run <code>pwa</code>’s code generator to scan (or rescan) your offline assets: <code>pub run pwa</code></li><li>Build your project again, because you need to have your (new) <code>pwa.dart</code> file compiled: <code>pub build</code></li></ol>These steps produce a file named <code>lib/pwa/offline_urls.g.dart</code> that contains a list of the offline URLs to be cached. The <code>.g.dart</code> extension indicates that the file is generated and may be overwritten automatically by <code>pwa</code>’s code generator tool.<br /><br />On the first run, this workflow generates the <code>web/pwa.dart</code> file that contains your service worker with reasonable defaults. You can modify this file (to customize the offline URLs or use the high-level APIs, for example) because the code generator won’t change or override it again.<br /><br /><h3>Caveats</h3>While Dartium is great for most web development, at the moment it’s hard to use with service workers. We recommend using Chrome or Firefox instead.<br /><br />Cache invalidation is one of the hardest problems in computer science. The underlying <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">Web Cache API</a> provides some guarantees, and the <code>pwa</code> library goes to a great length to gracefully handle the edge cases, but don’t treat the cache as reliable storage for anything really important. Make use of the cache when it is available, and fail gracefully when it’s not.<br /><br /><h3>Caveats</h3>You can now deploy the new version of your application. Or try the <a href="https://isoos.github.io/offline_pop_pop_win/">offline Pop, Pop, Win! game</a>.<br /><br />After opening the game and playing one round, shut down your wi-fi or unplug the network cable, and then reload (or retype the URL). If you’re using Chrome or Firefox, your game should be up and running. Good luck, have fun!<br /><br />— István Soós, March 28, 2017, <a href="https://medium.com/@isoos/making-a-dart-web-app-offline-capable-3-lines-of-code-e980010a7815">canonical link</a>
