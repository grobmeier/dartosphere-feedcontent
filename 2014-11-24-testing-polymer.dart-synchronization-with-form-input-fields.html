---
title: 'Testing Polymer.dart Synchronization with Form Input Fields'
layout: post
published: '2014-11-24T23:59:00-05:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/-ql9VLopSQw/testing-polymerdart-synchronization.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />Surprisingly, none of my <a href="http://dartlang.org">Dart</a> tests are failing. Or have failed. It's not that I expect Dart tests to fail with any regularity—far from it. It is just that the tests for the JavaScript version of <a href="http://patternsinpolymer.com/">Patterns in Polymer</a> seem to fail every other week or so. <br /><br />It probably helps that <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> has remained at 0.15 for a while now. I could also use some better tests. And since I went to all that trouble last night to write a test describing the JavaScript code from the chapter on synchronizing the plain-old form <code>&lt;input></code> value with Polymer, it seems only fair that I write the same thing for Dart.<br /><br />The JavaScript test wound up looking like:<pre class=prettyprint><code>  describe('syncing &lt;input> values', function(){<br />    var input;<br /><br />    beforeEach(function(done){<br />      input = document.createElement('input');<br />      container.appendChild(input);<br /><br /><b>      syncInputFromAttr(input, el, 'state');</b><br /><br />      el.model.firstHalfToppings.push('pepperoni');<br />      el.async(done);<br />    });<br /><br />    it('updates the input', function(){<br />      expect(input.value).toEqual('pepperoni');<br />    });<br />  });</code></pre>Cerate an <code>&lt;input></code>, sync it with the <code>&lt;x-pizza></code> Polymer element, add a pepperoni to the Polymer element and expect that the <code>&lt;input></code> now contains pepperoni as well.<br /><br />As with last night's JavaScript solution, I am using <code>MutationObserver</code> objects to synchronize my elements in Dart:<pre class=prettyprint>syncInputFromAttr(input, el, attr) {<br />   var observer = new MutationObserver((changes, _) {<br />    changes.forEach((change) {<br />      if (change.attributeName == attr) {<br />        input.value = change.target.attributes[change.attributeName];<br />      }<br />    });<br />  });<br />  observer.observe(el, attributes: true);<br />}</pre>This creates an observer with the supplied callback that is invoked when changes are seen. It then observes the supplied <code>el</code>, which is my <code>&lt;x-pizza></code> Polymer element in this case. Not a particularly Darty looking thing, but the callback updates the input when the desired changes are seen. <br /><br />It works in my smoke tests, but I still need a repeatable unit test. Well, maybe not <i>need</i>, but if this approach failed in JavaScript, then it can also fail in Dart at some point. So it would be good to have such a test.<br /><br />The test setup is the same as with the JavaScript test—create an <code>&lt;input></code> which is added to the container from previous setup. Then synchronize the Polymer and input elements. Lastly, add pepperoni as the first half topping:<pre class=prettyprint><code>  group('syncing &lt;input> values', (){<br />    var input;<br /><br /><b>    setUp((){<br />      input = createElement('&lt;input>');<br />      _container.append(input);<br /><br />      syncInputFromAttr(input, _el, 'state');<br /><br />      _el.model.firstHalfToppings.add('pepperoni');<br />    });</b><br /><br />    test('updates the input', (){<br />      // Test will go here...<br />    });<br />  });</code></pre>The test then needs to check that the input value is now set to indicate that the first half of the pizza includes pepperoni like the Polymer element:<pre class=prettyprint><code>  group('syncing &lt;input> values', (){<br />    var input;<br /><br />    setUp((){ /* ... /* });<br /><br /><b>    test('updates the input', (){<br />      expect(<br />        input.value,<br />        startsWith('First Half: [pepperoni]')<br />      );<br />    });</b><br />  });</code></pre>Except that does not work:<pre class=prettyprint>FAIL: &lt;x-pizza> syncing &lt;input> values updates the input<br />  Expected: a string starting with 'First Half: [pepperoni]'<br />    Actual: ''</pre>Fortunately, I have gotten to the point in my Polymer testing (JavaScript and Dart) at which I know that I need to wait for Polymer to update all internal and external values before testing. Furthermore, I know that I can supply a callback to Polymer's <code>async()</code> method such that Polymer will invoke this callback when it has updated bound variables and observables alike.<br /><br />To adapt this into vanilla Dart unittest, I need to wrap the whole thing in an <code>expectAsync()</code> call:<pre class=prettyprint>group('syncing &lt;input> values', (){<br />    var input;<br /><br />    setUp((){ /* ... /* });<br /><br /><b>    test('updates the input', (){<br />      _el.async(expectAsync((_){<br />        expect(<br />          input.value,<br />          startsWith('First Half: [pepperoni]')<br />        );<br />      }));<br />    });</b><br />  });</code></pre>And that actually works. I now have my very basic test working and a test of the actual functionality from this chapter both passing:<pre class=prettyprint>PASS: &lt;x-pizza> has a shadowRoot<br />PASS: &lt;x-pizza> syncing &lt;input> values updates the input<br />All 2 tests passed.</pre>I must admit that I begin to dislike the callback love in Polymer.dart. Both the <code>MutationObserver</code> and the <code>async()</code> methods require callbacks, making this feel very much like JavaScript code. I can only hope that this changes at some point so that I can use a Future or two. In the meantime, I will likely convert this test into a scheduled_test test. I may have to build my own Completer to make it work, but the end result ought to be a bit easier on the eye.<br /><br /><br /><br /><span style="color: #ccc">Day #4</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/11/replacing-mutationobserver-with.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/-ql9VLopSQw" height="1" width="1"/>
