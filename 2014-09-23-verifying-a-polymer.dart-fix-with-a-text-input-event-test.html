---
title: 'Verifying a Polymer.dart Fix with a Text Input Event Test?!'
layout: post
published: '2014-09-23T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/4n3U22MGVE4/verifying-polymerdart-fix-with-text.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - polymer
    - testing

---

<div class=top-chain-links></div><br />I thought I had the internationalization project code for <a href="http://patternsinpolymer.com/">Patterns in Polymer</a> 100% solid. It turns out that I missed one thing: the bound variable in a pluralization is not updating properly.<br /><br />After last night, I have <code>&lt;hello-you></code> element localization into English, Spanish, and French working just fine. I can start the element localized or change it on the fly. All except the number of red balloons the user currently happens to own:<br /><br /><a href="http://3.bp.blogspot.com/-V_xrjD1ftBo/VCIuwgcCcLI/AAAAAAAAfg4/961VwCwmSlU/s1600/01-not_99_but_one_balloon.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-V_xrjD1ftBo/VCIuwgcCcLI/AAAAAAAAfg4/961VwCwmSlU/s400/01-not_99_but_one_balloon.png" /></a><br /><br />As I found last night, this is not completely broken. Only the bound variable in the pluralization fails to update. If I switch the locale to Spanish, the message then displays correctly:<br /><br /><a href="http://2.bp.blogspot.com/-1Dz-YNjB4WY/VCIuwhlz0MI/AAAAAAAAfg0/jVth0Vl9mDE/s1600/02-99_spanish_balloons.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-1Dz-YNjB4WY/VCIuwhlz0MI/AAAAAAAAfg0/jVth0Vl9mDE/s400/02-99_spanish_balloons.png" /></a><br /><br />So what have I done?<br /><br />The answer turns out to be “not much.” In fact, the answer is that I did nothing—the underlying <a href="http://www.polymer-project.org/">Polymer</a> library (and by extension the <a href="https://www.dartlang.org/polymer-dart/">Polymer.dart</a> library) changed when I was not looking. And, since I lack a test for this particular bit of functionality, it went completely unnoticed.<br /><br />The actual problem is simple enough. The <code>&lt;x-translate></code> element is not listening for changes to the labels (including the count):<pre class=prettyprint>@CustomTag('x-translate')<br />class XTranslate extends PolymerElement {<br />  XTranslate.created(): super.created();<br />  // ...<br />  enteredView() {<br />    super.enteredView();<br /><b>    labels.changes.listen((_)=> update());</b><br />  }<br />  // ...<br />}</pre>It looks very much like it should be listening, but this listener is never established because <code>enteredView()</code> is never called. The <code>enteredView()</code> method used to be a callback method, but has since been replaced with <code>attached()</code>, making the fix trivial:<pre class=prettyprint>@CustomTag('x-translate')<br />class XTranslate extends PolymerElement {<br />  XTranslate.created(): super.created();<br />  // ...<br /><b>  attached() {<br />    super.attached();</b><br />    labels.changes.listen((_)=> update());<br />  }<br />  // ...<br />}</pre>With that, I have everything working again:<br /><br /><a href="http://2.bp.blogspot.com/--J2ARFbG_Qc/VCI2-SkhgQI/AAAAAAAAfhI/eg5ampoaeNE/s1600/03-jai_99_ballons_rouges.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/--J2ARFbG_Qc/VCI2-SkhgQI/AAAAAAAAfhI/eg5ampoaeNE/s400/03-jai_99_ballons_rouges.png" /></a><br /><br />It works now, but I am only setting myself up for future failure. If the library changed once, it is likely to change again (the library is still in alpha release, after all). The only way to prevent this from breaking again without my knowledge is to write a test. But how?<br /><br />Ideally I would want a test like the following (<a href="https://pub.dartlang.org/packages/scheduled_test">scheduled_test</a> schedules are there to ensure serial execution):<pre class=prettyprint><code>    test('localizes the number of balloons', (){<br />      schedule((){<br />        _el.$['count'].value = '99';<br />      });<br />      schedule((){<br />        expect(_el.shadowRoot.text, contains("J'ai 99 ballons rouges."));<br />      });<br />    });</code></pre>But that does work. Polymer does recognize the updated value as a reason to change its attributes. And I know that sending input events <a href="http://japhr.blogspot.com/2014/03/input-testing-of-polymers-dart.html">does not work</a>.<br /><br />Bleh. I may as well try some of those. Who knows? Maybe the Dart / Polymer folks fixed this....<br /><br /><b>Holy Cow!</b> They fixed it! <br /><br />If I send a Text Input event to the element:<pre class=prettyprint><code>    test('localizes the number of balloons', (){<br />      schedule((){<br /><b>        var evt = new TextEvent('textInput', data: '99');<br />        _el.$['count'].<br />          dispatchEvent(evt);</b><br />      });<br />      schedule((){<br />        expect(_el.shadowRoot.text, contains("J'ai 99 ballons rouges."));<br />      });<br />    });</code></pre>Then my test now passes:<pre class=prettyprint>PASS: &lt;hello-you/> (i18n) defaults to English<br />PASS: &lt;hello-you/> (i18n) can localize to French<br />PASS: &lt;hello-you/> (i18n) can localize to Spanish<br />PASS: &lt;hello-you locale="fr"/> (French) starts in French<br /><b>PASS: &lt;hello-you locale="fr"/> (French) localizes the number of balloons</b><br />PASS: &lt;hello-you locale="es"/> (Spanish) starts in Spanish</pre>I am so darn excited about this. I wonder if this means that all text input event generation works now? That would be amazing (it has long been my go-to answer to name something I don't like about Dart). But, for now, I am thrilled to have this particular element well tested for the future.<br /><br /><br /><span style="color: #ccc">Day #192</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/09/tdd-fix-for-broken-i18n-in-polymerdart.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <a href="http://japhr.blogspot.com/2014/09/verifying-polymerdart-fix-with-text.html">next&rsaquo;</a> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/4n3U22MGVE4" height="1" width="1"/>
