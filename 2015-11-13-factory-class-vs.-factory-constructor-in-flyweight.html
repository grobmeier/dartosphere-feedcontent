---
title: 'Factory Class vs. Factory Constructor in Flyweight'
layout: post
published: '2015-11-13T23:21:00-08:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/tchYrUql56c/factory-class-vs-factory-constructor-in.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - flyweight.

---

<div class=top-chain-links></div><br />Unneeded patterns excite me at least as much as the tried-and-true ones. As I mentioned in the <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">kickoff post</a> for this latest chain, I am eager to explore a modern take on <a href="http://designpatternsindart.com/">Design Patterns</a> through the lovely lens of <a href="http://dartlang.org">Dart</a>. <br /><br />I was reasonably happy with last night's implementation of the <a href="https://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight pattern</a>. As pointed out to me by the esteemed <a href="https://www.google.com/+MatthewButler">Matthew Butler</a>, I might be missing some Dart goodness that could clean up my code. <a href="https://www.google.com/+DonOlmstead">Don Olmstead</a> also reported “quite a few style nits looking through your code,” but I'm pretty sure that guy's just crazy (I kid! I'm using <a href="https://github.com/dart-lang/dart_style">dartfmt</a> from now on).<br /><br />At any rate, Matthew's most interesting suggestion was to convert last night's <code>LampFactory</code> class into a factory constructor. I think he has a valid point. The factory class was responsible for caching the flyweight:<pre class=prettyprint>// dartfmt'd -- happy Don? :P<br />class LampFactory {<br />  var cache = {};<br />  Lamp findLamp(color) {<br />    return cache.putIfAbsent(color, () => new Lamp(color));<br />  }<br /><br />  int get totalCount => cache.length;<br />}</pre>The flyweight class in this simple example described a lamp of varying color:<pre class=prettyprint>class Lamp {<br />  String color;<br />  Lamp(this.color);<br />}</pre>Per Matthew's suggestion, I can eliminate the factory class in favor of the Dart <code>factory</code> constructor:<pre class=prettyprint>class Lamp {<br />  String color;<br />  static Map _cache = {};<br /><br />  factory Lamp(color) =><br />    _cache.putIfAbsent(color, () => new Lamp._(color));<br /><br />  Lamp._(this.color);<br /><br />  static int get totalCount => _cache.length;<br />}</pre>That saves a few lines of code (mostly the class declaration for the factory), but I dunno. The <code>Lamp</code> class seems muddled now that it does two, distinct things. Maybe it is better with the caching code and the “intrinsic lampness” of the flyweight separated:<pre class=prettyprint>class Lamp {<br />  static Map _cache = {};<br />  static int get totalCount => _cache.length;<br /><br />  factory Lamp(color) =><br />    _cache.putIfAbsent(color, () => new Lamp._(color));<br /><br />  String color;<br />  Lamp._(this.color);<br />}</pre>Were I writing this in real life, I would likely leave it as is. And it does retain the spirit of the flyweight pattern—reducing the number of objects with the same intrinsic properties.. In the spirit of "patterns" however, I remain unsure. <br /><br />What I do know is that this approach significantly improves the <code>Tree</code> context class. Instead of a bunch of references to factory-this, factory-that:<pre class=prettyprint>class Tree {<br />  int count = 0;<br />  var _lampFactory;<br /><br />  Tree() {<br />    _lampFactory = new LampFactory();<br />  }<br /><br />  void hangLamp(color, branchNumber) {<br />    new TreeBranch(branchNumber)<br />      ..hang(_lampFactory.findLamp(color));<br /><br />    count++;<br />  }<br /><br />  String get report => "Added ${count} lamps.\n"<br />      "Used ${_lampFactory.totalCount} kinds of lamps.";<br />}</pre>The <code>Tree</code> now looks exactly like it would if the flyweight pattern were not in play:<pre class=prettyprint>class Tree {<br />  int count = 0;<br /><br />  void hangLamp(color, branchNumber) {<br />    new TreeBranch(branchNumber)<br />      ..hang(new Lamp(color));<br /><br />    count++;<br />  }<br /><br />  String get report => "Added ${count} lamps.\n"<br />      "Used ${Lamp.totalCount} kinds of lamps.";<br />}</pre>That cleanliness seems very much worth a little muddiness in the flyweight class.<br /><br />In fact, I can use the same approach to convert the <code>TreeBranch</code> class into a flyweight as well—without making a change to the <code>Tree</code> context class:<pre class=prettyprint>class TreeBranch {<br /><b>  static Map _cache = {};<br />  static int get totalCount => _cache.length;<br /><br />  factory TreeBranch(number) =><br />    _cache.putIfAbsent(number, () => new TreeBranch._(number));</b><br /><br />  int number;<br />  TreeBranch._(this.number);<br />  // ...<br />}</pre>Were I to stick with the factory class approach, I would have to introduce more factory objects into the calling context that already seemed lousy with them.<br /><br />So my preliminary conclusion is that yes, factory constructors do seem of value with the Flyweight pattern in Dart. The ability to implement in-place without changing the context is nice, but I most appreciate the cleanliness of the resulting context code. I have the benefits of the flyweight pattern without the ugliness of factory instance variables polluting things.<br /><br /><br /><span style="color: #ccc">Day #2</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2015/11/flyweight-in-dart.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2015/11/design-patterns-in-dart.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/tchYrUql56c" height="1" width="1" alt=""/>
