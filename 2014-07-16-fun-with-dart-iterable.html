---
title: 'Fun with Dart Iterable'
layout: post
published: '2014-07-16T23:59:00-04:00'
feed: 'japh(r) by Chris Strom'
link: 'http://feedproxy.google.com/~r/JaphrByChrisStrom/~3/Bvcti_OhpYM/fun-with-dart-iterable.html'
author:
    name: 'Chris Strom'
    email: noreply@blogger.com
    url: 'https://plus.google.com/117928918793969810642'
tags:
    - benchmarking
    - chain
    - dart
    - dartlang
    - 'design patterns'
    - 'visitor pattern'

---

<div class=top-chain-links></div><br />I am going to take a brief break from my <a href="http://en.wikipedia.org/wiki/Visitor_pattern">Visitor Pattern</a> benchmarks for <a href="http://designpatternsindart.com/">Design Patterns in Dart</a>, but not really. Instead of working with the actual numbers, I want to write a simple <a href="http://dartlang.org">Dart</a> script that reads a CSV file of runs totals so that they can be grouped and transposed.<br /><br />In other words, I want to have a little Iterable fun.<br /><br />After 5 runs of my Visitor Pattern implementation benchmarks, I have 15 rows of results. There are three implementations being benchmarked. For each of the three implementations, I try executing them inside loops of sizes increasing by a power of ten from 10 to 100,000. The results look like:<pre class=prettyprint>Classic Visitor Pattern, 1224, 10, 122.4<br />Nodes iterate w/ single dispatch, 1106, 10, 110.6<br />Visitor Traverses, 1175, 10, 117.5<br />Classic Visitor Pattern, 1.185e+4, 100, 118.5<br />Nodes iterate w/ single dispatch, 1.124e+4, 100, 112.4<br />Visitor Traverses, 1.176e+4, 100, 117.6<br />Classic Visitor Pattern, 1.204e+5, 1000, 120.4<br />Nodes iterate w/ single dispatch, 1.124e+5, 1000, 112.4<br />Visitor Traverses, 1.168e+5, 1000, 116.8<br />Classic Visitor Pattern, 1.486e+6, 10000, 148.6<br />Nodes iterate w/ single dispatch, 1.482e+6, 10000, 148.2<br />Visitor Traverses, 1.179e+6, 10000, 117.9<br />Classic Visitor Pattern, 1.481e+7, 100000, 148.1<br />Nodes iterate w/ single dispatch, 1.487e+7, 100000, 148.7<br />Visitor Traverses, 1.185e+7, 100000, 118.5</pre>To make pretty graphs from those numbers, I would like to group the results by loop size (the 3rd column in the CSV) and include the results of each implementation (Classic, Single Dispatch, Visitor Traverses). So it ought to look like:<pre class=prettyprint>10,     122.4, 110.6, 117.5<br />100,    118.5, 112.4, 117.6<br />1000,   120.4, 112.4, 116.8<br />10000,  148.6, 148.2, 117.9<br />100000, 148.1, 148.7, 118.5</pre>I create the script and make it executable:<pre class=prettyprint>$ touch tool/group_totals.dart <br />$ chmod 755 tool/group_totals.dart</pre>I read the totals with a little synchronous help (I just prefer synchronous reads for small stuff) from dart:io:<pre class=prettyprint>_readTotals() {<br />  var file = new File('totals.csv');<br />  var lines = file.readAsLinesSync();<br /><br />  return lines.map((line){<br />    var fields = line.split(', ');<br />    return {<br />      'name': fields[0],<br />      'score': fields[1],<br />      'loopSize': fields[2],<br />      'averageScore': fields[3]<br />    };<br />  }).toList();<br />}</pre>I have to <code>toList()</code> on the result of the <code>map()</code>â€”otherwise I would return an Iterable.<br /><br />The problem at this point is that Dart lacks a <code>groupBy()</code> method on Lists and Iterables. There seems to be a groupBy package available, but I am curious how I might implement this on my own. And the best that I can come up with is to find all values for <code>loopSize</code> and convert them to a Set (to eliminate duplicates):<pre class=prettyprint>main() {<br />  List&lt;Map> totals = _readTotals();<br />  var loopSizes = totals.map((r)=> r['loopSize']).toSet();<br /><br />  loopSizes.forEach((loopSize) {<br />    // Print results for each loop size<br />  }<br />}<br /></pre>That is already kind of ugly, but lacking better ideas, I forge ahead. I find all records where the loop size is the same as the current value:<pre class=prettyprint><code>  loopSizes.forEach((loopSize) {<br />    var records = totals.where((r)=> r['loopSize'] == loopSize);<br />    // ...<br />  }</code></pre>From that list of records, I then extract the individual records that I seek (Classic Visitor Pattern, Single Dispatch Optimized, and Visitor Traverses the Node Structure):<pre class=prettyprint><code>  loopSizes.forEach((loopSize) {<br />    var records = totals.where((r)=> r['loopSize'] == loopSize);<br /><br /><b>    var classic = records.firstWhere((r)=> r['name'].contains('Classic'));<br />    var single = records.firstWhere((r)=> r['name'].contains('single'));<br />    var vTraverses = records.firstWhere((r)=> r['name'].contains('Traverses'));</b><br /><br />    print(<br />      '${loopSize}, '<br />      '${classic["averageScore"]}, '<br />      '${single["averageScore"]}, '<br />      '${vTraverses["averageScore"]}'<br />    );<br />  });</code></pre>And then I print the results (adjacent strings in Dart are concatenated). The prettiness of the code has not improved much, but it works:<pre class=prettyprint>$ ./tool/group_totals.dart<br />10, 122.4, 110.6, 117.5<br />100, 118.5, 112.4, 117.6<br />1000, 120.4, 112.4, 116.8<br />10000, 148.6, 148.2, 117.9<br />100000, 148.1, 148.7, 118.5<br /></pre>And, pasted into a spreadsheet, it is easy to obtain pretty graphs:<br /><br /><a href="http://3.bp.blogspot.com/-GVeCJisq2cA/U8dRyOUnQPI/AAAAAAAAdO0/Fu1Re-JHyX0/s1600/image+(3).png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-GVeCJisq2cA/U8dRyOUnQPI/AAAAAAAAdO0/Fu1Re-JHyX0/s640/image+(3).png" /></a><br /><br />Still, iterables in Dart would be a lot more fun with <a href="https://code.google.com/p/dart/issues/detail?id=11159">a group-by method</a>.<br /><br /><br /><span style="color: #ccc">Day #124</span>  <br /><br /><p class=bottom-chain-links><a href="http://japhr.blogspot.com/2014/07/constant-constructors-and-benchmark.html">&lsaquo;prev</a> | <a href="http://japhr.blogspot.com/2013/11/new-chain-patterns-in-polymer.html">My Chain</a> | <span style="color: #ccc">next&rsaquo;</span> </p><script>var b_links = document.getElementsByClassName('bottom-chain-links'),      t_links = document.getElementsByClassName('top-chain-links');  if (b_links.length == 1 && t_links.length == 1) {   t_links[0].innerHTML = b_links[0].innerHTML; } </script><img src="http://feeds.feedburner.com/~r/JaphrByChrisStrom/~4/Bvcti_OhpYM" height="1" width="1"/>
